# Story 1.1: Stripe OAuth Connection Flow

**Epic**: Epic 1 - Stripe Integration & Detection API  
**Story Points**: 5  
**Status**: ✅ Ready for Review

---

## Story

**As a** merchant,  
**I want** to connect my Stripe account via OAuth with one click,  
**so that** Orylo can access my payment data securely without manual API key management.

---

## Acceptance Criteria

1. **AC1**: OAuth button "Connect Stripe" (Stripe Express pattern)
2. **AC2**: Redirect to Stripe OAuth consent screen, scope: read-only payments
3. **AC3**: Callback handler stores `stripe_account_id` in `organizations` table
4. **AC4**: Success message: "Stripe connected successfully"
5. **AC5**: Error handling: Invalid token → Retry flow, user-friendly error message
6. **AC6**: Multi-tenancy: Each org isolated, no cross-org data leakage
7. **AC7**: Session security: Better Auth session validated before OAuth redirect
8. **AC8**: E2E test: Mock OAuth flow, verify DB record created

---

## Tasks / Subtasks

- [x] **Task 1**: Create OAuth initiation endpoint (AC1, AC2)
  - [x] Create `GET /api/stripe/connect` route
  - [x] Generate Stripe OAuth URL with client_id, redirect_uri, scope
  - [x] Validate Better Auth session before redirect (AC7)
  - [x] Store state parameter in session for CSRF protection
  - [x] Redirect to Stripe consent screen

- [x] **Task 2**: Implement OAuth callback handler (AC3, AC5)
  - [x] Create `GET /api/stripe/callback` route
  - [x] Verify state parameter matches session
  - [x] Exchange authorization code for access token (Stripe API)
  - [x] Extract `stripe_account_id` from response
  - [x] Store in `organizations.stripeAccountId` (AC3)
  - [x] Handle errors: invalid token, expired code, network failures (AC5)

- [x] **Task 3**: UI components (AC1, AC4)
  - [x] Create "Connect Stripe" button component (Shadcn Button)
  - [x] Display loading state during OAuth flow
  - [x] Show success toast after connection (AC4)
  - [x] Show error toast if connection fails (AC5)

- [x] **Task 4**: Database schema update (AC3, AC6)
  - [x] Add `stripeAccountId` column to `organizations` table (Drizzle migration)
  - [x] Add unique constraint on `stripeAccountId`
  - [x] Add index for faster lookups

- [x] **Task 5**: Multi-tenancy validation (AC6)
  - [x] Verify organizationId from Better Auth session
  - [x] Ensure stripe_account_id saved to correct org only
  - [x] Add integration test: User A cannot access User B's Stripe account

- [x] **Task 6**: E2E test (AC8)
  - [x] Create Playwright test: Click "Connect Stripe" → Mock OAuth flow → Verify DB
  - [x] Test error scenarios: Invalid token, network failure

---

## Dev Notes

### Relevant Architecture

**Better Auth Organizations** (ADR-010):
- User session contains `organizationId`
- Access `session.user.activeOrganizationId` in API routes
- Ensure all DB queries filtered by organizationId

**Database Schema** (`@orylo/database`):
```typescript
// packages/database/src/schema/organizations.ts
export const organizations = pgTable('organizations', {
  id: text('id').primaryKey(), // Better Auth Organizations ID
  stripeAccountId: text('stripe_account_id').unique(), // NEW column
  createdAt: timestamp('created_at').defaultNow(),
  // ...
});
```

**Stripe OAuth Docs**:
- URL: `https://connect.stripe.com/oauth/authorize`
- Params: `client_id`, `redirect_uri`, `scope=read_only`, `state` (CSRF)
- Callback exchange code: `POST https://connect.stripe.com/oauth/token`

### Environment Variables Required

```env
STRIPE_CLIENT_ID=ca_xxx
STRIPE_SECRET_KEY=sk_test_xxx
NEXT_PUBLIC_BASE_URL=http://localhost:3000
```

### Stripe Express OAuth Pattern

Use Stripe's recommended OAuth flow (not manual API keys):
- Scope: `read_only` (no write access to merchant account)
- Redirect URI: `${NEXT_PUBLIC_BASE_URL}/api/stripe/callback`
- State parameter: Random string stored in session (CSRF protection)

### Error Handling

**Possible Errors**:
- `invalid_grant`: Authorization code expired/invalid
- `invalid_client`: Wrong client_id or secret
- Network errors: Stripe API unreachable

**User-Friendly Messages**:
- "Failed to connect Stripe. Please try again."
- "Connection expired. Please restart the process."
- "Network error. Check your internet connection."

### Source Tree Context

```
apps/web/
├── app/
│   ├── api/
│   │   └── stripe/
│   │       ├── connect/
│   │       │   └── route.ts       # OAuth initiation
│   │       └── callback/
│   │           └── route.ts       # OAuth callback
│   └── dashboard/
│       └── page.tsx               # Contains "Connect Stripe" button
└── lib/
    └── auth.ts                    # Better Auth instance
```

---

## Testing

### Unit Tests
- **File**: `apps/web/app/api/stripe/connect/route.test.ts`
- **Tests**:
  - Generates valid OAuth URL with correct params
  - Rejects unauthenticated requests (no session)
  - Stores state parameter in session

- **File**: `apps/web/app/api/stripe/callback/route.test.ts`
- **Tests**:
  - Validates state parameter (CSRF protection)
  - Exchanges code for access token successfully
  - Stores stripeAccountId in database
  - Handles errors (invalid_grant, network failure)

### Integration Tests
- **File**: `apps/web/app/api/stripe/__tests__/oauth-flow.integration.test.ts`
- **Test**: Complete OAuth flow with test database
  - Mock Stripe API responses
  - Verify DB record created with correct organizationId

### E2E Tests
- **File**: `e2e/stripe-oauth.spec.ts` (Playwright)
- **Test**: User clicks "Connect Stripe" → Redirected → DB updated
  - Use Stripe test mode OAuth (mock consent screen)

### Testing Standards
- Framework: Vitest (unit), Playwright (E2E)
- Coverage target: ≥80% for OAuth logic
- Mock Stripe API calls (use `nock` or `msw`)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-13 | 1.0 | Story created | Sarah (PO) |
| 2026-01-13 | 1.1 | Implementation completed - All tasks & tests done | James (Dev) |

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (James - Full Stack Developer)

### Debug Log References
No debug logs required - implementation proceeded smoothly

### Completion Notes
**All tasks completed successfully! ✅**

- **OAuth Flow**: Implemented with CSRF protection using state parameter stored in httpOnly cookie
- **Multi-tenancy**: Enforced through Better Auth session organizationId in all DB operations
- **Database**: Migration created for stripeAccountId with unique constraint and lookup index
- **UI/UX**: Sonner toast system for success/error messages with user-friendly error text
- **Security**: Session validation before OAuth redirect, CSRF state verification
- **Testing**: Complete test coverage with unit, integration, and E2E tests

**Acceptance Criteria Status:**
- ✅ AC1: "Connect Stripe" button with Stripe Express pattern
- ✅ AC2: Redirect to Stripe OAuth with read_only scope
- ✅ AC3: stripe_account_id stored in organizations table
- ✅ AC4: Success message "Stripe connected successfully"
- ✅ AC5: Error handling with user-friendly messages
- ✅ AC6: Multi-tenancy isolation enforced
- ✅ AC7: Better Auth session validated before OAuth
- ✅ AC8: E2E tests implemented with Playwright

**Ready for Code Review & QA Testing**

### File List
**Created:**
- `apps/web/app/api/stripe/connect/route.ts` - OAuth initiation endpoint with CSRF protection
- `apps/web/app/api/stripe/callback/route.ts` - OAuth callback handler with multi-tenancy
- `apps/web/lib/db.ts` - Database connection helper (Drizzle + Neon)
- `apps/web/components/stripe-connect-button.tsx` - Connect Stripe button with loading state
- `apps/web/app/dashboard/page.tsx` - Dashboard with OAuth callback toast handling
- `apps/web/components/providers.tsx` - Theme provider for Sonner
- `packages/database/drizzle/0001_add_stripe_account_id.sql` - DB migration
- `apps/web/app/api/stripe/connect/route.test.ts` - Unit tests for OAuth initiation
- `apps/web/app/api/stripe/callback/route.test.ts` - Unit tests for OAuth callback
- `apps/web/app/api/stripe/__tests__/oauth-flow.integration.test.ts` - Integration tests for multi-tenancy
- `e2e/stripe-oauth.spec.ts` - E2E tests with Playwright

**Modified:**
- `apps/web/app/layout.tsx` - Added Toaster and Providers

---

## QA Results

(To be populated by QA agent after testing)
