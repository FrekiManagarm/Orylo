# Story 2.4: Detection Details Dialog

**Epic**: Epic 2 - Dashboard Action-First Experience  
**Story Points**: 5  
**Status**: Ready for Review

---

## Story

**As a** merchant,  
**I want** to view full detection details in a modal,  
**so that** I can understand why a transaction was flagged.

---

## Acceptance Criteria

1. **AC1**: Trigger: Click detection card anywhere (not CTA button)
2. **AC2**: Component: Shadcn `Dialog` (desktop), full-screen (mobile)
3. **AC3**: Content sections: Customer Info, Transaction Details, Detector Results (7 detectors), Trust Score, Actions (Block/Whitelist)
4. **AC4**: Detector Results: Table showing each detector's decision, risk contribution, metadata
5. **AC5**: Trust Score: Progress bar (Shadcn `Progress`), current score / 100
6. **AC6**: Close: Escape key, X button, click outside
7. **AC7**: Accessibility: Focus trap, ARIA role="dialog"

---

## Tasks / Subtasks

- [x] **Task 1**: Create DetectionDetailsDialog component (AC2)
  - [x] Create `components/detection-details-dialog.tsx`
  - [x] Use Shadcn Dialog component
  - [x] Responsive: Centered modal desktop, full-screen mobile
  
- [x] **Task 2**: API endpoint for detection details (AC3)
  - [x] Create `app/api/detections/[id]/route.ts`
  - [x] Handler: `GET /api/detections/[id]`
  - [x] Verify Better Auth session
  - [x] Filter by organizationId (prevent cross-org access)
  - [x] Return full detection data with detectorResults
  
- [x] **Task 3**: Display Customer Info section (AC3)
  - [x] Show customer email, IP address, country
  - [x] Format IP with country code
  
- [x] **Task 4**: Display Transaction Details section (AC3)
  - [x] Amount (formatted as currency)
  - [x] Currency code
  - [x] Payment Intent ID (copyable)
  - [x] Timestamp
  
- [x] **Task 5**: Display Detector Results table (AC4)
  - [x] Use Shadcn Table component
  - [x] Rows for each detector
  - [x] Columns: Detector Name, Decision, Risk Score, Metadata
  - [x] Color-code by risk level
  
- [x] **Task 6**: Display Trust Score (AC5)
  - [x] Use Shadcn Progress component
  - [x] Show current score / 100
  - [x] Color gradient: red (<30), yellow (30-70), green (>70)
  
- [x] **Task 7**: Action buttons (AC3)
  - [x] Block button (triggers Story 2.7 flow - placeholder)
  - [x] Whitelist button (triggers Story 2.8 flow - placeholder)
  
- [x] **Task 8**: Keyboard navigation (AC6, AC7)
  - [x] Escape key closes dialog (via Shadcn Dialog)
  - [x] Tab cycles through focusable elements (focus trap via Shadcn)
  - [x] ARIA: role="dialog", aria-labelledby

---

## Dev Notes

### API Security & Multi-Tenancy

**Authentication** (Critical):
- Require Better Auth session
- Extract `organizationId` from session
- Verify detection belongs to user's organization (RLS)
- Return 401 if no session, 403 if wrong org

**Example Implementation**:
```typescript
// app/api/detections/[id]/route.ts
import { auth } from "@/lib/auth";

export async function GET(
  request: Request,
  { params }: { params: { id: string } }
) {
  const session = await auth.api.getSession({ headers: await headers() });
  if (!session) {
    return Response.json({ error: "Unauthorized" }, { status: 401 });
  }
  
  const organizationId = session.user.organizationId;
  const detectionId = params.id;
  
  // Query with RLS check
  const detection = await db
    .select()
    .from(fraudDetections)
    .where(
      and(
        eq(fraudDetections.id, detectionId),
        eq(fraudDetections.organizationId, organizationId) // RLS
      )
    )
    .limit(1);
  
  if (!detection[0]) {
    return Response.json({ error: "Not found" }, { status: 404 });
  }
  
  return Response.json(detection[0]);
}
```

### Shadcn Components

- Dialog (Modal wrapper)
- Table (Detector results)
- Progress (Trust score bar)
- Button (Actions)
- Badge (Decision badges)

### API Response Format

```json
{
  "id": "det_xxx",
  "paymentIntentId": "pi_xxx",
  "customerEmail": "customer@example.com",
  "customerIp": "1.2.3.4",
  "customerCountry": "FR",
  "amount": 5000,
  "currency": "eur",
  "decision": "BLOCK",
  "riskScore": 85,
  "confidence": 0.92,
  "detectorResults": [
    { "detectorId": "blacklist", "decision": "BLOCK", "score": 50, "metadata": { "reason": "Email blacklisted" } },
    { "detectorId": "velocity", "decision": "REVIEW", "score": 40, "metadata": { "txnCount": 8 } },
    { "detectorId": "geolocation", "decision": "REVIEW", "score": 30, "metadata": { "mismatch": "IP:US, Card:FR" } },
    // ... 4 more detectors
  ],
  "trustScore": 35,
  "createdAt": "2026-01-13T10:30:00Z"
}
```

### Responsive Design

- **Desktop**: Centered dialog (max-w-[600px])
- **Mobile**: Full-screen modal (w-full h-full)

### Source Tree Context

```
apps/web/
├── app/
│   └── api/
│       └── detections/
│           └── [id]/
│               └── route.ts     # GET handler
└── components/
    └── detection-details-dialog.tsx
```

---

## Testing

### Component Tests
- **File**: `components/detection-details-dialog.test.tsx` (9 tests, all passing)
- **Tests**: Dialog rendering, data fetching, all sections display, loading state, accessibility

### Testing Standards
- Framework: Vitest (unit/component)
- Coverage: 100% test pass rate

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-13 | 1.0 | Story created | Sarah (PO) |
| 2026-01-24 | 1.1 | Added API Security + RLS, detailed tasks, Status → Approved | Sarah (PO) |
| 2026-01-24 | 1.2 | Implementation complete, Status → Ready for Review | James (Dev) |

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (via Cursor)

### Implementation Summary
All 8 tasks completed successfully:
- Created API endpoint `/api/detections/[id]` with Better Auth and RLS
- Built DetectionDetailsDialog component with all required sections
- Customer Info, Transaction Details, Detector Results table, Trust Score, Action buttons
- Integrated dialog trigger in DetectionCard
- Responsive design (centered desktop, full-screen mobile)
- Full accessibility support (ARIA, focus trap, keyboard navigation)

### Completion Notes List
1. ✅ Created `/api/detections/[id]/route.ts` with RLS filtering (AC2, AC3)
2. ✅ Built DetectionDetailsDialog component with Shadcn Dialog (AC2)
3. ✅ Customer Info section with email, IP, country (AC3)
4. ✅ Transaction Details with copyable Payment Intent ID (AC3)
5. ✅ Detector Results table with 4 columns (AC4)
6. ✅ Trust Score with Progress bar and color gradient (AC5)
7. ✅ Action buttons (Block/Whitelist placeholders) (AC3)
8. ✅ Keyboard navigation and accessibility (AC6, AC7)
9. ✅ Updated DetectionCard to trigger dialog on click (AC1)
10. ✅ Tests: 9/9 tests passing
11. ✅ Responsive design with mobile-first approach

### File List
**Created:**
- `app/api/detections/[id]/route.ts` - GET endpoint for single detection (with RLS)
- `components/detection-details-dialog.tsx` - Full dialog component with all sections
- `components/detection-details-dialog.test.tsx` - Dialog tests (9 tests, all passing)

**Modified:**
- `components/detection-card.tsx` - Added onClick handler and keyboard navigation
- `app/dashboard/feed-client.tsx` - Added dialog state management

### Debug Log References
Minor linting fixes:
- Changed `Record<string, any>` to `Record<string, unknown>` for type safety
- Added eslint-disable for valid data fetching in useEffect
