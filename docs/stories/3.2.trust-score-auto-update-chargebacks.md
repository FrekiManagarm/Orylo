# Story 3.2: Trust Score Auto-Update sur Chargebacks

**Epic**: Epic 3 - Integration & Production Readiness  
**Story Points**: 3  
**Status**: Draft

---

## Story

**As a** system,  
**I want** trust scores to auto-update when chargebacks occur,  
**so that** fraudulent customers are penalized automatically.

---

## Acceptance Criteria

1. **AC1**: `charge.dispute.created` webhook handler
2. **AC2**: Trust score penalty application (-50 points)
3. **AC3**: Auto-blacklist logic pour repeat offenders (≥3 chargebacks)
4. **AC4**: Metadata enrichment (lastChargebackDate, totalChargebacks)
5. **AC5**: Cache invalidation
6. **AC6**: Unit test trust score logic

---

## Tasks / Subtasks

- [ ] Add webhook handler for `charge.dispute.created` (AC1)
- [ ] Extract customerId from dispute event (AC1)
- [ ] Update trust score: -50 points (min 0) (AC2)
- [ ] Increment totalChargebacks counter (AC4)
- [ ] Auto-blacklist if totalChargebacks ≥ 3 (AC3)
- [ ] Update metadata: lastChargebackDate (AC4)
- [ ] Invalidate Redis cache (AC5)
- [ ] Unit test: Verify -50 penalty, auto-blacklist logic (AC6)

---

## Dev Notes

**Webhook Event**:
```json
{
  "type": "charge.dispute.created",
  "data": {
    "object": {
      "id": "dp_xxx",
      "charge": "ch_xxx",
      "amount": 5000,
      "customer": "cus_xxx"
    }
  }
}
```

**Logic**:
```typescript
// charge.dispute.created handler
const customerId = event.data.object.customer;

// Update trust score
await db.update(customerTrustScores)
  .set({
    score: sql`GREATEST(score - 50, 0)`, // Min 0
    totalChargebacks: sql`total_chargebacks + 1`,
    lastChargebackDate: new Date(),
  })
  .where(eq(customerTrustScores.customerId, customerId));

// Auto-blacklist if ≥3 chargebacks
const customer = await db.select().from(customerTrustScores)
  .where(eq(customerTrustScores.customerId, customerId))
  .limit(1);

if (customer[0].totalChargebacks >= 3) {
  await db.update(customerTrustScores)
    .set({ isBlacklisted: true })
    .where(eq(customerTrustScores.customerId, customerId));
}

// Invalidate cache
await redis.del(`trust:${organizationId}:${customerId}`);
```

---

## Testing

- Unit: -50 penalty, auto-blacklist after 3 chargebacks
- Integration: Trigger `charge.dispute.created` → Verify DB update

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-13 | 1.0 | Story created | Sarah (PO) |
