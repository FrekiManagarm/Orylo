# Story 3.9: Production Deployment Configuration

**Epic**: Epic 3 - Integration & Production Readiness  
**Story Points**: 3  
**Status**: Draft

---

## Story

**As a** deployment engineer,  
**I want** production deployment fully configured,  
**so that** we can deploy reliably to Vercel.

---

## Acceptance Criteria

1. **AC1**: Vercel project configuration (orylo-production, Next.js, root: apps/web)
2. **AC2**: Environment variables configured (DATABASE_URL, REDIS_URL, BETTER_AUTH_*, STRIPE_*, LOG_LEVEL)
3. **AC3**: Custom domain configuration (orylo.com, SSL auto-provisioned)
4. **AC4**: Vercel deployment protection (main branch only, preview for others)
5. **AC5**: Database production setup (Neon Scale tier, connection pooling, backups)
6. **AC6**: Redis production setup (Upstash pay-as-you-go, TLS)
7. **AC7**: Stripe production webhooks (endpoint configured, events subscribed)
8. **AC8**: Monitoring & alerts setup (Vercel Analytics, PostHog, Sentry optional)
9. **AC9**: Rollback plan documented (docs/rollback-procedure.md)

---

## Tasks / Subtasks

- [x] Update vercel.json with deployment config (AC1) - Dev Agent
- [ ] Create Vercel project: orylo-production (Manual - Vercel Dashboard)
- [ ] Configure environment variables in Vercel dashboard (Manual - Vercel Dashboard)
- [ ] Setup custom domain: orylo.com (DNS + SSL) (Manual - DNS Provider)
- [ ] Enable deployment protection (main branch only) (Manual - Vercel Dashboard)
- [ ] Neon production database: Scale tier, pooling enabled (Manual - Neon Dashboard)
- [ ] Upstash Redis production: pay-as-you-go tier, TLS enabled (Manual - Upstash Dashboard)
- [ ] Stripe webhooks: Configure production endpoint (Manual - Stripe Dashboard)
- [ ] Vercel Analytics + PostHog integration (Automatic + Manual config)
- [x] Document rollback procedure (AC9) - Dev Agent
- [x] Create deployment checklist - Dev Agent

---

## Dev Notes

### Context & Integration Points
This story configures production deployment infrastructure for Vercel, including environment variables, custom domain, database, Redis, Stripe webhooks, and rollback procedures. This is a **DevOps/Infrastructure task** that should be performed by a developer with production access.

**Dependencies**: All Epic 1-3 stories must be completed and tested before production deployment.

### File Structure
```
/
â”œâ”€â”€ vercel.json (NEW - deployment config)
â”œâ”€â”€ .env.example (MODIFY - add all required vars)
docs/
â””â”€â”€ rollback-procedure.md (NEW - AC9)
```

### Part 1: Vercel Project Configuration (AC1)

**Create Vercel Project** (via Vercel Dashboard or CLI):

```bash
# Option 1: Via Vercel Dashboard
# 1. Go to vercel.com/new
# 2. Import Git repository: github.com/orylo/orylo
# 3. Project name: orylo-production
# 4. Framework: Next.js
# 5. Root directory: apps/web
# 6. Build command: bun run build
# 7. Install command: bun install

# Option 2: Via Vercel CLI
vercel link --project=orylo-production
vercel --prod
```

**Vercel Configuration File**:
```json
// vercel.json (NEW FILE - optional, most settings via dashboard)
{
  "buildCommand": "cd ../.. && bun run build --filter=web",
  "installCommand": "bun install",
  "framework": "nextjs",
  "outputDirectory": "apps/web/.next",
  "crons": [
    {
      "path": "/api/cron/data-retention",
      "schedule": "0 2 * * *"
    }
  ],
  "headers": [
    {
      "source": "/api/(.*)",
      "headers": [
        {
          "key": "X-Content-Type-Options",
          "value": "nosniff"
        },
        {
          "key": "X-Frame-Options",
          "value": "DENY"
        },
        {
          "key": "X-XSS-Protection",
          "value": "1; mode=block"
        }
      ]
    }
  ]
}
```

### Part 2: Environment Variables (AC2)

**Setup via Vercel Dashboard** (Settings â†’ Environment Variables):

```bash
# Database (AC5)
DATABASE_URL=postgresql://orylo_prod:***@ep-***-prod.us-east-2.aws.neon.tech/orylo?sslmode=require

# Redis (AC6)
REDIS_URL=https://***-prod.upstash.io
REDIS_TOKEN=***

# Better Auth (AC7)
BETTER_AUTH_SECRET=<generate-with-openssl-rand-base64-32>
BETTER_AUTH_URL=https://orylo.com
BETTER_AUTH_TRUSTED_ORIGINS=https://orylo.com

# Stripe (AC7)
STRIPE_CLIENT_ID=ca_***
STRIPE_SECRET_KEY=sk_live_***
STRIPE_WEBHOOK_SECRET=whsec_***

# Observability (AC8)
NEXT_PUBLIC_POSTHOG_KEY=phc_***
NEXT_PUBLIC_POSTHOG_HOST=https://app.posthog.com
# NEXT_PUBLIC_SENTRY_DSN=*** (optional)

# Cron (Story 3.5)
CRON_SECRET=<generate-with-openssl-rand-base64-32>

# Application Settings
LOG_LEVEL=info
NODE_ENV=production
NEXT_PUBLIC_APP_URL=https://orylo.com
```

**Security Best Practices**:
- All secrets marked as "Sensitive" in Vercel Dashboard
- Separate secrets for `production` and `preview` environments
- Use Vercel's built-in secret management (no .env in git)

**Update .env.example**:
```bash
# .env.example (MODIFY - add all variables)
# Copy this file to .env.local for local development

# Database (Neon PostgreSQL)
DATABASE_URL=postgresql://user:password@host/database

# Redis (Upstash)
REDIS_URL=https://your-redis.upstash.io
REDIS_TOKEN=your-token

# Better Auth
BETTER_AUTH_SECRET=your-secret-32-chars
BETTER_AUTH_URL=http://localhost:3000

# Stripe
STRIPE_CLIENT_ID=ca_your_client_id
STRIPE_SECRET_KEY=sk_test_your_secret_key
STRIPE_WEBHOOK_SECRET=whsec_your_webhook_secret

# Observability (Optional)
NEXT_PUBLIC_POSTHOG_KEY=phc_your_key
NEXT_PUBLIC_SENTRY_DSN=https://your-sentry-dsn

# Cron
CRON_SECRET=your-cron-secret

# Application
LOG_LEVEL=debug
NODE_ENV=development
```

### Part 3: Custom Domain Configuration (AC3)

**Add Custom Domain in Vercel**:
1. Go to Vercel Dashboard â†’ Settings â†’ Domains
2. Add domain: `orylo.com`
3. Configure DNS (choose one):

**Option A: CNAME Record** (recommended):
```
Type: CNAME
Name: @
Value: cname.vercel-dns.com
TTL: 3600
```

**Option B: A Record**:
```
Type: A
Name: @
Value: 76.76.19.19 (Vercel's IP)
TTL: 3600
```

4. SSL Certificate: Auto-provisioned by Vercel (Let's Encrypt)
5. Verify: Visit https://orylo.com (should show SSL padlock)

**Add www Subdomain** (optional):
```
Type: CNAME
Name: www
Value: cname.vercel-dns.com
```

### Part 4: Deployment Protection (AC4)

**Configure in Vercel Dashboard** (Settings â†’ Git):
- **Production Branch**: `main` only
- **Preview Deployments**: All other branches
- **Deploy Hooks**: Disabled (prevent unauthorized deploys)
- **Vercel Authentication**: Required for preview URLs

**Branch Protection on GitHub** (recommended):
```yaml
# GitHub Settings â†’ Branches â†’ Branch protection rules
Branch name pattern: main

Required status checks:
- âœ… CI/CD tests must pass
- âœ… Integration tests must pass
- âœ… Playwright E2E tests must pass

Require pull request reviews: 1 approval
```

### Part 5: Database Production Setup (AC5)

**Neon PostgreSQL Configuration**:

1. **Create Production Database**:
   - Tier: Scale (autoscaling)
   - Region: us-east-2 (same as Vercel deployment)
   - Database name: `orylo`

2. **Enable Connection Pooling**:
   - Pooler: Enabled (PgBouncer)
   - Pool mode: Transaction
   - Connection string: Use pooled connection URL in `DATABASE_URL`

3. **Backups**:
   - Automated backups: Enabled (daily)
   - Retention: 7 days
   - Point-in-time recovery: Enabled

4. **Run Migrations**:
```bash
# Connect to production database
DATABASE_URL=postgresql://prod:***@***.neon.tech/orylo bun run db:migrate
```

### Part 6: Redis Production Setup (AC6)

**Upstash Redis Configuration**:

1. **Create Production Redis**:
   - Tier: Pay-as-you-go (autoscaling)
   - Region: us-east-1 (closest to Vercel)
   - Database name: `orylo-prod`

2. **Enable TLS**:
   - TLS/SSL: Enabled (default)
   - Connection URL: Use `rediss://` protocol (secure)

3. **Set Eviction Policy**:
   - Policy: `allkeys-lru` (evict least recently used keys)
   - Max memory: Autoscaling (no limit in pay-as-you-go)

4. **Test Connection**:
```bash
# From local machine
redis-cli -u $REDIS_URL ping
# Should return: PONG
```

### Part 7: Stripe Production Webhooks (AC7)

**Configure Stripe Webhook Endpoint**:

1. Go to Stripe Dashboard â†’ Developers â†’ Webhooks
2. Add endpoint:
   - URL: `https://orylo.com/api/webhooks/stripe`
   - Events to send:
     - `payment_intent.created`
     - `charge.dispute.created`
     - `charge.succeeded` (optional)
     - `charge.failed` (optional)
3. Copy webhook signing secret
4. Add to Vercel env vars: `STRIPE_WEBHOOK_SECRET=whsec_***`

**Test Webhook**:
```bash
# Use Stripe CLI to trigger test event to production
stripe trigger payment_intent.created --webhook-endpoint https://orylo.com/api/webhooks/stripe
```

### Part 8: Monitoring & Alerts (AC8)

**Vercel Analytics** (AC3):
- Automatically enabled for Vercel projects
- Dashboard: https://vercel.com/orylo/analytics
- Metrics: P95 latency, error rate, page views

**PostHog** (Story 3.3):
- Already configured via `NEXT_PUBLIC_POSTHOG_KEY`
- Dashboard: https://app.posthog.com/project/xxxxx
- Events tracked: user_login, detection_created, customer_blocked

**Sentry** (Optional):
- If enabled, configure `NEXT_PUBLIC_SENTRY_DSN`
- Automatic error reporting

**Uptime Monitoring** (Optional):
- UptimeRobot or similar: Monitor https://orylo.com/api/health
- Alert if health check fails

### Part 9: Rollback Procedure (AC9)

```markdown
<!-- docs/rollback-procedure.md (NEW FILE) -->
# Production Rollback Procedure

## When to Rollback
- Critical bug affecting core functionality (login, detections, actions)
- Data loss or corruption
- Security vulnerability exposed
- Performance degradation (P95 >2s)

## Rollback Steps

### Step 1: Assess Impact (2 minutes)
1. Check Vercel Analytics for error spike
2. Check Sentry for error details
3. Check Discord #bug-reports for user reports
4. Determine if rollback needed (critical impact vs minor bug)

### Step 2: Identify Last Stable Deployment (1 minute)
1. Go to Vercel Dashboard â†’ Deployments
2. Sort by date (newest first)
3. Identify last deployment before bug (check commit message + timestamp)

### Step 3: Promote Previous Deployment (1 minute)
1. Click "..." menu on last stable deployment
2. Click "Promote to Production"
3. Confirm promotion
4. Wait for deployment to complete (~30 seconds)

### Step 4: Verify Rollback (2 minutes)
1. Visit https://orylo.com
2. Test login flow
3. Test detection feed load
4. Test block customer action
5. Check Vercel Analytics: Error rate should drop

### Step 5: Communicate (5 minutes)
1. Post in Discord #announcements:
   ```
   ðŸš¨ We've rolled back production due to [brief issue description].
   All services are now restored. We're investigating the root cause.
   Apologies for any disruption.
   ```
2. If user-facing impact: Email beta users via broadcast
3. Create postmortem document (within 24 hours)

### Step 6: Root Cause Analysis
1. Identify what caused the bug
2. Write postmortem: docs/postmortems/YYYY-MM-DD-incident.md
3. Add preventative measures (new tests, monitoring, etc.)
4. Fix bug in new PR with thorough testing

## Expected Rollback Time
- **Total**: <10 minutes (from decision to verified)
- **Downtime**: ~30 seconds (during deployment switch)

## Emergency Contacts
- **On-Call Engineer**: [Phone/Slack]
- **Founder**: [Phone]
- **Vercel Support**: support@vercel.com (Pro plan support)

## Rollback Decision Matrix

| Severity | Example | Action | Timeline |
|----------|---------|--------|----------|
| P0 (Critical) | Auth broken, data loss | Immediate rollback | <5 min |
| P1 (High) | Detection not saving | Rollback if no quick fix | <15 min |
| P2 (Medium) | UI bug, slow performance | Fix forward if possible | N/A |
| P3 (Low) | Typo, minor visual issue | Fix in next deploy | N/A |
```

### Error Handling
- **Domain verification fails**: Check DNS propagation (can take up to 48h)
- **SSL provisioning fails**: Verify domain ownership, contact Vercel support
- **Environment variables missing**: Deploy will fail gracefully with clear error
- **Database migration fails**: Rollback migration, fix locally, redeploy

### Security Considerations
- Production secrets never committed to git
- Vercel Dashboard access restricted to authorized personnel
- Database credentials rotated quarterly
- Webhook secrets validated on every request

### Testing Standards

**Test File Locations**: N/A (infrastructure configuration)

**Testing Framework**: Manual smoke testing

**Smoke Test Checklist** (AC6):
- [ ] https://orylo.com loads (custom domain working)
- [ ] SSL certificate valid (padlock icon)
- [ ] Login flow works
- [ ] Dashboard loads detections
- [ ] Stripe webhook triggers detection
- [ ] Block customer action works
- [ ] Mobile responsive (test on iPhone)
- [ ] Vercel Analytics tracking events
- [ ] PostHog events appearing in dashboard
- [ ] Health endpoint returns 200: https://orylo.com/api/health

---

## Testing

### Pre-Deployment Checklist
- [ ] All environment variables set in Vercel
- [ ] Database migrations run successfully
- [ ] Redis connection tested
- [ ] Stripe webhooks configured
- [ ] Custom domain DNS configured

### Post-Deployment Smoke Testing
- [ ] Custom domain loads with SSL
- [ ] Login flow completes
- [ ] Detection feed loads
- [ ] Webhook processing works
- [ ] Block customer action succeeds
- [ ] Mobile responsive verified

### Monitoring Verification
- [ ] Vercel Analytics showing data
- [ ] PostHog events appearing
- [ ] Health endpoint returns healthy status

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-13 | 1.0 | Story created | Sarah (PO) |
| 2026-01-24 | 1.1 | Comprehensive deployment guide, rollback procedure, smoke test checklist | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (via Cursor)

### Implementation Summary
Completed documentation and configuration files for production deployment. Updated vercel.json with build settings, security headers, and cron configuration. Created comprehensive rollback procedure documentation with step-by-step instructions, decision matrix, and emergency contacts. Created deployment checklist covering pre-deployment, deployment, and post-deployment verification steps. All infrastructure configuration tasks (Vercel project setup, environment variables, domain, database, Redis, Stripe webhooks) are documented but require manual execution via respective dashboards.

### Completion Notes List
- Updated vercel.json with build command, install command, framework, output directory, and security headers
- Created docs/rollback-procedure.md with comprehensive rollback steps, decision matrix, and emergency procedures
- Created docs/deployment-checklist.md with pre-deployment, deployment, and post-deployment verification steps
- All manual tasks (AC1-AC8) are documented with step-by-step instructions but require dashboard access
- Rollback procedure includes decision matrix (P0-P3 severity levels) and expected timelines
- Deployment checklist includes smoke testing steps for all critical features
- Security headers configured in vercel.json (X-Content-Type-Options, X-Frame-Options, X-XSS-Protection)

### File List
**Created:**
- `docs/rollback-procedure.md` - Production rollback procedure
- `docs/deployment-checklist.md` - Pre/post deployment checklist

**Modified:**
- `vercel.json` - Enhanced with build settings and security headers

**Manual Tasks (Require Dashboard Access):**
- Vercel project creation and configuration
- Environment variables setup
- Custom domain configuration
- Database and Redis production setup
- Stripe webhook configuration
- Monitoring integration

### Debug Log References
- Deployment: Monitor via Vercel Dashboard â†’ Deployments
- Rollback: Use Vercel Dashboard â†’ Deployments â†’ Promote to Production
- Health checks: `https://orylo.com/api/health`
- Monitoring: Vercel Analytics, PostHog Dashboard, Sentry (if enabled)
- Error tracking: Check Vercel logs, Sentry, and application logs

---

## QA Results

(To be filled by QA Agent after implementation review)
