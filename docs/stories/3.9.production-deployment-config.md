# Story 3.9: Production Deployment Configuration

**Epic**: Epic 3 - Integration & Production Readiness  
**Story Points**: 3  
**Status**: Draft

---

## Story

**As a** deployment engineer,  
**I want** production deployment fully configured,  
**so that** we can deploy reliably to Vercel.

---

## Acceptance Criteria

1. **AC1**: Vercel project configuration (orylo-production, Next.js, root: apps/web)
2. **AC2**: Environment variables configured (DATABASE_URL, REDIS_URL, BETTER_AUTH_*, STRIPE_*, LOG_LEVEL)
3. **AC3**: Custom domain configuration (orylo.com, SSL auto-provisioned)
4. **AC4**: Vercel deployment protection (main branch only, preview for others)
5. **AC5**: Database production setup (Neon Scale tier, connection pooling, backups)
6. **AC6**: Redis production setup (Upstash pay-as-you-go, TLS)
7. **AC7**: Stripe production webhooks (endpoint configured, events subscribed)
8. **AC8**: Monitoring & alerts setup (Vercel Analytics, PostHog, Sentry optional)
9. **AC9**: Rollback plan documented (docs/rollback-procedure.md)

---

## Tasks / Subtasks

- [ ] Create Vercel project: orylo-production
- [ ] Configure environment variables in Vercel dashboard
- [ ] Setup custom domain: orylo.com (DNS + SSL)
- [ ] Enable deployment protection (main branch only)
- [ ] Neon production database: Scale tier, pooling enabled
- [ ] Upstash Redis production: pay-as-you-go tier, TLS enabled
- [ ] Stripe webhooks: Configure production endpoint
- [ ] Vercel Analytics + PostHog integration
- [ ] Document rollback procedure

---

## Dev Notes

**Vercel Configuration**:
```json
// vercel.json
{
  "buildCommand": "bun run build",
  "installCommand": "bun install",
  "framework": "nextjs",
  "outputDirectory": ".next"
}
```

**Environment Variables** (Vercel Dashboard):
```
DATABASE_URL=postgresql://prod:***@***-prod.neon.tech/orylo
REDIS_URL=https://***-prod.upstash.io
BETTER_AUTH_SECRET=***
BETTER_AUTH_URL=https://orylo.com
STRIPE_CLIENT_ID=ca_***
STRIPE_SECRET_KEY=sk_live_***
STRIPE_WEBHOOK_SECRET=whsec_***
NEXT_PUBLIC_POSTHOG_KEY=***
NEXT_PUBLIC_POSTHOG_HOST=https://app.posthog.com
LOG_LEVEL=info
NODE_ENV=production
```

**Custom Domain**:
- Domain: `orylo.com`
- DNS: Point to Vercel (CNAME or A record)
- SSL: Auto-provisioned by Vercel (Let's Encrypt)

**Stripe Webhooks**:
- Endpoint: `https://orylo.com/api/webhooks/stripe`
- Events: `payment_intent.created`, `charge.dispute.created`
- Webhook secret: Copy to Vercel env vars

**Rollback Procedure**:
```markdown
# Rollback Procedure

## Scenario: Critical bug in production

### Step 1: Identify last working deployment
- Go to Vercel dashboard â†’ Deployments
- Find last successful deployment before bug

### Step 2: Promote previous deployment
- Click "..." on last working deployment
- Click "Promote to Production"
- Confirm

### Step 3: Verify rollback
- Check https://orylo.com loads correctly
- Test critical flows (login, detection, block)

### Step 4: Communicate
- Post in Discord #announcements
- Email beta users if impact was user-facing

Time to rollback: <5 minutes
```

---

## Testing

- Smoke test: Deploy to Vercel preview, verify working
- Manual: Test custom domain + SSL

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-13 | 1.0 | Story created | Sarah (PO) |
