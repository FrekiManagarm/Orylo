# Story 4.1: Suggestions IA pour Whitelist/Blacklist

**Epic**: Epic 4 - SystÃ¨me de DÃ©cisions AssistÃ© par IA  
**Story Points**: 8  
**Status**: ðŸ“‹ Draft

---

## Story

**As a** merchant,  
**I want** to receive AI-powered suggestions for whitelisting or blacklisting customers based on historical patterns,  
**so that** I can make faster, more informed decisions while reducing false positives.

---

## Acceptance Criteria

1. **AC1**: System analyzes historical transaction patterns (successful payments, chargebacks, blocked transactions) from `fraud_detections` and `customer_trust_scores` tables
2. **AC2**: AI suggests whitelist for customers with: trust score >80, â‰¥3 successful transactions (decision='ALLOW') in last 90 days, no chargebacks, status='normal'
3. **AC3**: AI suggests blacklist for customers with: trust score <30, â‰¥2 chargebacks, OR card testing pattern (â‰¥5 failed attempts in 1h), OR â‰¥3 blocked transactions, status='normal'
4. **AC4**: Suggestions displayed in `detection-details-dialog.tsx` with confidence score (0-1), reasoning summary, and suggestion type badge
5. **AC5**: Merchant can accept/reject suggestion with one click (buttons in `ai-suggestion-card.tsx`)
6. **AC6**: Accepted suggestions automatically apply whitelist/blacklist action:
   - Whitelist: Call `updateTrustScore(organizationId, customerId, 'whitelisted')` â†’ sets status='whitelisted', score=90
   - Blacklist: Update DB directly `customer_trust_scores.status='blacklisted'`, `trustScore=0` (pattern similaire Ã  `block-customer-button.tsx` Story 2.7)
7. **AC6.1**: Error handling: If action fails â†’ Rollback suggestion accepted status, display error toast to merchant
8. **AC7**: Performance: Suggestions generated <500ms (cached patterns in Redis, key: `pattern:{customerId}`, TTL: 30min)
9. **AC8**: Integration test: Verify suggestion logic with mock historical data (mock `fraud_detections` and `customer_trust_scores` records)
10. **AC9**: Priority rule: Only one suggestion per detection (blacklist suggestion takes priority over whitelist if both criteria met)

---

## Tasks / Subtasks

- [ ] **Task 1**: Create suggestion analysis engine (AC1, AC2, AC3)
  - [ ] Create `lib/ai/suggestion-engine.ts` with pattern analysis logic
  - [ ] Query historical transactions for customer (successful, chargebacks, blocks)
  - [ ] Calculate whitelist suggestion score (trust score >80, â‰¥3 successful transactions)
  - [ ] Calculate blacklist suggestion score (card testing pattern, â‰¥2 chargebacks)
  - [ ] Return suggestion with confidence score (0-1)

- [ ] **Task 2**: Database schema for AI suggestions (AC4)
  - [ ] Create `ai_suggestions` table migration (Drizzle)
  - [ ] Fields: `id`, `detectionId`, `type` (whitelist/blacklist), `confidence`, `suggestion` (JSON), `accepted`, `merchantAction`, `createdAt`
  - [ ] Add foreign key to `fraud_detections` table

- [ ] **Task 3**: API endpoint for suggestions (AC4, AC5, AC6)
  - [ ] Create `GET /api/detections/[id]/suggestions` endpoint
  - [ ] Return suggestions with confidence score and reasoning
  - [ ] Create `POST /api/suggestions/[id]/accept` endpoint
  - [ ] Create `POST /api/suggestions/[id]/reject` endpoint
  - [ ] Auto-apply whitelist/blacklist action when accepted (AC6)
    - [ ] If whitelist accepted â†’ Call `updateTrustScore(organizationId, customerId, 'whitelisted')` (sets status='whitelisted', score=90)
    - [ ] If blacklist accepted â†’ Update DB directly (pattern similaire Ã  `block-customer-button.tsx`):
      - [ ] Update `customer_trust_scores.status='blacklisted'`, `trustScore=0`
      - [ ] Use Drizzle: `db.update(customerTrustScores).set({ status: 'blacklisted', trustScore: 0 })`
    - [ ] Invalidate Redis cache: `trust:{organizationId}:{customerId}` (via `invalidateTrustScoreCache()`)
    - [ ] Error handling: If action fails â†’ Rollback suggestion accepted, show error toast (AC6.1)

- [ ] **Task 4**: UI component for suggestions (AC4, AC5)
  - [ ] Create `components/ai-suggestion-card.tsx` component
  - [ ] Display suggestion type, confidence score, reasoning summary
  - [ ] Add Accept/Reject buttons (Shadcn Button)
  - [ ] Integrate into `detection-details-dialog.tsx`
  - [ ] Show suggestion badge in `detection-card.tsx` (if suggestion exists)

- [ ] **Task 5**: Caching strategy (AC7)
  - [ ] Cache suggestion results in Redis (key: `suggestion:{detectionId}`, TTL: 1h)
  - [ ] Cache pattern analysis results (key: `pattern:{customerId}`, TTL: 30min)
  - [ ] Invalidate cache on new transaction or action

- [ ] **Task 6**: Integration tests (AC8)
  - [ ] Test suggestion generation with mock historical data
  - [ ] Test whitelist suggestion logic (high trust score, successful transactions)
  - [ ] Test blacklist suggestion logic (fraud patterns, chargebacks)
  - [ ] Test API endpoints (get, accept, reject)

---

## Dependencies

**Depends on**:
- Epic 1: `customer_trust_scores` table, `fraud_detections` table, `updateTrustScore()` function
- Epic 2: `detection-details-dialog.tsx`, `block-customer-button.tsx`, `whitelist-customer-button.tsx`
- Epic 3: Redis cache configured

**Blocks**:
- Story 4.4: Feedback tracking requires suggestion accept/reject endpoints (this story)

**Can be developed in parallel with**:
- Story 4.2 (AI explanations) - no shared dependencies
- Story 4.3 (Rule recommendations) - no shared dependencies

---

## Dev Notes

### Relevant Architecture

**Pattern Analysis Logic**:
```typescript
interface SuggestionContext {
  customerId: string;
  organizationId: string;
  historicalTransactions: Transaction[];
  trustScore: number;
  chargebackCount: number;
  blockedCount: number;
}

interface AISuggestion {
  type: 'whitelist' | 'blacklist';
  confidence: number; // 0-1
  reasoning: string;
  factors: string[];
}
```

**Whitelist Suggestion Criteria**:
- Trust score >80 (from `customer_trust_scores.trustScore`)
- â‰¥3 successful transactions in last 90 days (query `fraud_detections` where `decision='ALLOW'`)
- No chargebacks in last 90 days (check `customer_trust_scores.totalChargebacks` and `lastChargebackDate`)
- Average transaction amount consistent (calculate from `fraud_detections.amount`)
- Current status is 'normal' (not already whitelisted/blacklisted)

**Blacklist Suggestion Criteria**:
- Trust score <30 (from `customer_trust_scores.trustScore`)
- â‰¥2 chargebacks in last 90 days (check `customer_trust_scores.totalChargebacks >= 2`)
- Card testing pattern detected (â‰¥5 failed attempts in last 1 hour - query `fraud_detections` with same `customerEmail`)
- Multiple blocked transactions (â‰¥3 detections with `decision='BLOCK'` in last 30 days)
- Current status is 'normal' (not already blacklisted)

**Database Schema**:
```typescript
// packages/database/src/schema/ai-suggestions.ts
import { pgTable, text, timestamp, boolean, real, jsonb } from "drizzle-orm/pg-core";
import { fraudDetections } from "./fraud-detections";
import { organizations } from "./organizations";

export const aiSuggestions = pgTable('ai_suggestions', {
  id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),
  detectionId: text('detection_id')
    .notNull()
    .references(() => fraudDetections.id, { onDelete: 'cascade' }),
  organizationId: text('organization_id')
    .notNull()
    .references(() => organizations.id, { onDelete: 'cascade' }),
  type: text('type', { enum: ['whitelist', 'blacklist'] }).notNull(),
  confidence: real('confidence').notNull(), // 0-1
  suggestion: jsonb('suggestion').notNull(), // {reasoning: string, factors: string[]}
  accepted: boolean('accepted').default(false).notNull(),
  merchantAction: text('merchant_action'), // 'accepted', 'rejected', 'modified'
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

// Indexes for performance
export const aiSuggestionsIndexes = {
  detectionId: index('ai_suggestions_detection_id_idx').on(aiSuggestions.detectionId),
  organizationId: index('ai_suggestions_organization_id_idx').on(aiSuggestions.organizationId),
  type: index('ai_suggestions_type_idx').on(aiSuggestions.type),
};
```

**Integration Points**:
- Uses existing `customer_trust_scores` table (Epic 1) - Note: Uses `status` field ('whitelisted', 'blacklisted', 'normal', 'vip'), not boolean flags
- Uses existing `fraud_detections` table (Epic 1) - Query historical transactions via `customerEmail` or `customerId`
- Integrates with `block-customer-button.tsx` and `whitelist-customer-button.tsx` (Epic 2)
- Uses existing `updateTrustScore()` function from `lib/fraud/trust-score.ts` (Epic 1) - For whitelist only
- Uses direct DB update for blacklist (pattern similaire Ã  `block-customer-button.tsx` Story 2.7)
- Uses Redis cache (Epic 3) - Cache key pattern: `trust:{organizationId}:{customerId}`
- Uses `invalidateTrustScoreCache()` from `lib/cache.ts` for cache invalidation

**Security & Multi-Tenancy**:
- All API endpoints must verify Better Auth session (pattern: `auth.api.getSession()`)
- Extract `organizationId` from session for multi-tenancy
- Verify suggestion belongs to user's organization (via `detectionId` â†’ `fraud_detections.organizationId`)
- Return 401 if no session, 403 if wrong organization
- Validate `detectionId` and `suggestionId` format (UUID) and existence in DB

**UI Integration Details**:
- Integrate `ai-suggestion-card.tsx` in `detection-details-dialog.tsx`:
  - Position: After Trust Score section, before Actions section (Block/Whitelist buttons)
  - Show suggestion card only if suggestion exists for this detection
  - Badge in `detection-card.tsx`: Variant 'secondary', icon IA, text "Suggestion disponible"
  - Confidence display: Format "85% confiance" with Progress bar (Shadcn Progress component)

**Performance Optimization**:
- Cache suggestion results to avoid re-computation (key: `suggestion:{detectionId}`, TTL: 1h)
- Cache pattern analysis (customer-level) for 30 minutes (key: `pattern:{customerId}`, TTL: 30min)
- Query optimization: Index on `customerId`, `organizationId`, `createdAt` in `fraud_detections` table
- Limit historical query to 90 days (use `gte(fraudDetections.createdAt, subDays(new Date(), 90))`)

**Query Examples**:
```typescript
// Query successful transactions last 90 days (AC2)
import { subDays } from "date-fns";
import { gte, and, eq } from "drizzle-orm";

const successfulTxns = await db
  .select()
  .from(fraudDetections)
  .where(
    and(
      eq(fraudDetections.organizationId, organizationId),
      eq(fraudDetections.customerEmail, customerEmail),
      eq(fraudDetections.decision, 'ALLOW'),
      gte(fraudDetections.createdAt, subDays(new Date(), 90))
    )
  );

// Query blocked transactions last 30 days (AC3)
const blockedTxns = await db
  .select()
  .from(fraudDetections)
  .where(
    and(
      eq(fraudDetections.organizationId, organizationId),
      eq(fraudDetections.customerEmail, customerEmail),
      eq(fraudDetections.decision, 'BLOCK'),
      gte(fraudDetections.createdAt, subDays(new Date(), 30))
    )
  );
```

**Confidence Score Calculation**:
- Base confidence on number of matching criteria
- Formula: `confidence = (matchingCriteria / totalCriteria) * patternStrength`
- Example: Whitelist with 4/4 criteria â†’ confidence 0.9, 3/4 criteria â†’ confidence 0.7
- Pattern strength: Card testing pattern = 0.9, chargebacks = 0.8, blocked transactions = 0.7

### Source Tree Context

```
apps/web/
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ ai/
â”‚       â”œâ”€â”€ suggestion-engine.ts        # Pattern analysis & suggestion generation
â”‚       â””â”€â”€ suggestion-cache.ts        # Redis caching logic
â”œâ”€â”€ app/
â”‚   â””â”€â”€ api/
â”‚       â”œâ”€â”€ detections/
â”‚       â”‚   â””â”€â”€ [id]/
â”‚       â”‚       â””â”€â”€ suggestions/
â”‚       â”‚           â””â”€â”€ route.ts        # GET suggestions
â”‚       â””â”€â”€ suggestions/
â”‚           â””â”€â”€ [id]/
â”‚               â”œâ”€â”€ accept/
â”‚               â”‚   â””â”€â”€ route.ts        # POST accept suggestion
â”‚               â””â”€â”€ reject/
â”‚                   â””â”€â”€ route.ts        # POST reject suggestion
â””â”€â”€ components/
    â”œâ”€â”€ ai-suggestion-card.tsx          # Suggestion UI component
    â””â”€â”€ detection-details-dialog.tsx     # Integrate suggestion card
```

---

## Testing

### Unit Tests
- **File**: `apps/web/lib/ai/suggestion-engine.test.ts`
- **Tests**:
  - Whitelist suggestion logic (trust score >80, â‰¥3 successful transactions)
  - Blacklist suggestion logic (fraud patterns, chargebacks)
  - Confidence score calculation
  - Pattern analysis accuracy

### Integration Tests
- **File**: `apps/web/lib/ai/__tests__/suggestion-engine.integration.test.ts`
- **Tests**:
  - Full suggestion flow with real database
  - API endpoints (get, accept, reject)
  - Cache invalidation on actions

### E2E Tests
- **File**: `e2e/ai-suggestions.spec.ts` (Playwright)
- **Tests**:
  - Suggestion appears in detection dialog
  - Accept suggestion â†’ whitelist/blacklist applied
  - Reject suggestion â†’ feedback tracked

### Testing Standards
- Framework: Vitest (unit), Playwright (E2E)
- Coverage target: â‰¥80% for suggestion logic
- Mock historical data for deterministic tests:
  - **Required mock data**: 10+ `fraud_detections` records avec diffÃ©rents patterns:
    - 5+ records avec `decision='ALLOW'` (successful transactions)
    - 2+ records avec `decision='BLOCK'` (blocked transactions)
    - VariÃ©tÃ© de `customerEmail`, `createdAt` (last 90 days), `amount`
  - **Required mock data**: `customer_trust_scores` records avec diffÃ©rents `trustScore`, `status`, `totalChargebacks`
- Test edge cases:
  - No transaction history (new customer) â†’ No suggestion
  - Conflicting patterns (high trust score but recent chargeback) â†’ No whitelist suggestion
  - Already whitelisted/blacklisted customer (status != 'normal') â†’ No suggestion
  - Customer with status='vip' â†’ No blacklist suggestion
  - Multiple criteria met (blacklist + whitelist) â†’ Blacklist suggestion only (priority)
  - `updateTrustScore()` fails â†’ Error handling, rollback

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-26 | 1.0 | Story created | Sarah (PO) |
| 2026-01-26 | 1.1 | Validation fixes: Added AC6.1, AC9, security section, UI integration details, query examples, confidence formula | Sarah (PO) |

---

## Dev Agent Record

(To be populated during implementation)

---

## QA Results

(To be populated by QA agent after testing)
