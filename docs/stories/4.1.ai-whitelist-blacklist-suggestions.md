# Story 4.1: Suggestions IA pour Whitelist/Blacklist

**Epic**: Epic 4 - SystÃ¨me de DÃ©cisions AssistÃ© par IA  
**Story Points**: 8  
**Status**: ðŸ”„ InProgress

---

## Story

**As a** merchant,  
**I want** to receive AI-powered suggestions for whitelisting or blacklisting customers based on historical patterns,  
**so that** I can make faster, more informed decisions while reducing false positives.

---

## Acceptance Criteria

1. **AC1**: System analyzes historical transaction patterns (successful payments, chargebacks, blocked transactions) from `fraud_detections` and `customer_trust_scores` tables
2. **AC2**: AI suggests whitelist for customers with: trust score >80, â‰¥3 successful transactions (decision='ALLOW') in last 90 days, no chargebacks, status='normal'
3. **AC3**: AI suggests blacklist for customers with: trust score <30, â‰¥2 chargebacks, OR card testing pattern (â‰¥5 failed attempts in 1h), OR â‰¥3 blocked transactions, status='normal'
4. **AC4**: Suggestions displayed in `detection-details-dialog.tsx` with confidence score (0-1), reasoning summary, and suggestion type badge
5. **AC5**: Merchant can accept/reject suggestion with one click (buttons in `ai-suggestion-card.tsx`)
6. **AC6**: Accepted suggestions automatically apply whitelist/blacklist action:
   - Whitelist: Call `updateTrustScore(organizationId, customerId, 'whitelisted')` â†’ sets status='whitelisted', score=90
     - **Note**: Uses `customerId` (Stripe customer ID) from `fraud_detections.customerId` or `customer_trust_scores.customerId`
   - Blacklist: Update DB directly `customer_trust_scores.status='blacklisted'`, `trustScore=0` (pattern similaire Ã  `block-customer-button.tsx` Story 2.7)
     - **Note**: Uses `customerId` (Stripe customer ID) - query `customer_trust_scores` by `customerId` (primary) or `customerEmail` (fallback if customerId missing)
7. **AC6.1**: Error handling: If action fails â†’ Rollback suggestion accepted status, display error toast to merchant
8. **AC7**: Performance: Suggestions generated <500ms (cached patterns in Redis, key: `pattern:{customerId}`, TTL: 30min)
9. **AC8**: Integration test: Verify suggestion logic with mock historical data (mock `fraud_detections` and `customer_trust_scores` records)
10. **AC9**: Priority rule: Only one suggestion per detection (blacklist suggestion takes priority over whitelist if both criteria met)

---

## Tasks / Subtasks

- [x] **Task 1**: Create suggestion analysis engine (AC1, AC2, AC3)
  - [x] Create `lib/ai/suggestion-engine.ts` with pattern analysis logic
  - [x] Query historical transactions for customer (successful, chargebacks, blocks)
  - [x] Calculate whitelist suggestion score (trust score >80, â‰¥3 successful transactions)
  - [x] Calculate blacklist suggestion score (card testing pattern, â‰¥2 chargebacks)
  - [x] Return suggestion with confidence score (0-1)

- [x] **Task 2**: Database schema for AI suggestions (AC4)
  - [x] Create `ai_suggestions` table migration (Drizzle)
  - [x] Fields: `id`, `detectionId`, `type` (whitelist/blacklist), `confidence`, `suggestion` (JSON), `accepted`, `merchantAction`, `createdAt`
  - [x] Add foreign key to `fraud_detections` table

- [x] **Task 3**: API endpoint for suggestions (AC4, AC5, AC6)
  - [x] Create `GET /api/detections/[id]/suggestions` endpoint
    - [x] Validate `detectionId` with Zod schema (UUID format)
    - [x] Apply rate limiting: 100 req/min per organization (ADR-010)
  - [x] Return suggestions with confidence score and reasoning
  - [x] Create `POST /api/suggestions/[id]/accept` endpoint
    - [x] Validate `suggestionId` with Zod schema (UUID format)
    - [x] Apply rate limiting: 50 req/min per organization (ADR-010)
  - [x] Create `POST /api/suggestions/[id]/reject` endpoint
    - [x] Validate `suggestionId` with Zod schema (UUID format)
    - [x] Apply rate limiting: 50 req/min per organization (ADR-010)
  - [x] Auto-apply whitelist/blacklist action when accepted (AC6)
    - [x] If whitelist accepted â†’ Call `updateTrustScore(organizationId, customerId, 'whitelisted')` (sets status='whitelisted', score=90)
      - [x] Extract `customerId` from `fraud_detections.customerId` (primary) or lookup via `customerEmail` if missing
    - [x] If blacklist accepted â†’ Update DB directly (pattern similaire Ã  `block-customer-button.tsx`):
      - [x] Extract `customerId` from `fraud_detections.customerId` (primary) or lookup via `customerEmail` if missing
      - [x] Update `customer_trust_scores.status='blacklisted'`, `trustScore=0`
      - [x] Use Drizzle: `db.update(customerTrustScores).set({ status: 'blacklisted', trustScore: 0 }).where(and(eq(customerTrustScores.organizationId, organizationId), eq(customerTrustScores.customerId, customerId)))`
    - [x] Invalidate Redis cache: `trust:{organizationId}:{customerId}` (via `invalidateTrustScoreCache()`)
    - [x] Error handling: If action fails â†’ Rollback suggestion accepted, show error toast (AC6.1)

- [x] **Task 4**: UI component for suggestions (AC4, AC5)
  - [x] Create `components/ai-suggestion-card.tsx` component
    - [x] Design: Card layout with border (Shadcn Card component)
    - [x] Styling: 
      - Whitelist suggestion: Border color `border-green-500`, background `bg-green-50/50` (light mode), `bg-green-950/20` (dark mode)
      - Blacklist suggestion: Border color `border-red-500`, background `bg-red-50/50` (light mode), `bg-red-950/20` (dark mode)
      - Confidence badge: Shadcn Badge component, variant based on confidence (high â‰¥0.8: 'default', medium 0.5-0.8: 'secondary', low <0.5: 'outline')
    - [x] Display suggestion type, confidence score, reasoning summary
    - [x] Reasoning text: Sanitize with DOMPurify before display (XSS prevention, ADR-010)
    - [x] Add Accept/Reject buttons (Shadcn Button)
      - Accept button: Variant 'default' for whitelist, 'destructive' for blacklist
      - Reject button: Variant 'outline'
    - [x] Responsive: Mobile-friendly layout (stack vertically on <768px)
    - [x] Accessibility: ARIA labels, keyboard navigation (Enter to accept, Escape to reject)
  - [x] Integrate into `detection-details-dialog.tsx`
  - [ ] Show suggestion badge in `detection-card.tsx` (if suggestion exists) - TODO: Requires API modification to include hasSuggestion flag

- [x] **Task 5**: Caching strategy (AC7)
  - [x] Cache suggestion results in Redis (key: `suggestion:{detectionId}`, TTL: 1h)
  - [x] Cache pattern analysis results (key: `pattern:{customerId}`, TTL: 30min)
  - [x] Invalidate cache on new transaction or action

- [x] **Task 6**: Integration tests (AC8)
  - [x] Test suggestion generation with mock historical data
  - [x] Test whitelist suggestion logic (high trust score, successful transactions)
  - [x] Test blacklist suggestion logic (fraud patterns, chargebacks)
  - [x] Test API endpoints (get, accept, reject)

---

## Dependencies

**Depends on**:
- Epic 1: `customer_trust_scores` table, `fraud_detections` table, `updateTrustScore()` function
- Epic 2: `detection-details-dialog.tsx`, `block-customer-button.tsx`, `whitelist-customer-button.tsx`
- Epic 3: Redis cache configured

**Blocks**:
- Story 4.4: Feedback tracking requires suggestion accept/reject endpoints (this story)

**Can be developed in parallel with**:
- Story 4.2 (AI explanations) - no shared dependencies
- Story 4.3 (Rule recommendations) - no shared dependencies

---

## Dev Notes

### Relevant Architecture

**Pattern Analysis Logic**:
```typescript
interface SuggestionContext {
  customerId: string;
  organizationId: string;
  historicalTransactions: Transaction[];
  trustScore: number;
  chargebackCount: number;
  blockedCount: number;
}

interface AISuggestion {
  type: 'whitelist' | 'blacklist';
  confidence: number; // 0-1
  reasoning: string;
  factors: string[];
}
```

**Whitelist Suggestion Criteria**:
- Trust score >80 (from `customer_trust_scores.trustScore`)
- â‰¥3 successful transactions in last 90 days (query `fraud_detections` where `decision='ALLOW'`)
- No chargebacks in last 90 days (check `customer_trust_scores.totalChargebacks` and `lastChargebackDate`)
- Average transaction amount consistent (calculate from `fraud_detections.amount`)
- Current status is 'normal' (not already whitelisted/blacklisted)

**Blacklist Suggestion Criteria**:
- Trust score <30 (from `customer_trust_scores.trustScore`)
- â‰¥2 chargebacks in last 90 days (check `customer_trust_scores.totalChargebacks >= 2`)
- Card testing pattern detected (â‰¥5 failed attempts in last 1 hour - query `fraud_detections` with same `customerEmail`)
- Multiple blocked transactions (â‰¥3 detections with `decision='BLOCK'` in last 30 days)
- Current status is 'normal' (not already blacklisted)

**Database Schema**:
```typescript
// packages/database/src/schema/ai-suggestions.ts
import { pgTable, text, timestamp, boolean, real, jsonb } from "drizzle-orm/pg-core";
import { fraudDetections } from "./fraud-detections";
import { organizations } from "./organizations";

export const aiSuggestions = pgTable('ai_suggestions', {
  id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),
  detectionId: text('detection_id')
    .notNull()
    .references(() => fraudDetections.id, { onDelete: 'cascade' }),
  organizationId: text('organization_id')
    .notNull()
    .references(() => organizations.id, { onDelete: 'cascade' }),
  type: text('type', { enum: ['whitelist', 'blacklist'] }).notNull(),
  confidence: real('confidence').notNull(), // 0-1
  suggestion: jsonb('suggestion').notNull(), // {reasoning: string, factors: string[]}
  accepted: boolean('accepted').default(false).notNull(),
  merchantAction: text('merchant_action'), // 'accepted', 'rejected', 'modified'
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

// Indexes for performance
export const aiSuggestionsIndexes = {
  detectionId: index('ai_suggestions_detection_id_idx').on(aiSuggestions.detectionId),
  organizationId: index('ai_suggestions_organization_id_idx').on(aiSuggestions.organizationId),
  type: index('ai_suggestions_type_idx').on(aiSuggestions.type),
};
```

**Integration Points**:
- Uses existing `customer_trust_scores` table (Epic 1) - Note: Uses `status` field ('whitelisted', 'blacklisted', 'normal', 'vip'), not boolean flags
- Uses existing `fraud_detections` table (Epic 1) - Query historical transactions via `customerEmail` or `customerId`
- Integrates with `block-customer-button.tsx` and `whitelist-customer-button.tsx` (Epic 2)
- Uses existing `updateTrustScore()` function from `lib/fraud/trust-score.ts` (Epic 1) - For whitelist only
- Uses direct DB update for blacklist (pattern similaire Ã  `block-customer-button.tsx` Story 2.7)
- Uses Redis cache (Epic 3, ADR-003) - Cache key pattern: `trust:{organizationId}:{customerId}`
- Uses `invalidateTrustScoreCache()` from `lib/cache.ts` for cache invalidation
- **ADR References**: ADR-003 (Cache Architecture), ADR-010 (Security Architecture)

**Security & Multi-Tenancy** (ADR-010):
- All API endpoints must verify Better Auth session (pattern: `auth.api.getSession()`)
- Extract `organizationId` from session for multi-tenancy
- Verify suggestion belongs to user's organization (via `detectionId` â†’ `fraud_detections.organizationId`)
- Return 401 if no session, 403 if wrong organization
- **Input Validation (Zod schemas)**:
  ```typescript
  // lib/validation/ai-suggestions.ts
  import { z } from "zod";
  
  export const DetectionIdSchema = z.string().uuid("Invalid detection ID format");
  export const SuggestionIdSchema = z.string().uuid("Invalid suggestion ID format");
  
  // Usage in API routes
  const validated = DetectionIdSchema.parse(detectionId);
  ```
- **Rate Limiting** (ADR-010 Layer 6):
  - `GET /api/detections/[id]/suggestions`: 100 req/min per organization
  - `POST /api/suggestions/[id]/accept`: 50 req/min per organization
  - `POST /api/suggestions/[id]/reject`: 50 req/min per organization
  - Use `@upstash/ratelimit` with Redis (pattern from ADR-010)
- **XSS Prevention**: Sanitize `reasoning` and `factors` text with DOMPurify before display in UI
- Validate `detectionId` and `suggestionId` format (UUID) and existence in DB

**UI Integration Details**:
- Integrate `ai-suggestion-card.tsx` in `detection-details-dialog.tsx`:
  - Position: After Trust Score section, before Actions section (Block/Whitelist buttons)
  - Show suggestion card only if suggestion exists for this detection
  - Badge in `detection-card.tsx`: Variant 'secondary', icon IA, text "Suggestion disponible"
  - Confidence display: Format "85% confiance" with Progress bar (Shadcn Progress component)

**Performance Optimization**:
- Cache suggestion results to avoid re-computation (key: `suggestion:{detectionId}`, TTL: 1h)
- Cache pattern analysis (customer-level) for 30 minutes (key: `pattern:{customerId}`, TTL: 30min)
- Query optimization: Index on `customerId`, `organizationId`, `createdAt` in `fraud_detections` table
- Limit historical query to 90 days (use `gte(fraudDetections.createdAt, subDays(new Date(), 90))`)

**Customer Identifier Strategy**:
- **Primary**: Use `customerId` (Stripe customer ID) from `fraud_detections.customerId` or `customer_trust_scores.customerId`
- **Fallback**: If `customerId` is null/missing, use `customerEmail` to lookup customer
- **Query Pattern**: Always query by `customerId` first, then fallback to `customerEmail` if needed
- **Rationale**: `customerId` is more reliable (unique Stripe ID), but `customerEmail` allows suggestions for new customers without Stripe ID yet

**Query Examples**:
```typescript
// Query successful transactions last 90 days (AC2)
// Uses customerId (primary) or customerEmail (fallback)
import { subDays } from "date-fns";
import { gte, and, eq, or } from "drizzle-orm";

const customerId = detection.customerId; // From fraud_detections
const customerEmail = detection.customerEmail;

const successfulTxns = await db
  .select()
  .from(fraudDetections)
  .where(
    and(
      eq(fraudDetections.organizationId, organizationId),
      customerId 
        ? eq(fraudDetections.customerId, customerId)
        : eq(fraudDetections.customerEmail, customerEmail),
      eq(fraudDetections.decision, 'ALLOW'),
      gte(fraudDetections.createdAt, subDays(new Date(), 90))
    )
  );

// Query blocked transactions last 30 days (AC3)
const blockedTxns = await db
  .select()
  .from(fraudDetections)
  .where(
    and(
      eq(fraudDetections.organizationId, organizationId),
      customerId 
        ? eq(fraudDetections.customerId, customerId)
        : eq(fraudDetections.customerEmail, customerEmail),
      eq(fraudDetections.decision, 'BLOCK'),
      gte(fraudDetections.createdAt, subDays(new Date(), 30))
    )
  );

// Update customer_trust_scores (blacklist action)
// Query by customerId (primary) or customerEmail (fallback)
const customerRecord = await db
  .select()
  .from(customerTrustScores)
  .where(
    and(
      eq(customerTrustScores.organizationId, organizationId),
      customerId
        ? eq(customerTrustScores.customerId, customerId)
        : eq(customerTrustScores.customerEmail, customerEmail)
    )
  )
  .limit(1);

if (customerRecord[0]) {
  await db
    .update(customerTrustScores)
    .set({ status: 'blacklisted', trustScore: 0 })
    .where(eq(customerTrustScores.id, customerRecord[0].id));
}
```

**Confidence Score Calculation**:
- Base confidence on number of matching criteria
- Formula: `confidence = (matchingCriteria / totalCriteria) * patternStrength`
- Example: Whitelist with 4/4 criteria â†’ confidence 0.9, 3/4 criteria â†’ confidence 0.7
- Pattern strength: Card testing pattern = 0.9, chargebacks = 0.8, blocked transactions = 0.7

### Source Tree Context

```
apps/web/
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ ai/
â”‚       â”œâ”€â”€ suggestion-engine.ts        # Pattern analysis & suggestion generation
â”‚       â””â”€â”€ suggestion-cache.ts        # Redis caching logic
â”œâ”€â”€ app/
â”‚   â””â”€â”€ api/
â”‚       â”œâ”€â”€ detections/
â”‚       â”‚   â””â”€â”€ [id]/
â”‚       â”‚       â””â”€â”€ suggestions/
â”‚       â”‚           â””â”€â”€ route.ts        # GET suggestions
â”‚       â””â”€â”€ suggestions/
â”‚           â””â”€â”€ [id]/
â”‚               â”œâ”€â”€ accept/
â”‚               â”‚   â””â”€â”€ route.ts        # POST accept suggestion
â”‚               â””â”€â”€ reject/
â”‚                   â””â”€â”€ route.ts        # POST reject suggestion
â””â”€â”€ components/
    â”œâ”€â”€ ai-suggestion-card.tsx          # Suggestion UI component
    â””â”€â”€ detection-details-dialog.tsx     # Integrate suggestion card
```

---

## Testing

### Unit Tests
- **File**: `apps/web/lib/ai/suggestion-engine.test.ts`
- **Tests**:
  - Whitelist suggestion logic (trust score >80, â‰¥3 successful transactions)
  - Blacklist suggestion logic (fraud patterns, chargebacks)
  - Confidence score calculation
  - Pattern analysis accuracy

### Integration Tests
- **File**: `apps/web/lib/ai/__tests__/suggestion-engine.integration.test.ts`
- **Tests**:
  - Full suggestion flow with real database
  - API endpoints (get, accept, reject)
  - Cache invalidation on actions

### E2E Tests
- **File**: `e2e/ai-suggestions.spec.ts` (Playwright)
- **Tests**:
  - Suggestion appears in detection dialog
  - Accept suggestion â†’ whitelist/blacklist applied
  - Reject suggestion â†’ feedback tracked

### Testing Standards
- Framework: Vitest (unit), Playwright (E2E)
- Coverage target: â‰¥80% for suggestion logic
- Mock historical data for deterministic tests:

**Mock Data Structure - fraud_detections**:
```typescript
// Required: 10+ records with different patterns
const mockFraudDetections = [
  // Whitelist candidates (5+ records)
  {
    id: 'det_001',
    organizationId: 'org_001',
    customerId: 'cus_stripe_001', // Primary identifier
    customerEmail: 'good.customer@example.com',
    paymentIntentId: 'pi_001',
    amount: 5000, // â‚¬50.00
    currency: 'eur',
    decision: 'ALLOW',
    score: 85,
    detectorResults: [],
    executionTimeMs: 120,
    createdAt: subDays(new Date(), 10), // Within 90 days
  },
  // ... 4+ more ALLOW records with different dates (last 90 days)
  
  // Blacklist candidates (2+ records)
  {
    id: 'det_002',
    organizationId: 'org_001',
    customerId: 'cus_stripe_002',
    customerEmail: 'fraud.customer@example.com',
    paymentIntentId: 'pi_002',
    amount: 10000,
    currency: 'eur',
    decision: 'BLOCK',
    score: 25,
    detectorResults: [],
    executionTimeMs: 150,
    createdAt: subDays(new Date(), 5), // Within 30 days
  },
  // ... 1+ more BLOCK records
  
  // Card testing pattern (5+ failed attempts in 1h)
  {
    id: 'det_003',
    organizationId: 'org_001',
    customerId: null, // Missing customerId (test fallback)
    customerEmail: 'test.card@example.com',
    paymentIntentId: 'pi_003',
    amount: 100,
    currency: 'eur',
    decision: 'BLOCK',
    score: 10,
    detectorResults: [],
    executionTimeMs: 100,
    createdAt: subHours(new Date(), 0.5), // Within 1 hour
  },
  // ... 4+ more BLOCK records with same customerEmail, within 1 hour
];
```

**Mock Data Structure - customer_trust_scores**:
```typescript
const mockCustomerTrustScores = [
  // High trust score (whitelist candidate)
  {
    id: 'trust_001',
    organizationId: 'org_001',
    customerId: 'cus_stripe_001',
    customerEmail: 'good.customer@example.com',
    trustScore: 85, // >80
    totalTransactions: 10,
    fraudulentTransactions: 0,
    totalAmountSpent: 50000,
    status: 'normal', // Not already whitelisted
    totalChargebacks: 0,
    lastChargebackDate: null,
    firstSeenAt: subDays(new Date(), 100),
    lastSeenAt: subDays(new Date(), 1),
    updatedAt: subDays(new Date(), 1),
  },
  
  // Low trust score (blacklist candidate)
  {
    id: 'trust_002',
    organizationId: 'org_001',
    customerId: 'cus_stripe_002',
    customerEmail: 'fraud.customer@example.com',
    trustScore: 20, // <30
    totalTransactions: 5,
    fraudulentTransactions: 3,
    totalAmountSpent: 10000,
    status: 'normal', // Not already blacklisted
    totalChargebacks: 2, // â‰¥2 chargebacks
    lastChargebackDate: subDays(new Date(), 15),
    firstSeenAt: subDays(new Date(), 60),
    lastSeenAt: subDays(new Date(), 5),
    updatedAt: subDays(new Date(), 5),
  },
  
  // Already whitelisted (no suggestion)
  {
    id: 'trust_003',
    organizationId: 'org_001',
    customerId: 'cus_stripe_003',
    customerEmail: 'already.whitelisted@example.com',
    trustScore: 90,
    status: 'whitelisted', // Already whitelisted
    // ... other fields
  },
  
  // Already blacklisted (no suggestion)
  {
    id: 'trust_004',
    organizationId: 'org_001',
    customerId: 'cus_stripe_004',
    customerEmail: 'already.blacklisted@example.com',
    trustScore: 0,
    status: 'blacklisted', // Already blacklisted
    // ... other fields
  },
];
```
- Test edge cases:
  - No transaction history (new customer) â†’ No suggestion
  - Conflicting patterns (high trust score but recent chargeback) â†’ No whitelist suggestion
  - Already whitelisted/blacklisted customer (status != 'normal') â†’ No suggestion
  - Customer with status='vip' â†’ No blacklist suggestion
  - Multiple criteria met (blacklist + whitelist) â†’ Blacklist suggestion only (priority)
  - `updateTrustScore()` fails â†’ Error handling, rollback

---

## Validation Report

**Validated by**: Sarah (Product Owner)  
**Validation Date**: 2026-01-26  
**Validation Status**: âœ… **APPROVED - Ready for Implementation**

### Validation Summary

**Template Compliance**: âœ… All required sections present, no placeholders  
**File Structure**: âœ… Clear file paths and source tree context  
**UI Completeness**: âœ… Design specifications added (colors, responsive, accessibility)  
**AC Coverage**: âœ… All 10 acceptance criteria covered by tasks  
**Security**: âœ… Zod validation, rate limiting, XSS prevention (ADR-010 compliant)  
**Task Sequence**: âœ… Logical order with clear dependencies  
**Anti-Hallucination**: âœ… All technical claims verified against codebase  
**Implementation Readiness**: âœ… Self-contained context, clear instructions

### Issues Resolved

**Should-Fix Issues (All Corrected)**:
1. âœ… Customer identifier strategy clarified (customerId primary, customerEmail fallback)
2. âœ… Zod validation schemas added for all API inputs
3. âœ… Rate limiting specified for all endpoints (ADR-010)
4. âœ… UI design specifications added (colors, responsive, accessibility)
5. âœ… Detailed mock data structure provided for tests

**Critical Issues**: None identified

### Final Assessment

- **Implementation Readiness Score**: 9.5/10
- **Confidence Level**: High
- **Recommendation**: Story is ready for development. All technical details are clear, security requirements are met, and test data structures are defined.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-26 | 1.0 | Story created | Sarah (PO) |
| 2026-01-26 | 1.1 | Validation fixes: Added AC6.1, AC9, security section, UI integration details, query examples, confidence formula | Sarah (PO) |
| 2026-01-26 | 1.2 | Should-fix corrections: Clarified customerId vs customerEmail strategy, added Zod validation, rate limiting, UI design specs, detailed mock data structure | Sarah (PO) |
| 2026-01-26 | 1.3 | Validation completed: Story approved and marked as Ready for implementation | Sarah (PO) |
| 2026-01-26 | 2.0 | Implementation: Tasks 1-6 completed, all core functionality implemented | James (Dev) |

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (via Cursor)

### Debug Log References
N/A

### Completion Notes List
- âœ… Created database schema `ai_suggestions` in `packages/database/src/schema/ai-suggestions.ts`
- âœ… Generated migration file: `packages/database/drizzle/0001_hard_puff_adder.sql`
- âœ… Implemented suggestion engine with whitelist/blacklist pattern analysis (AC1, AC2, AC3)
- âœ… Created API endpoints with Zod validation and rate limiting (AC4, AC5, AC6)
- âœ… Implemented UI component with DOMPurify sanitization (AC4, AC5)
- âœ… Integrated suggestion card into detection details dialog (after Trust Score, before Actions)
- âœ… Added caching strategy for performance optimization (AC7)
- âœ… Created unit and integration tests (AC8) - Tests require DB connection for full execution
- âš ï¸ Note: Badge in detection-card.tsx requires API modification to include hasSuggestion flag (deferred - not critical for MVP)
- âš ï¸ Note: Migration needs to be applied to database (run `drizzle-kit push` or apply migration file `packages/database/drizzle/0001_hard_puff_adder.sql`)
- âœ… All core functionality implemented: suggestion engine, API endpoints, UI component, caching
- âœ… Code compiles without errors (TypeScript validation passed)
- âš ï¸ Tests require DATABASE_URL environment variable to run (integration tests need real DB)

### File List
**Created:**
- `packages/database/src/schema/ai-suggestions.ts` - Database schema for AI suggestions
- `apps/web/lib/ai/suggestion-engine.ts` - Pattern analysis and suggestion generation
- `apps/web/lib/ai/suggestion-cache.ts` - Redis caching for suggestions
- `apps/web/lib/validation/ai-suggestions.ts` - Zod validation schemas
- `apps/web/lib/rate-limit.ts` - Rate limiters for AI endpoints
- `apps/web/app/api/detections/[id]/suggestions/route.ts` - GET suggestions endpoint
- `apps/web/app/api/suggestions/[id]/accept/route.ts` - POST accept suggestion endpoint
- `apps/web/app/api/suggestions/[id]/reject/route.ts` - POST reject suggestion endpoint
- `apps/web/components/ai-suggestion-card.tsx` - UI component for suggestions
- `apps/web/lib/ai/suggestion-engine.test.ts` - Unit tests for suggestion engine
- `apps/web/lib/ai/__tests__/suggestion-engine.integration.test.ts` - Integration tests for suggestion engine
- `apps/web/app/api/detections/[id]/suggestions/__tests__/route.integration.test.ts` - Integration tests for GET suggestions endpoint
- `packages/database/drizzle/0001_hard_puff_adder.sql` - Database migration for ai_suggestions table

**Modified:**
- `packages/database/src/schema/index.ts` - Added export for ai-suggestions
- `apps/web/components/detection-details-dialog.tsx` - Integrated AI suggestion card (after Trust Score section, before Actions)
- `apps/web/package.json` - Added dependencies: @upstash/ratelimit@2.0.8, isomorphic-dompurify@2.35.0

---

## QA Results

(To be populated by QA agent after testing)
