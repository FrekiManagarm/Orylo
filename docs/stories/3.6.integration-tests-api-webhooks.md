# Story 3.6: Integration Tests - API & Webhooks

**Epic**: Epic 3 - Integration & Production Readiness  
**Story Points**: 5  
**Status**: Draft

---

## Story

**As a** development team,  
**I want** comprehensive integration tests for API and webhooks,  
**so that** we catch integration bugs before production.

---

## Acceptance Criteria

1. **AC1**: Test setup avec test database (Neon branch or SQLite)
2. **AC2**: Integration test: POST /api/webhooks/stripe (valid, duplicate, invalid sig)
3. **AC3**: Integration test: GET /api/detections (filters, pagination)
4. **AC4**: Integration test: POST /api/customers/[id]/block
5. **AC5**: Integration test: Trust score update flow
6. **AC6**: Test coverage integration (≥60% apps/web/app/api/**)
7. **AC7**: CI/CD integration (GitHub Actions)

---

## Tasks / Subtasks

- [ ] Setup test database (Neon branch or in-memory SQLite)
- [ ] Integration test: Webhook valid signature → Processing
- [ ] Integration test: Webhook duplicate event → Idempotency
- [ ] Integration test: Webhook invalid signature → 400 error
- [ ] Integration test: GET /api/detections with filters
- [ ] Integration test: POST /api/customers/[id]/block → DB update
- [ ] Integration test: Trust score update after detection
- [ ] Coverage report: ≥60% for app/api/**
- [ ] GitHub Actions: Run integration tests on PR

---

## Dev Notes

**Test Database Setup**:
```typescript
// vitest.config.ts
export default defineConfig({
  test: {
    setupFiles: ['./test/setup.ts'],
  },
});

// test/setup.ts
import { beforeAll, afterAll } from 'vitest';
import { sql } from 'drizzle-orm';

beforeAll(async () => {
  // Use test database
  process.env.DATABASE_URL = 'postgresql://test:test@localhost:5432/orylo_test';
  await db.execute(sql`TRUNCATE TABLE fraud_detections, customer_trust_scores CASCADE`);
});

afterAll(async () => {
  await db.execute(sql`DROP DATABASE orylo_test`);
});
```

**Integration Test Example**:
```typescript
// app/api/webhooks/stripe/__tests__/route.integration.test.ts
import { describe, it, expect } from 'vitest';

describe('POST /api/webhooks/stripe', () => {
  it('processes valid webhook', async () => {
    const payload = createTestWebhook();
    const signature = signWebhook(payload);

    const response = await fetch('/api/webhooks/stripe', {
      method: 'POST',
      body: payload,
      headers: { 'stripe-signature': signature },
    });

    expect(response.status).toBe(200);
    
    // Verify detection created in DB
    const detections = await db.select().from(fraudDetections).limit(1);
    expect(detections.length).toBe(1);
  });

  it('rejects duplicate event (idempotency)', async () => {
    // Send same event twice
    await sendWebhook(event);
    const response = await sendWebhook(event); // Duplicate

    expect(response.status).toBe(200);
    
    // Verify only 1 detection in DB
    const detections = await db.select().from(fraudDetections);
    expect(detections.length).toBe(1);
  });
});
```

**GitHub Actions**:
```yaml
# .github/workflows/test.yml
name: Integration Tests
on: [pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: oven-sh/setup-bun@v1
      - run: bun install
      - run: bun run test:integration
      - run: bun run test:coverage
```

---

## Testing

- All integration tests pass
- Coverage report: ≥60%

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-13 | 1.0 | Story created | Sarah (PO) |
