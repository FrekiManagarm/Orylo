# Story 3.5: Security & Compliance (GDPR, PCI)

**Epic**: Epic 3 - Integration & Production Readiness  
**Story Points**: 3  
**Status**: Draft

---

## Story

**As a** compliant platform,  
**I want** GDPR and PCI compliance implementations,  
**so that** we meet legal and security requirements.

---

## Acceptance Criteria

1. **AC1**: Data retention policy implementation (delete >90 days)
2. **AC2**: Right to deletion API (DELETE /api/customers/[id])
3. **AC3**: Data export API (GET /api/customers/[id]/export)
4. **AC4**: PCI compliance verification (no full card numbers)
5. **AC5**: HTTPS only enforcement (Vercel automatic)
6. **AC6**: Environment variables security (.env.local gitignored)
7. **AC7**: Session security (Better Auth secure cookies)
8. **AC8**: Privacy policy page (/app/privacy/page.tsx)

---

## Tasks / Subtasks

- [ ] Cron job: Delete fraud_detections older than 90 days
- [ ] API endpoint: DELETE /api/customers/[id] (cascade delete)
- [ ] API endpoint: GET /api/customers/[id]/export (JSON export)
- [ ] Verify no full card numbers stored (only last4 + country)
- [ ] Vercel HTTPS enforcement (automatic)
- [ ] Ensure .env.local gitignored, use .env.example
- [ ] Better Auth secure cookies (httpOnly, secure, sameSite)
- [ ] Privacy policy page with GDPR disclosures

---

## Dev Notes

**Data Retention Cron** (Trigger.dev):
```typescript
// jobs/data-retention.ts
export const dataRetentionJob = client.defineJob({
  id: 'data-retention',
  name: 'Delete old fraud detections',
  version: '1.0.0',
  trigger: cronTrigger({ cron: '0 2 * * *' }), // Daily at 2am
  run: async () => {
    const ninetyDaysAgo = new Date();
    ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);

    await db.delete(fraudDetections)
      .where(lt(fraudDetections.createdAt, ninetyDaysAgo));
  },
});
```

**Right to Deletion**:
```typescript
// DELETE /api/customers/[id]
export async function DELETE(request: Request, { params }: { params: { id: string } }) {
  const customerId = params.id;

  // Cascade delete
  await db.delete(fraudDetections).where(eq(fraudDetections.customerId, customerId));
  await db.delete(customerTrustScores).where(eq(customerTrustScores.customerId, customerId));

  return Response.json({ deleted: true });
}
```

**Data Export**:
```typescript
// GET /api/customers/[id]/export
export async function GET(request: Request, { params }: { params: { id: string } }) {
  const customerId = params.id;

  const detections = await db.select().from(fraudDetections)
    .where(eq(fraudDetections.customerId, customerId));
  
  const trustScore = await db.select().from(customerTrustScores)
    .where(eq(customerTrustScores.customerId, customerId))
    .limit(1);

  return Response.json({ detections, trustScore: trustScore[0] });
}
```

**PCI Compliance**:
- ✅ No full card numbers stored
- ✅ Only Stripe tokens (pi_xxx, cus_xxx)
- ✅ Card last4 + country (non-sensitive)

---

## Testing

- Integration: Data retention job deletes old records
- Integration: DELETE /api/customers/[id] cascade deletes

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-13 | 1.0 | Story created | Sarah (PO) |
