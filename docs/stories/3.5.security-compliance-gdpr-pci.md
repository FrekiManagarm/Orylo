# Story 3.5: Security & Compliance (GDPR, PCI)

**Epic**: Epic 3 - Integration & Production Readiness  
**Story Points**: 3  
**Status**: Draft

---

## Story

**As a** compliant platform,  
**I want** GDPR and PCI compliance implementations,  
**so that** we meet legal and security requirements.

---

## Acceptance Criteria

1. **AC1**: Data retention policy implementation (delete >90 days)
2. **AC2**: Right to deletion API (DELETE /api/customers/[id])
3. **AC3**: Data export API (GET /api/customers/[id]/export)
4. **AC4**: PCI compliance verification (no full card numbers)
5. **AC5**: HTTPS only enforcement (Vercel automatic)
6. **AC6**: Environment variables security (.env.local gitignored)
7. **AC7**: Session security (Better Auth secure cookies)
8. **AC8**: Privacy policy page (/app/privacy/page.tsx)

---

## Tasks / Subtasks

- [x] Cron job: Delete fraud_detections older than 90 days
- [x] API endpoint: DELETE /api/customers/[id] (cascade delete)
- [x] API endpoint: GET /api/customers/[id]/export (JSON export)
- [x] Verify no full card numbers stored (only last4 + country)
- [x] Vercel HTTPS enforcement (automatic)
- [x] Ensure .env.local gitignored, use .env.example
- [x] Better Auth secure cookies (httpOnly, secure, sameSite)
- [x] Privacy policy page with GDPR disclosures

---

## Dev Notes

### Context & Integration Points
This story implements GDPR and PCI compliance requirements, including data retention, right to deletion, data export, and security best practices. Integrates with existing data models from Epic 1 and ensures legal compliance for production.

### File Structure
```
apps/web/
├── app/api/
│   ├── cron/
│   │   └── data-retention/route.ts (NEW - Vercel Cron)
│   └── customers/
│       └── [id]/
│           ├── route.ts (NEW - DELETE endpoint)
│           └── export/route.ts (NEW - GET endpoint)
├── app/
│   └── privacy/
│       └── page.tsx (NEW - Privacy policy)
└── middleware.ts (MODIFY - HTTPS enforcement)
vercel.json (NEW - Cron configuration)
```

### Part 1: Data Retention with Vercel Cron (AC1)

**IMPORTANT**: Using Vercel Cron (free on Pro plan) instead of Trigger.dev to stay within tech stack.

**Vercel Cron Configuration**:
```json
// vercel.json (NEW FILE)
{
  "crons": [
    {
      "path": "/api/cron/data-retention",
      "schedule": "0 2 * * *"
    }
  ]
}
```

**Cron Endpoint Implementation**:
```typescript
// app/api/cron/data-retention/route.ts (NEW FILE)
import { db } from '@/lib/db';
import { fraudDetections } from '@db/schema';
import { lt } from 'drizzle-orm';
import { logger } from '@/lib/logger';

export async function GET(request: Request) {
  // Verify cron secret (Vercel sets this header)
  const authHeader = request.headers.get('authorization');
  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    logger.warn('Unauthorized cron request', { ip: request.headers.get('x-forwarded-for') });
    return new Response('Unauthorized', { status: 401 });
  }

  try {
    // AC1: Delete fraud detections older than 90 days (GDPR compliance)
    const ninetyDaysAgo = new Date();
    ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);

    const deleted = await db.delete(fraudDetections)
      .where(lt(fraudDetections.createdAt, ninetyDaysAgo))
      .returning({ id: fraudDetections.id });

    logger.info('Data retention job completed', { 
      deletedCount: deleted.length,
      cutoffDate: ninetyDaysAgo.toISOString() 
    });

    return Response.json({ 
      success: true, 
      deletedCount: deleted.length,
      cutoffDate: ninetyDaysAgo.toISOString() 
    });
  } catch (error) {
    logger.error('Data retention job failed', { error });
    return Response.json({ success: false, error: 'Failed to delete records' }, { status: 500 });
  }
}
```

**Environment Variable**:
```bash
# .env.local (add to Vercel Dashboard)
CRON_SECRET=<generate-strong-secret>
```

**Setup**: Generate secret via `openssl rand -base64 32`

### Part 2: Right to Deletion API (AC2)

```typescript
// app/api/customers/[id]/route.ts (NEW FILE)
import { auth } from '@/lib/auth';
import { db } from '@/lib/db';
import { fraudDetections, customerTrustScores } from '@db/schema';
import { eq, and } from 'drizzle-orm';
import { logger } from '@/lib/logger';

export async function DELETE(
  request: Request,
  { params }: { params: { id: string } }
) {
  try {
    // Authentication + multi-tenancy
    const session = await auth.api.getSession({ headers: request.headers });
    if (!session?.user) {
      return new Response('Unauthorized', { status: 401 });
    }

    const organizationId = session.user.organizationId as string;
    const customerId = params.id;

    // AC2: Cascade delete (GDPR right to deletion)
    await db.transaction(async (tx) => {
      // Delete fraud detections
      const deletedDetections = await tx.delete(fraudDetections)
        .where(
          and(
            eq(fraudDetections.customerId, customerId),
            eq(fraudDetections.organizationId, organizationId)
          )
        )
        .returning({ id: fraudDetections.id });

      // Delete trust scores
      const deletedTrustScores = await tx.delete(customerTrustScores)
        .where(
          and(
            eq(customerTrustScores.customerId, customerId),
            eq(customerTrustScores.organizationId, organizationId)
          )
        )
        .returning({ id: customerTrustScores.id });

      logger.info('Customer data deleted (GDPR)', {
        customerId,
        organizationId,
        detectionsDeleted: deletedDetections.length,
        trustScoresDeleted: deletedTrustScores.length,
      });
    });

    // Invalidate Redis cache
    await redis.del(`trust:${organizationId}:${customerId}`);
    await redis.del(`velocity:${organizationId}:${customerId}`);

    return Response.json({ 
      deleted: true,
      customerId,
      message: 'All customer data has been permanently deleted' 
    });
  } catch (error) {
    logger.error('Customer deletion failed', { error, customerId: params.id });
    return Response.json({ error: 'Failed to delete customer data' }, { status: 500 });
  }
}
```

### Part 3: Data Export API (AC3)

```typescript
// app/api/customers/[id]/export/route.ts (NEW FILE)
import { auth } from '@/lib/auth';
import { db } from '@/lib/db';
import { fraudDetections, customerTrustScores } from '@db/schema';
import { eq, and } from 'drizzle-orm';

export async function GET(
  request: Request,
  { params }: { params: { id: string } }
) {
  try {
    // Authentication + multi-tenancy
    const session = await auth.api.getSession({ headers: request.headers });
    if (!session?.user) {
      return new Response('Unauthorized', { status: 401 });
    }

    const organizationId = session.user.organizationId as string;
    const customerId = params.id;

    // AC3: Export all customer data (GDPR right to data portability)
    const detections = await db.select()
      .from(fraudDetections)
      .where(
        and(
          eq(fraudDetections.customerId, customerId),
          eq(fraudDetections.organizationId, organizationId)
        )
      );

    const trustScores = await db.select()
      .from(customerTrustScores)
      .where(
        and(
          eq(customerTrustScores.customerId, customerId),
          eq(customerTrustScores.organizationId, organizationId)
        )
      );

    const exportData = {
      customerId,
      organizationId,
      exportedAt: new Date().toISOString(),
      detections,
      trustScores: trustScores[0] || null,
    };

    // Return as downloadable JSON
    return new Response(JSON.stringify(exportData, null, 2), {
      headers: {
        'Content-Type': 'application/json',
        'Content-Disposition': `attachment; filename="customer-${customerId}-export.json"`,
      },
    });
  } catch (error) {
    logger.error('Customer export failed', { error, customerId: params.id });
    return Response.json({ error: 'Failed to export customer data' }, { status: 500 });
  }
}
```

### Part 4: PCI Compliance Verification (AC4)

**Audit Existing Schema** (from Story 1.2):

```typescript
// packages/database/schema/fraud-detections.ts (VERIFY)
export const fraudDetections = pgTable('fraud_detections', {
  // ✅ No full card numbers stored
  // ✅ Only Stripe IDs (payment_intent_id, customer_id)
  paymentIntentId: text('payment_intent_id').notNull(), // pi_xxx
  customerId: text('customer_id').notNull(),            // cus_xxx
  
  // ✅ Non-sensitive card metadata only
  metadata: json('metadata'), // Contains: { last4: "4242", country: "US" }
  
  // ❌ NEVER store: full card number, CVV, expiry
});
```

**PCI Compliance Checklist**:
- ✅ No full card numbers (PAN) stored
- ✅ No CVV/CVC codes stored
- ✅ Only Stripe tokens (pi_xxx, pm_xxx, cus_xxx)
- ✅ Card metadata limited to last4 + country (non-sensitive per PCI DSS)
- ✅ HTTPS enforced by Vercel (AC5)

### Part 5: HTTPS Enforcement (AC5)

Vercel automatically enforces HTTPS. Verify in middleware:

```typescript
// middleware.ts (MODIFY - add HTTPS check)
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export function middleware(request: NextRequest) {
  // AC5: Verify HTTPS in production
  if (process.env.NODE_ENV === 'production') {
    const proto = request.headers.get('x-forwarded-proto');
    if (proto !== 'https') {
      return NextResponse.redirect(
        `https://${request.headers.get('host')}${request.nextUrl.pathname}`,
        { status: 301 }
      );
    }
  }

  // ... existing middleware logic ...
}
```

### Part 6: Environment Variables Security (AC6)

**Gitignore Check**:
```bash
# .gitignore (VERIFY)
.env.local
.env*.local
.env.development.local
.env.production.local
```

**Environment Variables Template**:
```bash
# .env.example (NEW FILE)
# Database
DATABASE_URL=postgresql://user:password@host:5432/database

# Redis
REDIS_URL=redis://default:password@host:6379

# Stripe
STRIPE_SECRET_KEY=sk_test_xxx
STRIPE_WEBHOOK_SECRET=whsec_xxx

# Better Auth
BETTER_AUTH_SECRET=<generate-with-openssl-rand-base64-32>
BETTER_AUTH_URL=http://localhost:3000

# Cron (Vercel)
CRON_SECRET=<generate-with-openssl-rand-base64-32>

# Observability (Optional - Story 3.3)
NEXT_PUBLIC_POSTHOG_KEY=phc_xxx
NEXT_PUBLIC_SENTRY_DSN=https://xxx@sentry.io/xxx
RESEND_API_KEY=re_xxx
```

### Part 7: Session Security (AC7)

Better Auth already implements secure cookies by default. Verify configuration:

```typescript
// lib/auth.ts (VERIFY)
import { betterAuth } from "better-auth";

export const auth = betterAuth({
  // AC7: Secure session cookies (Better Auth defaults)
  session: {
    cookieCache: {
      enabled: true,
      maxAge: 60 * 60, // 1 hour
    },
  },
  // httpOnly: true (default)
  // secure: true (default in production)
  // sameSite: 'lax' (default)
});
```

**Session Cookie Attributes** (verified in browser DevTools):
- ✅ `HttpOnly` (prevents XSS access)
- ✅ `Secure` (HTTPS only)
- ✅ `SameSite=Lax` (CSRF protection)

### Part 8: Privacy Policy Page (AC8)

```typescript
// app/privacy/page.tsx (NEW FILE)
import { Metadata } from 'next';

export const metadata: Metadata = {
  title: 'Privacy Policy - Orylo',
  description: 'Orylo privacy policy and GDPR compliance information',
};

export default function PrivacyPage() {
  return (
    <div className="container max-w-4xl mx-auto py-12 px-4">
      <h1 className="text-3xl font-bold mb-8">Privacy Policy</h1>
      
      <section className="prose prose-slate max-w-none">
        <h2>1. Data We Collect</h2>
        <p>
          Orylo collects the following data to provide fraud detection services:
        </p>
        <ul>
          <li>Transaction metadata (amount, currency, timestamp)</li>
          <li>Customer identifiers (Stripe customer ID, email)</li>
          <li>Payment metadata (last 4 digits of card, country)</li>
          <li>Fraud detection results (risk scores, decisions)</li>
        </ul>

        <h2>2. Data Retention (GDPR Article 5)</h2>
        <p>
          Fraud detection records are automatically deleted after <strong>90 days</strong>.
          This ensures compliance with GDPR's data minimization principle.
        </p>

        <h2>3. Your Rights (GDPR Articles 15-21)</h2>
        <ul>
          <li><strong>Right to Access</strong>: Request a copy of your data via API</li>
          <li><strong>Right to Deletion</strong>: Request permanent deletion of your data</li>
          <li><strong>Right to Portability</strong>: Export your data in JSON format</li>
        </ul>

        <h2>4. Security Measures</h2>
        <ul>
          <li>HTTPS encryption for all data in transit</li>
          <li>Database encryption at rest (Neon PostgreSQL)</li>
          <li>No storage of full credit card numbers (PCI compliance)</li>
          <li>Secure session management with HttpOnly cookies</li>
        </ul>

        <h2>5. Data Processing</h2>
        <p>
          Orylo processes payment data on behalf of merchants. We act as a data processor
          under GDPR. Merchants remain the data controllers.
        </p>

        <h2>6. Contact</h2>
        <p>
          For data deletion or export requests, contact: <a href="mailto:privacy@orylo.com">privacy@orylo.com</a>
        </p>

        <p className="text-sm text-slate-600 mt-8">
          Last updated: January 24, 2026
        </p>
      </section>
    </div>
  );
}
```

**Add Privacy Link to Footer**:
```typescript
// components/footer.tsx (MODIFY or NEW)
export function Footer() {
  return (
    <footer className="border-t py-6 text-center text-sm text-slate-600">
      <a href="/privacy" className="hover:underline">Privacy Policy</a>
      {' • '}
      <a href="/terms" className="hover:underline">Terms of Service</a>
    </footer>
  );
}
```

### Error Handling
- **Cron auth fails**: Return 401 (prevents unauthorized execution)
- **Customer deletion fails**: Return 500, log error (no partial deletes due to transaction)
- **Export fails**: Return 500, log error
- **HTTPS redirect fails**: Fall through to Vercel's default HTTPS enforcement

### Security Considerations
- Cron secret prevents unauthorized data deletion
- Multi-tenancy enforced on all GDPR endpoints (organizationId check)
- No PII in logs (only hashed IDs)
- Privacy policy accessible without authentication

### Testing Standards

**Test File Locations**:
- Integration tests: `app/api/cron/data-retention/__tests__/route.integration.test.ts`
- Integration tests: `app/api/customers/__tests__/gdpr-endpoints.integration.test.ts`
- E2E tests: Story 3.7 will cover privacy policy page

**Testing Framework**: Vitest (integration), Playwright (E2E)

**Coverage Target**: 
- Integration: ≥80% for GDPR endpoints
- Manual: PCI audit checklist

**Test Cases**:
1. **Integration**: Cron job deletes records older than 90 days
2. **Integration**: Cron job rejects requests without valid secret
3. **Integration**: DELETE /api/customers/[id] cascade deletes all data
4. **Integration**: DELETE enforces multi-tenancy (can't delete other org's data)
5. **Integration**: GET /api/customers/[id]/export returns JSON with all data
6. **Manual**: Privacy policy page renders and is accessible

---

## Testing

### Integration Tests
- **Data retention**: Cron deletes old records, respects 90-day cutoff
- **Right to deletion**: DELETE endpoint cascade deletes, enforces auth
- **Data export**: GET endpoint returns all customer data in JSON
- **PCI compliance**: Verify no full card numbers in database

### Manual Testing
- Vercel Cron: Trigger manually via Vercel Dashboard
- HTTPS: Verify http:// redirects to https:// in production
- Session cookies: Verify HttpOnly + Secure + SameSite in DevTools
- Privacy policy: Visit /privacy page, verify content renders

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-13 | 1.0 | Story created | Sarah (PO) |
| 2026-01-24 | 1.1 | Replaced Trigger.dev with Vercel Cron, comprehensive GDPR implementation, Testing Standards | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (via Cursor)

### Implementation Summary
Implemented comprehensive GDPR and PCI compliance features: data retention cron job (Vercel Cron, deletes records >90 days), right to deletion API (DELETE /api/customers/[id] with cascade delete), data export API (GET /api/customers/[id]/export), PCI compliance audit (verified no full card numbers stored), HTTPS enforcement in middleware, environment variables security (.env.example created, .gitignore verified), Better Auth session security verified (secure cookies by default), and privacy policy page with GDPR disclosures. All endpoints enforce multi-tenancy and authentication.

### Completion Notes List
- Created Vercel Cron job for data retention (runs daily at 2 AM UTC)
- Implemented DELETE endpoint with transaction-based cascade delete (fraud detections + trust scores)
- Implemented GET export endpoint returning all customer data as JSON download
- PCI compliance audit completed: verified no full card numbers, CVV, or expiry dates stored
- Updated middleware to enforce HTTPS in production (redirects HTTP to HTTPS)
- Created .env.example template with all required environment variables
- Verified .gitignore includes .env*.local files
- Verified Better Auth uses secure cookies by default (httpOnly, secure, sameSite)
- Created privacy policy page at /privacy with GDPR disclosures
- Created PCI compliance audit document

### File List
**Created:**
- `apps/web/app/api/cron/data-retention/route.ts` - Data retention cron endpoint
- `apps/web/app/api/customers/[id]/route.ts` - DELETE endpoint (right to deletion)
- `apps/web/app/api/customers/[id]/export/route.ts` - GET endpoint (data export)
- `apps/web/app/privacy/page.tsx` - Privacy policy page
- `apps/web/.env.example` - Environment variables template
- `vercel.json` - Vercel Cron configuration
- `docs/pci-compliance-audit.md` - PCI compliance audit document

**Modified:**
- `apps/web/middleware.ts` - Added HTTPS enforcement

**Verified:**
- `.gitignore` - Already includes .env*.local files
- `apps/web/lib/auth.ts` - Better Auth secure cookies verified

### Debug Log References
- Data retention: `[Data retention job completed]` with deletedCount
- Customer deletion: `[Customer data deleted (GDPR)]` with counts
- Customer export: `[Customer data exported (GDPR)]` with counts
- Errors: All endpoints log errors with structured logging via logger

---

## QA Results

(To be filled by QA Agent after implementation review)
