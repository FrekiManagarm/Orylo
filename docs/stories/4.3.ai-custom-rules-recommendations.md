# Story 4.3: Recommandations de RÃ¨gles Custom PersonnalisÃ©es

**Epic**: Epic 4 - SystÃ¨me de DÃ©cisions AssistÃ© par IA  
**Story Points**: 8  
**Status**: ðŸ“‹ Draft

---

## Story

**As a** merchant,  
**I want** AI to suggest optimal custom rules based on my business context and transaction history,  
**so that** I can configure protection tailored to my specific needs without manual analysis.

---

## Acceptance Criteria

1. **AC1**: AI analyzes merchant's transaction patterns from `fraud_detections` table (last 90 days, filter by `organizationId`): amounts, frequencies (transactions/hour), geolocations (IP country vs card country)
2. **AC2**: AI identifies common fraud patterns: unusual amounts (>2x or <0.1x average), geo mismatches (IPâ‰ card country), velocity spikes (>10 tx/hour), card testing patterns
3. **AC3**: Suggestions include: rule conditions compatible with `custom_rules` table format (field, operator, value) - amount thresholds, velocity limits, geo restrictions
4. **AC4**: Suggestions displayed in Settings page (`/app/(authenticated)/settings/custom-rules/page.tsx`) with "Apply Rule" button, confidence score, reasoning
5. **AC5**: Merchant can preview rule impact before applying: simulate rule on last 30 days of transactions, show estimated blocks, false positives, true positives
6. **AC6**: Applied rules tracked for effectiveness: link `ai_rule_recommendations.customRuleId` to `custom_rules.id`, calculate success rate (true positives - false positives) / total blocks
7. **AC7**: Performance: Recommendations generated <1s (cached analysis in Redis, key: `recommendations:{organizationId}`, TTL: 24h)
8. **AC8**: Integration test: Verify recommendation logic with merchant-specific data (mock `fraud_detections` records for test organization)

---

## Tasks / Subtasks

- [ ] **Task 1**: Create rule recommendation engine (AC1, AC2, AC3)
  - [ ] Create `lib/ai/rule-recommendation-engine.ts`
  - [ ] Query `fraud_detections` table for merchant's transactions (last 90 days, filter by `organizationId`)
  - [ ] Calculate statistics: average amount, amount distribution (min/max/median), geo patterns (countries), velocity patterns (transactions per hour)
  - [ ] Identify fraud patterns:
    - [ ] Unusual amounts: transactions >2x average or <0.1x average
    - [ ] Geo mismatches: IP country â‰  card country (from `fraud_detections` metadata)
    - [ ] Velocity spikes: >10 transactions/hour from same customer
  - [ ] Generate rule suggestions: amount thresholds, velocity limits, geo restrictions
  - [ ] Return recommendations with confidence score (0-1) based on pattern strength

- [ ] **Task 2**: Database schema for rule recommendations (AC4, AC6)
  - [ ] Create `ai_rule_recommendations` table migration (Drizzle)
  - [ ] Fields: `id`, `organizationId`, `ruleSuggestion` (JSON), `confidence`, `applied`, `effectiveness`, `createdAt`
  - [ ] Link to `custom_rules` table when applied

- [ ] **Task 3**: API endpoint for recommendations (AC4, AC5)
  - [ ] Create `GET /api/organizations/[id]/rule-recommendations` endpoint
  - [ ] Return recommendations with confidence score and preview impact
  - [ ] Create `POST /api/rule-recommendations/[id]/apply` endpoint
    - [ ] Create `custom_rules` record with recommended condition/action/scoreModifier
    - [ ] Link `ai_rule_recommendations.customRuleId` to created rule
    - [ ] Set `ai_rule_recommendations.applied=true`
  - [ ] Create `POST /api/rule-recommendations/[id]/preview` endpoint (simulate impact)

- [ ] **Task 4**: Rule impact preview (AC5)
  - [ ] Create `lib/ai/rule-impact-simulator.ts`
  - [ ] Simulate rule on historical transactions (last 30 days)
  - [ ] Calculate: estimated blocks, false positives, true positives
  - [ ] Return preview metrics: "Would block X transactions, prevent Y frauds"

- [ ] **Task 5**: UI component for recommendations (AC4, AC5)
  - [ ] Create `components/ai-rule-recommendation-card.tsx` component
  - [ ] Display rule suggestion, confidence score, preview impact
  - [ ] Add "Preview Impact" and "Apply Rule" buttons
  - [ ] Create Settings page section: `/app/settings/custom-rules`
  - [ ] Show recommendation list with accept/reject actions

- [ ] **Task 6**: Rule effectiveness tracking (AC6)
  - [ ] Track applied rules performance (blocks, false positives, true positives)
  - [ ] Calculate success rate: (true positives - false positives) / total blocks
  - [ ] Update `ai_rule_recommendations.effectiveness` field
  - [ ] Show effectiveness metrics in Settings page

- [ ] **Task 7**: Caching strategy (AC7)
  - [ ] Cache recommendation analysis (key: `recommendations:{organizationId}`, TTL: 24h)
  - [ ] Cache transaction statistics (key: `stats:{organizationId}`, TTL: 1h)
  - [ ] Invalidate cache on new transactions or rule changes

- [ ] **Task 8**: Integration tests (AC8)
  - [ ] Test recommendation generation with merchant-specific data
  - [ ] Test rule impact preview simulation
  - [ ] Test API endpoints (get, apply, preview)
  - [ ] Test effectiveness tracking

---

## Dependencies

**Depends on**:
- Epic 1: `custom_rules` table, `fraud_detections` table, custom rules engine (`lib/fraud/custom-rules.ts`)
- Epic 2: Settings page structure (`/app/(authenticated)/settings/stripe/page.tsx`)
- Epic 3: Redis cache configured

**Blocks**:
- Story 4.4: Feedback tracking can track rule recommendation acceptance (optional enhancement)

**Can be developed in parallel with**:
- Story 4.1 (Suggestions) - no shared dependencies
- Story 4.2 (AI explanations) - no shared dependencies

---

## Dev Notes

### Relevant Architecture

**Rule Recommendation Logic**:
```typescript
interface MerchantTransactionStats {
  organizationId: string;
  averageAmount: number;
  amountDistribution: { min: number; max: number; median: number };
  geoPatterns: { country: string; count: number }[];
  velocityPatterns: { hour: number; count: number }[];
  fraudPatterns: {
    unusualAmounts: number[];
    geoMismatches: number;
    velocitySpikes: number;
  };
}

interface RuleRecommendation {
  type: 'amount_threshold' | 'velocity_limit' | 'geo_restriction';
  condition: {
    // Format compatible with custom_rules.condition (JSON)
    field: string; // 'amount', 'velocity', 'ipCountry', etc.
    operator: '>' | '<' | '=' | '!=' | 'IN' | 'NOT_IN';
    value: number | string | string[];
  };
  action: 'BLOCK' | 'REVIEW' | 'ALLOW'; // Compatible with custom_rules.action
  scoreModifier: number; // Compatible with custom_rules.scoreModifier
  confidence: number; // 0-1
  reasoning: string;
  estimatedImpact: {
    blocks: number;
    falsePositives: number;
    truePositives: number;
  };
}
```

**Recommendation Examples**:
- **Amount Threshold**: 
  ```json
  {
    "name": "Block high-amount transactions",
    "condition": { "field": "amount", "operator": ">", "value": 50000 },
    "action": "BLOCK",
    "scoreModifier": 0
  }
  ```
- **Velocity Limit**: 
  ```json
  {
    "name": "Block card testing (high velocity)",
    "condition": { "field": "velocity", "operator": ">", "value": 10 },
    "action": "BLOCK",
    "scoreModifier": 0
  }
  ```
- **Geo Restriction**: 
  ```json
  {
    "name": "Block suspicious countries",
    "condition": { "field": "ipCountry", "operator": "IN", "value": ["XX", "YY"] },
    "action": "BLOCK",
    "scoreModifier": 0
  }
  ```

**Database Schema**:
```typescript
// packages/database/src/schema/ai-rule-recommendations.ts
import { pgTable, text, timestamp, boolean, real, jsonb } from "drizzle-orm/pg-core";
import { organizations } from "./organizations";
import { customRules } from "./custom-rules";

export const aiRuleRecommendations = pgTable('ai_rule_recommendations', {
  id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),
  organizationId: text('organization_id')
    .notNull()
    .references(() => organizations.id, { onDelete: 'cascade' }),
  ruleSuggestion: jsonb('rule_suggestion').notNull(), // RuleRecommendation (condition, action, scoreModifier, etc.)
  confidence: real('confidence').notNull(), // 0-1
  applied: boolean('applied').default(false).notNull(),
  customRuleId: text('custom_rule_id')
    .references(() => customRules.id, { onDelete: 'set null' }), // If applied, link to custom_rules
  effectiveness: real('effectiveness'), // Success rate after application (0-1)
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

// Indexes
export const aiRuleRecommendationsIndexes = {
  organizationId: index('ai_rule_recommendations_organization_id_idx').on(aiRuleRecommendations.organizationId),
  applied: index('ai_rule_recommendations_applied_idx').on(aiRuleRecommendations.applied),
};
```

**Integration Points**:
- Uses existing `custom_rules` table (Epic 1) - See `packages/database/src/schema/custom-rules.ts`
- Uses existing `fraud_detections` table for analysis (Epic 1) - Query by `organizationId`, `createdAt`, `decision`
- Integrates with Settings page (Epic 2) - Route: `/app/(authenticated)/settings/stripe/page.tsx` (extend or create new `/settings/custom-rules`)
- Uses Redis cache (Epic 3) - Cache key: `recommendations:{organizationId}`, TTL: 24h
- Uses existing custom rules engine from `lib/fraud/custom-rules.ts` (Epic 1) - Apply recommended rules via same engine

**Performance Optimization**:
- Cache recommendation analysis (24h TTL) - recalculate daily
- Cache transaction statistics (1h TTL)
- Background job to pre-compute recommendations (Trigger.dev scheduled job)

### Source Tree Context

```
apps/web/
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ ai/
â”‚       â”œâ”€â”€ rule-recommendation-engine.ts    # Recommendation generation
â”‚       â”œâ”€â”€ rule-impact-simulator.ts          # Impact preview
â”‚       â””â”€â”€ merchant-stats-analyzer.ts        # Transaction pattern analysis
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ organizations/
â”‚   â”‚   â”‚   â””â”€â”€ [id]/
â”‚   â”‚   â”‚       â””â”€â”€ rule-recommendations/
â”‚   â”‚   â”‚           â””â”€â”€ route.ts              # GET recommendations
â”‚   â”‚   â””â”€â”€ rule-recommendations/
â”‚   â”‚       â””â”€â”€ [id]/
â”‚   â”‚           â”œâ”€â”€ apply/
â”‚   â”‚           â”‚   â””â”€â”€ route.ts              # POST apply rule
â”‚   â”‚           â””â”€â”€ preview/
â”‚   â”‚               â””â”€â”€ route.ts              # POST preview impact
â”‚   â””â”€â”€ (authenticated)/
â”‚       â””â”€â”€ settings/
â”‚           â””â”€â”€ custom-rules/
â”‚               â””â”€â”€ page.tsx                  # Settings page
â””â”€â”€ components/
    â”œâ”€â”€ ai-rule-recommendation-card.tsx       # Recommendation UI
    â””â”€â”€ rule-impact-preview.tsx               # Impact preview dialog
```

---

## Testing

### Unit Tests
- **File**: `apps/web/lib/ai/rule-recommendation-engine.test.ts`
- **Tests**:
  - Transaction pattern analysis
  - Fraud pattern identification
  - Rule recommendation generation
  - Impact simulation logic

### Integration Tests
- **File**: `apps/web/lib/ai/__tests__/rule-recommendation.integration.test.ts`
- **Tests**:
  - Full recommendation flow with real database
  - API endpoints (get, apply, preview)
  - Effectiveness tracking

### E2E Tests
- **File**: `e2e/ai-rule-recommendations.spec.ts` (Playwright)
- **Tests**:
  - Recommendations appear in Settings page
  - Preview impact shows metrics
  - Apply rule â†’ rule created and tracked

### Testing Standards
- Framework: Vitest (unit), Playwright (E2E)
- Coverage target: â‰¥80% for recommendation logic
- Mock transaction data for deterministic tests
- Test edge cases (no history, conflicting patterns)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-26 | 1.0 | Story created | Sarah (PO) |

---

## Dev Agent Record

(To be populated during implementation)

---

## QA Results

(To be populated by QA agent after testing)
