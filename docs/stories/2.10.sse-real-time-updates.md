# Story 2.10: Server-Sent Events (SSE) Real-Time Updates

**Epic**: Epic 2 - Dashboard Action-First Experience  
**Story Points**: 8  
**Status**: Draft

---

## Story

**As a** merchant,  
**I want** new detections to appear instantly without refresh,  
**so that** I can react to fraud in real-time.

---

## Acceptance Criteria

1. **AC1**: Endpoint: `GET /api/events` (SSE stream)
2. **AC2**: Event types: `detection.created`, `detection.updated`
3. **AC3**: Authentication: Verify session token in request headers
4. **AC4**: Multi-tenancy: Only send events for user's organizationId
5. **AC5**: Client: `EventSource` connection, auto-reconnect on disconnect
6. **AC6**: UI update: New detection card prepended to feed avec animation (slide-in from top)
7. **AC7**: Animation: Shadcn `tw-animate-css` fade-in + slide
8. **AC8**: Performance: Max 100 concurrent SSE connections (rate limit)
9. **AC9**: Heartbeat: Send ping every 30s to keep connection alive
10. **AC10**: E2E test: Trigger webhook → Verify SSE event received → Card appears

---

## Tasks / Subtasks

- [ ] Create SSE endpoint: `GET /api/events`
- [ ] Verify Better Auth session before opening stream
- [ ] Filter events by organizationId (multi-tenancy)
- [ ] Emit events when detection created (after webhook processing)
- [ ] Client: Create useSSE hook with EventSource
- [ ] Auto-reconnect on disconnect (exponential backoff)
- [ ] Prepend new detection to feed with animation
- [ ] Heartbeat ping every 30s
- [ ] Rate limit: Max 100 concurrent connections

---

## Dev Notes

**SSE Architecture**:
```typescript
// app/api/events/route.ts
export async function GET(request: Request) {
  const session = await auth.api.getSession({ headers: request.headers });
  if (!session) return new Response('Unauthorized', { status: 401 });

  const stream = new ReadableStream({
    start(controller) {
      const encoder = new TextEncoder();
      
      // Heartbeat
      const heartbeat = setInterval(() => {
        controller.enqueue(encoder.encode(': ping\n\n'));
      }, 30000);

      // Listen for new detections
      eventEmitter.on(`detection.created:${session.user.organizationId}`, (data) => {
        controller.enqueue(encoder.encode(`event: detection.created\ndata: ${JSON.stringify(data)}\n\n`));
      });

      // Cleanup
      request.signal.addEventListener('abort', () => {
        clearInterval(heartbeat);
      });
    },
  });

  return new Response(stream, {
    headers: {
      'Content-Type': 'text/event-stream',
      'Cache-Control': 'no-cache',
      'Connection': 'keep-alive',
    },
  });
}
```

**Client Hook**:
```typescript
function useSSE() {
  useEffect(() => {
    const eventSource = new EventSource('/api/events');

    eventSource.addEventListener('detection.created', (event) => {
      const detection = JSON.parse(event.data);
      // Prepend to feed with animation
      setDetections(prev => [detection, ...prev]);
    });

    eventSource.onerror = () => {
      // Auto-reconnect (EventSource handles this automatically)
    };

    return () => eventSource.close();
  }, []);
}
```

**Animation**:
```tsx
<motion.div
  initial={{ opacity: 0, y: -20 }}
  animate={{ opacity: 1, y: 0 }}
  transition={{ duration: 0.4 }}
>
  <DetectionCard {...detection} />
</motion.div>
```

---

## Testing

- Integration: SSE stream sends events correctly
- E2E: Webhook triggers → SSE event → Card appears

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-13 | 1.0 | Story created | Sarah (PO) |
