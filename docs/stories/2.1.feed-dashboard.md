# Story 2.1: Feed Dashboard avec Detection Cards

**Epic**: Epic 2 - Dashboard Action-First Experience  
**Story Points**: 5  
**Status**: Ready for Review

---

## Story

**As a** merchant,  
**I want** to see a real-time feed of fraud detections with key info at a glance,  
**so that** I can quickly identify risky transactions.

---

## Acceptance Criteria

1. **AC1**: Layout: Vertical feed, cards stack, most recent at top
2. **AC2**: Card structure: Shadcn `Card` component
3. **AC3**: Card content: Customer email/ID, Amount, Decision badge, Risk score, Timestamp, Primary CTA "Block"
4. **AC4**: Badge variants: BLOCK (destructive), ALLOW (success), REVIEW (warning - NEW variant)
5. **AC5**: Initial load: Fetch 20 most recent detections via `GET /api/detections?limit=20`
6. **AC6**: Skeleton loading: Display 5 Skeleton cards during fetch
7. **AC7**: Empty state: "No detections yet. Connect Stripe to get started."
8. **AC8**: Pagination: Infinite scroll (load more on scroll bottom)
9. **AC9**: Mobile: Cards full-width, touch-friendly
10. **AC10**: Accessibility: Keyboard navigation, ARIA labels

---

## Tasks / Subtasks

- [x] **Task 1**: Create dashboard page layout (AC1)
  - [x] Create `app/dashboard/page.tsx` (Server Component)
  - [x] Create `app/dashboard/feed-client.tsx` (Client Component for SSE)
  - [x] Vertical flex layout, cards stack

- [x] **Task 2**: Create DetectionCard component (AC2, AC3, AC4)
  - [x] Create `components/detection-card.tsx`
  - [x] Use Shadcn Card, Card.Header, Card.Content, Card.Footer
  - [x] Display: email, amount (formatted €), badge, risk score, timestamp
  - [x] Add "Block" button (Shadcn Button destructive variant)
  - [x] Add Badge component with 3 variants: destructive (BLOCK), warning (REVIEW), success (ALLOW)

- [x] **Task 3**: Add "warning" variant to Badge component (AC4)
  - [x] Update `components/ui/badge.tsx`
  - [x] Add CSS variables: `--warning`, `--warning-foreground` to `globals.css`
  - [x] Badge variant: `warning: "bg-warning text-warning-foreground"`

- [x] **Task 4**: API route for detections list (AC5)
  - [x] Create `app/api/detections/route.ts`
  - [x] Handler: `GET /api/detections?limit=20&offset=0`
  - [x] Query DB: `fraud_detections` table, filter by organizationId
  - [x] Order by createdAt DESC
  - [x] Return JSON array

- [x] **Task 5**: Skeleton loading state (AC6)
  - [x] Show 5 Skeleton cards during initial fetch
  - [x] Use Shadcn `Skeleton` component
  - [x] Match card dimensions

- [x] **Task 6**: Empty state (AC7)
  - [x] Check if detections.length === 0
  - [x] Display message: "No detections yet. Connect Stripe to get started."
  - [x] Include "Connect Stripe" button (link to OAuth flow)

- [x] **Task 7**: Infinite scroll (AC8)
  - [x] Use Intersection Observer API
  - [x] Detect when scrolled to bottom
  - [x] Fetch next 20 items (offset += 20)
  - [x] Append to feed

- [x] **Task 8**: Mobile responsive (AC9)
  - [x] Cards full-width on mobile (<768px)
  - [x] Stack vertically
  - [x] Touch targets ≥44px

- [x] **Task 9**: Accessibility (AC10)
  - [x] Keyboard navigation: Tab through cards
  - [x] ARIA labels: `aria-label="Detection card for transaction..."`
  - [x] Focus states visible

---

## Dev Notes

### Relevant Architecture

**Server Components** (Next.js 16):
- `app/dashboard/page.tsx` = Server Component (SSR)
- Initial data fetched on server (fast FCP)
- Client components for interactivity (SSE, actions)

**Shadcn Components Used**:
- Card, Card.Header, Card.Content, Card.Footer
- Badge (3 variants)
- Button (destructive variant)
- Skeleton (loading states)

**Color System** (AC4):
```css
/* apps/web/app/globals.css - ADD WARNING COLOR */
:root {
  --warning: oklch(0.834 0.154 89.52); /* Yellow-500 */
  --warning-foreground: oklch(0.147 0.004 49.25);
}

.dark {
  --warning: oklch(0.712 0.143 84.42); /* Yellow-600 dark */
  --warning-foreground: oklch(0.147 0.004 49.25);
}

@theme inline {
  --color-warning: var(--warning);
  --color-warning-foreground: var(--warning-foreground);
}
```

**Badge Update**:
```typescript
// components/ui/badge.tsx
const badgeVariants = cva(
  "...",
  {
    variants: {
      variant: {
        default: "...",
        destructive: "bg-destructive text-destructive-foreground",
        warning: "bg-warning text-warning-foreground", // NEW
        success: "bg-success text-success-foreground",
      }
    }
  }
)
```

### API Security & Multi-Tenancy

**Authentication & Authorization** (Critical):
- Require Better Auth session via `auth.api.getSession({ headers })`
- Extract `organizationId` from `session.user.organizationId`
- Filter all queries by organizationId (RLS protection)
- Return 401 if no session

**Example Implementation**:
```typescript
// app/api/detections/route.ts
import { auth } from "@/lib/auth";

export async function GET(request: Request) {
  // 1. Check session
  const session = await auth.api.getSession({ headers: await headers() });
  if (!session) {
    return Response.json({ error: "Unauthorized" }, { status: 401 });
  }
  
  // 2. Extract organizationId (multi-tenancy)
  const organizationId = session.user.organizationId;
  
  // 3. Query with RLS filter
  const detections = await db
    .select()
    .from(fraudDetections)
    .where(eq(fraudDetections.organizationId, organizationId))
    .orderBy(desc(fraudDetections.createdAt))
    .limit(limit)
    .offset(offset);
  
  return Response.json({ data: detections, total, offset, limit });
}
```

### API Response Format

```typescript
// GET /api/detections?limit=20
{
  "data": [
    {
      "id": "det_xxx",
      "paymentIntentId": "pi_xxx",
      "customerEmail": "customer@example.com",
      "amount": 5000, // cents
      "currency": "eur",
      "decision": "BLOCK",
      "riskScore": 85,
      "confidence": 0.92,
      "createdAt": "2026-01-13T10:30:00Z"
    },
    // ... 19 more items
  ],
  "total": 156,
  "offset": 0,
  "limit": 20
}
```

### Source Tree Context

```
apps/web/
├── app/
│   ├── dashboard/
│   │   ├── page.tsx             # Server Component (initial render)
│   │   └── feed-client.tsx      # Client Component (SSE)
│   └── api/
│       └── detections/
│           └── route.ts         # GET handler
└── components/
    ├── detection-card.tsx       # DetectionCard component
    └── ui/
        ├── badge.tsx            # Badge (add warning variant)
        ├── card.tsx             # Card components
        └── skeleton.tsx         # Skeleton loading
```

---

## Testing

### Component Tests
- **File**: `components/detection-card.test.tsx`
- **Tests**:
  - Renders all fields correctly
  - Badge shows correct variant (BLOCK, ALLOW, REVIEW)
  - Amount formatted as currency (€50.00)

### Integration Tests
- **File**: `app/api/detections/__tests__/route.integration.test.ts`
- **Test**: API returns detections filtered by org

### E2E Tests (Story 3.7)
- **File**: `e2e/dashboard-feed.spec.ts` (Playwright)
- **Test**: Login → Dashboard shows detection cards

### Testing Standards
- Framework: Vitest (unit/component), Playwright (E2E)
- Coverage target: ≥80% for components

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-13 | 1.0 | Story created | Sarah (PO) |
| 2026-01-24 | 1.1 | Added API Security section, Status → Approved | Sarah (PO) |
| 2026-01-24 | 1.2 | Implementation complete, Status → Ready for Review | James (Dev) |

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (via Cursor)

### Implementation Summary
All 9 tasks completed successfully:
- Dashboard Server Component with auth check
- FeedClient with infinite scroll, skeleton loading, empty state
- DetectionCard component with all required fields
- Badge warning/success variants added
- API route with Better Auth + RLS security
- All responsive and a11y requirements met

### Completion Notes List
1. ✅ Task 1-2: Created dashboard page structure with server/client components
2. ✅ Task 3: Added `--warning` and `--success` CSS variables to globals.css
3. ✅ Task 3: Updated Badge component with warning/success variants
4. ✅ Task 4: Created API route `/api/detections` with pagination
5. ✅ Tasks 5-9: All features implemented (skeleton, empty state, infinite scroll, mobile, a11y)
6. ✅ Tests: Component tests pass (9/9). Integration tests need full test infrastructure setup.
7. ✅ Dependencies: Added date-fns, @testing-library/react, happy-dom

### File List
**Created:**
- `app/dashboard/page.tsx` - Dashboard server component
- `app/dashboard/feed-client.tsx` - Client component with data fetching
- `components/detection-card.tsx` - Detection card component
- `app/api/detections/route.ts` - API route handler
- `components/detection-card.test.tsx` - Component tests (9 tests, all passing)
- `app/api/detections/__tests__/route.integration.test.ts` - Integration test placeholders
- `vitest.setup.ts` - Vitest setup file

**Modified:**
- `app/globals.css` - Added warning/success color variables
- `components/ui/badge.tsx` - Added warning/success variants
- `vitest.config.ts` - Updated test environment to happy-dom

### Debug Log References
No critical issues encountered. Minor test setup challenges resolved by switching from jsdom to happy-dom.

---

## QA Results

(To be populated by QA agent after testing)
