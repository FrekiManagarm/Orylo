# Story 2.1: Feed Dashboard avec Detection Cards

**Epic**: Epic 2 - Dashboard Action-First Experience  
**Story Points**: 5  
**Status**: Draft

---

## Story

**As a** merchant,  
**I want** to see a real-time feed of fraud detections with key info at a glance,  
**so that** I can quickly identify risky transactions.

---

## Acceptance Criteria

1. **AC1**: Layout: Vertical feed, cards stack, most recent at top
2. **AC2**: Card structure: Shadcn `Card` component
3. **AC3**: Card content: Customer email/ID, Amount, Decision badge, Risk score, Timestamp, Primary CTA "Block"
4. **AC4**: Badge variants: BLOCK (destructive), ALLOW (success), REVIEW (warning - NEW variant)
5. **AC5**: Initial load: Fetch 20 most recent detections via `GET /api/detections?limit=20`
6. **AC6**: Skeleton loading: Display 5 Skeleton cards during fetch
7. **AC7**: Empty state: "No detections yet. Connect Stripe to get started."
8. **AC8**: Pagination: Infinite scroll (load more on scroll bottom)
9. **AC9**: Mobile: Cards full-width, touch-friendly
10. **AC10**: Accessibility: Keyboard navigation, ARIA labels

---

## Tasks / Subtasks

- [ ] **Task 1**: Create dashboard page layout (AC1)
  - [ ] Create `app/dashboard/page.tsx` (Server Component)
  - [ ] Create `app/dashboard/feed-client.tsx` (Client Component for SSE)
  - [ ] Vertical flex layout, cards stack

- [ ] **Task 2**: Create DetectionCard component (AC2, AC3, AC4)
  - [ ] Create `components/detection-card.tsx`
  - [ ] Use Shadcn Card, Card.Header, Card.Content, Card.Footer
  - [ ] Display: email, amount (formatted €), badge, risk score, timestamp
  - [ ] Add "Block" button (Shadcn Button destructive variant)
  - [ ] Add Badge component with 3 variants: destructive (BLOCK), warning (REVIEW), success (ALLOW)

- [ ] **Task 3**: Add "warning" variant to Badge component (AC4)
  - [ ] Update `components/ui/badge.tsx`
  - [ ] Add CSS variables: `--warning`, `--warning-foreground` to `globals.css`
  - [ ] Badge variant: `warning: "bg-warning text-warning-foreground"`

- [ ] **Task 4**: API route for detections list (AC5)
  - [ ] Create `app/api/detections/route.ts`
  - [ ] Handler: `GET /api/detections?limit=20&offset=0`
  - [ ] Query DB: `fraud_detections` table, filter by organizationId
  - [ ] Order by createdAt DESC
  - [ ] Return JSON array

- [ ] **Task 5**: Skeleton loading state (AC6)
  - [ ] Show 5 Skeleton cards during initial fetch
  - [ ] Use Shadcn `Skeleton` component
  - [ ] Match card dimensions

- [ ] **Task 6**: Empty state (AC7)
  - [ ] Check if detections.length === 0
  - [ ] Display message: "No detections yet. Connect Stripe to get started."
  - [ ] Include "Connect Stripe" button (link to OAuth flow)

- [ ] **Task 7**: Infinite scroll (AC8)
  - [ ] Use Intersection Observer API
  - [ ] Detect when scrolled to bottom
  - [ ] Fetch next 20 items (offset += 20)
  - [ ] Append to feed

- [ ] **Task 8**: Mobile responsive (AC9)
  - [ ] Cards full-width on mobile (<768px)
  - [ ] Stack vertically
  - [ ] Touch targets ≥44px

- [ ] **Task 9**: Accessibility (AC10)
  - [ ] Keyboard navigation: Tab through cards
  - [ ] ARIA labels: `aria-label="Detection card for transaction..."`
  - [ ] Focus states visible

---

## Dev Notes

### Relevant Architecture

**Server Components** (Next.js 16):
- `app/dashboard/page.tsx` = Server Component (SSR)
- Initial data fetched on server (fast FCP)
- Client components for interactivity (SSE, actions)

**Shadcn Components Used**:
- Card, Card.Header, Card.Content, Card.Footer
- Badge (3 variants)
- Button (destructive variant)
- Skeleton (loading states)

**Color System** (AC4):
```css
/* apps/web/app/globals.css - ADD WARNING COLOR */
:root {
  --warning: oklch(0.834 0.154 89.52); /* Yellow-500 */
  --warning-foreground: oklch(0.147 0.004 49.25);
}

.dark {
  --warning: oklch(0.712 0.143 84.42); /* Yellow-600 dark */
  --warning-foreground: oklch(0.147 0.004 49.25);
}

@theme inline {
  --color-warning: var(--warning);
  --color-warning-foreground: var(--warning-foreground);
}
```

**Badge Update**:
```typescript
// components/ui/badge.tsx
const badgeVariants = cva(
  "...",
  {
    variants: {
      variant: {
        default: "...",
        destructive: "bg-destructive text-destructive-foreground",
        warning: "bg-warning text-warning-foreground", // NEW
        success: "bg-success text-success-foreground",
      }
    }
  }
)
```

### API Response Format

```typescript
// GET /api/detections?limit=20
{
  "data": [
    {
      "id": "det_xxx",
      "paymentIntentId": "pi_xxx",
      "customerEmail": "customer@example.com",
      "amount": 5000, // cents
      "currency": "eur",
      "decision": "BLOCK",
      "riskScore": 85,
      "confidence": 0.92,
      "createdAt": "2026-01-13T10:30:00Z"
    },
    // ... 19 more items
  ],
  "total": 156,
  "offset": 0,
  "limit": 20
}
```

### Source Tree Context

```
apps/web/
├── app/
│   ├── dashboard/
│   │   ├── page.tsx             # Server Component (initial render)
│   │   └── feed-client.tsx      # Client Component (SSE)
│   └── api/
│       └── detections/
│           └── route.ts         # GET handler
└── components/
    ├── detection-card.tsx       # DetectionCard component
    └── ui/
        ├── badge.tsx            # Badge (add warning variant)
        ├── card.tsx             # Card components
        └── skeleton.tsx         # Skeleton loading
```

---

## Testing

### Component Tests
- **File**: `components/detection-card.test.tsx`
- **Tests**:
  - Renders all fields correctly
  - Badge shows correct variant (BLOCK, ALLOW, REVIEW)
  - Amount formatted as currency (€50.00)

### Integration Tests
- **File**: `app/api/detections/__tests__/route.integration.test.ts`
- **Test**: API returns detections filtered by org

### E2E Tests (Story 3.7)
- **File**: `e2e/dashboard-feed.spec.ts` (Playwright)
- **Test**: Login → Dashboard shows detection cards

### Testing Standards
- Framework: Vitest (unit/component), Playwright (E2E)
- Coverage target: ≥80% for components

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-13 | 1.0 | Story created | Sarah (PO) |

---

## Dev Agent Record

(To be populated by dev agent)

---

## QA Results

(To be populated by QA agent after testing)
