# Story 3.1: Production Webhooks avec Idempotency & Retry Logic

**Epic**: Epic 3 - Integration & Production Readiness  
**Story Points**: 5  
**Status**: Draft

---

## Story

**As a** system,  
**I want** production webhooks with idempotency and retry logic,  
**so that** webhook processing is reliable under all conditions.

---

## Acceptance Criteria

1. **AC1**: Idempotency via event.id deduplication (NFR16)
2. **AC2**: Stripe signature verification renforcée
3. **AC3**: Database transaction pour atomicité
4. **AC4**: Retry logic avec exponential backoff
5. **AC5**: Dead letter queue pour failed webhooks
6. **AC6**: Webhook events expansion (`charge.succeeded`, `charge.failed`, `charge.dispute.created`)
7. **AC7**: Performance monitoring per webhook type
8. **AC8**: Integration test avec Stripe CLI

---

## Tasks / Subtasks

- [x] Add webhook_events table (id, stripe_event_id, type, processed, retry_count)
- [x] Check stripe_event_id exists before processing (idempotency)
- [x] Wrap processing in DB transaction (atomic)
- [x] Retry logic: 3 attempts with exponential backoff (1s, 2s, 4s)
- [x] Dead letter queue: Store failed events after 3 retries
- [x] Add event handlers: charge.succeeded, charge.failed, charge.dispute.created
- [x] Log performance per webhook type
- [ ] Integration test with Stripe CLI (deferred to Story 3.6)

---

## Dev Notes

### Context & Integration Points
This story enhances the existing webhook handler from Story 1.2 (`app/api/webhooks/stripe/route.ts`) with production-grade reliability: idempotency, retry logic, and dead letter queue. The idempotency check happens BEFORE fraud detection to avoid duplicate processing.

**Integration with Story 1.2**: Refactor existing webhook route to include idempotency check at the start, wrap detection in retry logic, and store failed events.

### File Structure
```
apps/web/
├── app/api/webhooks/stripe/
│   └── route.ts (MODIFY - add idempotency + retry)
├── lib/
│   ├── webhook-processor.ts (NEW - retry logic + DLQ)
│   └── db.ts (existing)
packages/database/
├── schema/
│   ├── webhook-events.ts (NEW - idempotency table)
│   └── dead-letter-queue.ts (NEW - DLQ table)
└── migrations/
    └── 0008_webhook_reliability.sql (NEW)
```

### Database Schema

**Migration File**: `packages/database/migrations/0008_webhook_reliability.sql`

**Idempotency Table**:
```typescript
// packages/database/schema/webhook-events.ts
export const webhookEvents = pgTable('webhook_events', {
  id: text('id').primaryKey().$defaultFn(() => createId()),
  stripeEventId: text('stripe_event_id').unique().notNull(),
  type: text('type').notNull(),
  organizationId: text('organization_id').notNull().references(() => organizations.id),
  processed: boolean('processed').default(false).notNull(),
  retryCount: integer('retry_count').default(0).notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  processedAt: timestamp('processed_at'),
});

// Indexes for performance (AC7)
export const webhookEventsIndexes = {
  stripeEventIdIdx: index('webhook_events_stripe_event_id_idx').on(webhookEvents.stripeEventId),
  organizationIdIdx: index('webhook_events_organization_id_idx').on(webhookEvents.organizationId),
};
```

**Dead Letter Queue Table**:
```typescript
// packages/database/schema/dead-letter-queue.ts
export const deadLetterQueue = pgTable('dead_letter_queue', {
  id: text('id').primaryKey().$defaultFn(() => createId()),
  stripeEventId: text('stripe_event_id').notNull(),
  eventType: text('event_type').notNull(),
  payload: json('payload').notNull(), // Full Stripe event
  errorMessage: text('error_message').notNull(),
  errorStack: text('error_stack'),
  retryCount: integer('retry_count').notNull(),
  organizationId: text('organization_id').notNull().references(() => organizations.id),
  createdAt: timestamp('created_at').defaultNow().notNull(),
});
```

### Implementation Details

**1. Idempotency Check** (AC1):
```typescript
// app/api/webhooks/stripe/route.ts
export async function POST(request: Request) {
  // Existing signature verification from Story 1.2
  const event = stripe.webhooks.constructEvent(body, signature, webhookSecret);
  
  // NEW: Idempotency check BEFORE processing
  const existing = await db.select().from(webhookEvents)
    .where(eq(webhookEvents.stripeEventId, event.id))
    .limit(1);

  if (existing.length > 0) {
    console.log(`[Webhook] Duplicate event detected: ${event.id}`);
    return new Response(JSON.stringify({ received: true, duplicate: true }), { 
      status: 200,
      headers: { 'Content-Type': 'application/json' }
    });
  }

  // Create webhook event record (marks event as received)
  await db.insert(webhookEvents).values({
    stripeEventId: event.id,
    type: event.type,
    organizationId: getOrgIdFromEvent(event), // Extract from metadata
    processed: false,
    retryCount: 0,
  });

  // Process webhook with retry logic
  await processWebhookWithRetry(event);
  
  return new Response(JSON.stringify({ received: true }), { status: 200 });
}
```

**2. Retry Logic with Exponential Backoff** (AC4):
```typescript
// lib/webhook-processor.ts (NEW FILE)
export async function processWebhookWithRetry(event: Stripe.Event) {
  const maxRetries = 3;
  let retryCount = 0;

  while (retryCount <= maxRetries) {
    try {
      // Call existing detection logic from Story 1.3
      await detectFraud(buildDetectionContext(event));
      
      // Mark as processed (AC3: Atomic transaction)
      await db.update(webhookEvents)
        .set({ 
          processed: true, 
          processedAt: new Date(),
          retryCount 
        })
        .where(eq(webhookEvents.stripeEventId, event.id));
      
      console.log(`[Webhook] Successfully processed: ${event.id}`);
      break;
    } catch (error) {
      retryCount++;
      console.error(`[Webhook] Processing failed (attempt ${retryCount}):`, error);
      
      if (retryCount <= maxRetries) {
        // Exponential backoff: 1s, 2s, 4s
        const delayMs = Math.pow(2, retryCount) * 1000;
        await new Promise(resolve => setTimeout(resolve, delayMs));
      } else {
        // AC5: Save to dead letter queue after 3 retries
        await saveToDeadLetterQueue(event, error as Error, retryCount);
      }
    }
  }
}

async function saveToDeadLetterQueue(
  event: Stripe.Event, 
  error: Error, 
  retryCount: number
) {
  await db.insert(deadLetterQueue).values({
    stripeEventId: event.id,
    eventType: event.type,
    payload: event,
    errorMessage: error.message,
    errorStack: error.stack,
    retryCount,
    organizationId: getOrgIdFromEvent(event),
  });
  
  console.error(`[DLQ] Event moved to dead letter queue: ${event.id}`);
}
```

**3. Event Handler Expansion** (AC6):
```typescript
// app/api/webhooks/stripe/route.ts
const SUPPORTED_EVENTS = [
  'payment_intent.created', // Existing from Story 1.2
  'charge.succeeded',       // NEW
  'charge.failed',          // NEW
  'charge.dispute.created', // NEW (integrates with Story 3.2)
];

// Filter events
if (!SUPPORTED_EVENTS.includes(event.type)) {
  console.log(`[Webhook] Unsupported event type: ${event.type}`);
  return new Response(JSON.stringify({ received: true, skipped: true }), { status: 200 });
}
```

**4. Performance Monitoring** (AC7):
```typescript
// Add timing metrics per webhook type
const startTime = Date.now();

// ... processing logic ...

const duration = Date.now() - startTime;
console.log(`[Webhook] ${event.type} processed in ${duration}ms`);

// Integration with Story 3.3 (Observability)
posthog.capture('webhook_processed', {
  eventType: event.type,
  duration,
  retryCount,
  success: true,
});
```

### Error Handling
- **Invalid signature**: Return 400 (existing Story 1.2 behavior)
- **Duplicate event**: Return 200 with `{ duplicate: true }` (AC1)
- **Processing failure**: Retry 3 times, then DLQ (AC4, AC5)
- **Database errors**: Log error, return 500 (Stripe will retry)

### Security Considerations
- Signature verification unchanged (Story 1.2 - AC2)
- Dead letter queue accessible only by admin users (future enhancement)
- Webhook events table partitioned by organizationId (multi-tenancy)

### Testing Standards

**Test File Locations**:
- Unit tests: `app/api/webhooks/stripe/__tests__/idempotency.test.ts`
- Unit tests: `lib/__tests__/webhook-processor.test.ts`
- Integration tests: Story 3.6 will add end-to-end webhook tests

**Testing Framework**: Vitest (unit), Stripe CLI (integration)

**Coverage Target**: 
- Unit: ≥80% for `webhook-processor.ts`
- Integration: ≥60% for webhook route (Story 3.6)

**Test Cases**:
1. **Unit**: Idempotency check detects duplicate event
2. **Unit**: Retry logic attempts 3 times with exponential backoff
3. **Unit**: Dead letter queue saves failed event after max retries
4. **Integration** (AC8): Stripe CLI triggers `payment_intent.created` → Processed successfully
5. **Integration** (AC8): Send same event twice → Second returns `{ duplicate: true }`
6. **Integration**: Simulate processing failure → Verify 3 retries → Verify DLQ entry

---

## Testing

### Unit Tests (Vitest)
- Idempotency: Duplicate event detection
- Retry logic: 3 attempts with 1s, 2s, 4s delays
- DLQ: Failed event storage after retries
- Event type filtering: Supported vs unsupported events

### Integration Tests (Story 3.6)
- Stripe CLI: Valid webhook → Processing
- Duplicate webhook → Idempotency
- Failed processing → Retry → DLQ

### Performance Testing (AC7)
- Monitor webhook processing time per event type
- Target: P95 <350ms (NFR1)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-13 | 1.0 | Story created | Sarah (PO) |
| 2026-01-24 | 1.1 | Enhanced Dev Notes, added Testing Standards, fixed DLQ implementation | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (via Cursor)

### Implementation Summary
Implemented production-grade webhook reliability with idempotency, retry logic, and dead letter queue. Created database schemas for webhook_events and dead_letter_queue tables. Refactored webhook route to check for duplicate events before processing. Added webhook-processor module with exponential backoff retry logic (3 attempts: 1s, 2s, 4s). Expanded event support to include charge.succeeded, charge.failed, and charge.dispute.created. Added performance monitoring per webhook type.

### Completion Notes List
- Created webhook-events.ts and dead-letter-queue.ts schema files
- Implemented idempotency check in webhook route (checks stripe_event_id before processing)
- Created webhook-processor.ts with retry logic and DLQ functionality
- Refactored webhook route to use new processor and support multiple event types
- Added unit tests for webhook processor (retry logic, DLQ, event filtering)
- Added unit tests for idempotency in webhook route
- Integration tests with Stripe CLI deferred to Story 3.6 as specified in story notes

### File List
**Created:**
- `packages/database/src/schema/webhook-events.ts` - Idempotency tracking table
- `packages/database/src/schema/dead-letter-queue.ts` - Failed events storage
- `apps/web/lib/webhook-processor.ts` - Retry logic and DLQ processor
- `apps/web/lib/__tests__/webhook-processor.test.ts` - Unit tests for processor
- `apps/web/app/api/webhooks/stripe/__tests__/idempotency.test.ts` - Idempotency tests

**Modified:**
- `packages/database/src/schema/index.ts` - Export new schemas
- `apps/web/app/api/webhooks/stripe/route.ts` - Added idempotency, event expansion, performance monitoring

### Debug Log References
- Webhook processing logs: `[Webhook] Successfully processed: {eventId}`
- Retry logs: `[Webhook] Processing failed (attempt {retryCount}): {error}`
- DLQ logs: `[DLQ] Event moved to dead letter queue: {eventId}`
- Performance logs: `[Webhook] {eventType} received in {duration}ms`

---

## QA Results

(To be filled by QA Agent after implementation review)
