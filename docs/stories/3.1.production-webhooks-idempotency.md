# Story 3.1: Production Webhooks avec Idempotency & Retry Logic

**Epic**: Epic 3 - Integration & Production Readiness  
**Story Points**: 5  
**Status**: Draft

---

## Story

**As a** system,  
**I want** production webhooks with idempotency and retry logic,  
**so that** webhook processing is reliable under all conditions.

---

## Acceptance Criteria

1. **AC1**: Idempotency via event.id deduplication (NFR16)
2. **AC2**: Stripe signature verification renforcée
3. **AC3**: Database transaction pour atomicité
4. **AC4**: Retry logic avec exponential backoff
5. **AC5**: Dead letter queue pour failed webhooks
6. **AC6**: Webhook events expansion (`charge.succeeded`, `charge.failed`, `charge.dispute.created`)
7. **AC7**: Performance monitoring per webhook type
8. **AC8**: Integration test avec Stripe CLI

---

## Tasks / Subtasks

- [ ] Add webhook_events table (id, stripe_event_id, type, processed, retry_count)
- [ ] Check stripe_event_id exists before processing (idempotency)
- [ ] Wrap processing in DB transaction (atomic)
- [ ] Retry logic: 3 attempts with exponential backoff (1s, 2s, 4s)
- [ ] Dead letter queue: Store failed events after 3 retries
- [ ] Add event handlers: charge.succeeded, charge.failed, charge.dispute.created
- [ ] Log performance per webhook type
- [ ] Integration test with Stripe CLI

---

## Dev Notes

**Idempotency Table**:
```typescript
export const webhookEvents = pgTable('webhook_events', {
  id: text('id').primaryKey(),
  stripeEventId: text('stripe_event_id').unique().notNull(),
  type: text('type').notNull(),
  processed: boolean('processed').default(false),
  retryCount: integer('retry_count').default(0),
  createdAt: timestamp('created_at').defaultNow(),
});
```

**Deduplication Logic**:
```typescript
const existing = await db.select().from(webhookEvents)
  .where(eq(webhookEvents.stripeEventId, event.id))
  .limit(1);

if (existing.length > 0) {
  return { status: 'duplicate', processed: false };
}
```

**Retry with Exponential Backoff**:
```typescript
const maxRetries = 3;
let retryCount = 0;

while (retryCount < maxRetries) {
  try {
    await processWebhook(event);
    break;
  } catch (error) {
    retryCount++;
    if (retryCount < maxRetries) {
      await sleep(Math.pow(2, retryCount) * 1000); // 1s, 2s, 4s
    } else {
      await saveToDeadLetterQueue(event, error);
    }
  }
}
```

---

## Testing

- Integration: Duplicate event → Idempotency works
- Integration: Failed processing → Retry 3 times

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-13 | 1.0 | Story created | Sarah (PO) |
