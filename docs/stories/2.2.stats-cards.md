# Story 2.2: Stats Cards (Contextual Metrics)

**Epic**: Epic 2 - Dashboard Action-First Experience  
**Story Points**: 3  
**Status**: Ready for Review

---

## Story

**As a** merchant,  
**I want** to see key metrics at the top of dashboard,  
**so that** I understand fraud trends at a glance.

---

## Acceptance Criteria

1. **AC1**: Metrics displayed: Total Transactions, Blocked, At Risk (REVIEW), Total Saved (€)
2. **AC2**: Layout: 1x4 horizontal row (desktop), 2x2 grid (mobile)
3. **AC3**: Component: Shadcn `Card` per metric
4. **AC4**: Calculation: Query `fraud_detections` table, filter by date range
5. **AC5**: Total Saved: `SUM(amount WHERE decision = BLOCK)`
6. **AC6**: Refresh: Auto-refresh every 30s (SSE update)
7. **AC7**: Date range filter: Tabs "Today / Week / Month" (Shadcn `Tabs`)
8. **AC8**: Loading state: Spinner during fetch

---

## Tasks / Subtasks

- [x] **Task 1**: Create StatsPanel component structure (AC1, AC2, AC3)
  - [x] Create `components/stats-panel.tsx`
  - [x] Layout: 4 StatCard components in grid
  - [x] Responsive: `grid-cols-2` mobile, `grid-cols-4` desktop
  
- [x] **Task 2**: Create StatCard component (AC3)
  - [x] Use Shadcn Card component
  - [x] Props: title, value, icon, trend (optional)
  - [x] Format currency for "Total Saved"
  
- [x] **Task 3**: API endpoint for stats (AC4, AC5)
  - [x] Create `app/api/detections/stats/route.ts`
  - [x] Handler: `GET /api/detections/stats?range=today`
  - [x] Verify Better Auth session
  - [x] Filter by organizationId
  - [x] Calculate metrics from fraud_detections table
  
- [x] **Task 4**: Implement date range Tabs (AC7)
  - [x] Use Shadcn Tabs component
  - [x] Options: Today, Week, Month
  - [x] Update stats on tab change
  
- [x] **Task 5**: Auto-refresh mechanism (AC6)
  - [x] Use `setInterval` every 30s
  - [x] Cleanup on unmount
  
- [x] **Task 6**: Loading state (AC8)
  - [x] Show Skeleton cards during fetch
  - [x] Use Shadcn Spinner

---

## Dev Notes

### API Security & Multi-Tenancy

**Authentication** (Critical):
- Require Better Auth session via `auth.api.getSession({ headers })`
- Extract `organizationId` from `session.user.organizationId`
- Filter all queries by organizationId
- Return 401 if no session

**Example Implementation**:
```typescript
// app/api/detections/stats/route.ts
import { auth } from "@/lib/auth";

export async function GET(request: Request) {
  const session = await auth.api.getSession({ headers: await headers() });
  if (!session) {
    return Response.json({ error: "Unauthorized" }, { status: 401 });
  }
  
  const organizationId = session.user.organizationId;
  const { searchParams } = new URL(request.url);
  const range = searchParams.get('range') || 'today';
  
  // Calculate date range
  const dateFrom = getDateFromRange(range); // today/week/month
  
  // Query DB
  const stats = await db
    .select({
      totalTransactions: count(),
      blocked: countIf(eq(fraudDetections.decision, 'BLOCK')),
      atRisk: countIf(eq(fraudDetections.decision, 'REVIEW')),
      totalSaved: sum(fraudDetections.amount).where(eq(fraudDetections.decision, 'BLOCK')),
    })
    .from(fraudDetections)
    .where(
      and(
        eq(fraudDetections.organizationId, organizationId),
        gte(fraudDetections.createdAt, dateFrom)
      )
    );
  
  return Response.json(stats);
}
```

### Shadcn Components

- Card (StatCard wrapper)
- Tabs (Date range selection)
- Skeleton (Loading state)

### API Response Format

```json
{
  "totalTransactions": 245,
  "blocked": 12,
  "atRisk": 18,
  "totalSaved": 45000 // cents (€450.00)
}
```

### Source Tree Context

```
apps/web/
├── app/
│   ├── dashboard/
│   │   ├── page.tsx             # Includes StatsPanel
│   └── api/
│       └── detections/
│           └── stats/
│               └── route.ts     # GET handler
└── components/
    ├── stats-panel.tsx          # Main stats component
    └── stat-card.tsx            # Individual stat card
```

---

## Testing

### Component Tests
- **File**: `components/stat-card.test.tsx` (5 tests, all passing)
- **Tests**: Renders correctly, shows icon, loading state, card structure

### Integration Tests  
- **File**: `components/stats-panel.test.tsx` (5 tests, all passing)
- **Tests**: Renders 4 cards, loading state, tabs, API fetch, currency formatting

### Testing Standards
- Framework: Vitest (unit/component)
- Coverage: 100% test pass rate

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-13 | 1.0 | Story created | Sarah (PO) |
| 2026-01-24 | 1.1 | Added API Security, detailed tasks, Status → Approved | Sarah (PO) |
| 2026-01-24 | 1.2 | Implementation complete, Status → Ready for Review | James (Dev) |

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (via Cursor)

### Implementation Summary
All 6 tasks completed successfully:
- StatsPanel component with 4 stat cards
- StatCard component with loading states
- API route with date range filtering (today/week/month)
- Date range tabs (Shadcn Tabs)
- Auto-refresh every 30s
- Skeleton loading states

### Completion Notes List
1. ✅ Task 1-2: Created StatsPanel and StatCard components with responsive grid layout
2. ✅ Task 3: Created API route `/api/detections/stats` with Better Auth + RLS
3. ✅ Task 4: Implemented date range tabs (Today/Week/Month)
4. ✅ Task 5: Auto-refresh with setInterval cleanup
5. ✅ Task 6: Skeleton loading states for all cards
6. ✅ Tests: 10/10 tests passing (5 StatCard + 5 StatsPanel)
7. ✅ Integrated StatsPanel into dashboard page
8. ✅ Dependencies: Added lucide-react for icons

### File List
**Created:**
- `components/stat-card.tsx` - Individual stat card component
- `components/stats-panel.tsx` - Stats panel with tabs and auto-refresh
- `app/api/detections/stats/route.ts` - Stats API endpoint
- `components/stat-card.test.tsx` - StatCard tests (5 tests, all passing)
- `components/stats-panel.test.tsx` - StatsPanel tests (5 tests, all passing)

**Modified:**
- `app/dashboard/page.tsx` - Added StatsPanel to dashboard

### Debug Log References
No issues encountered. All tests pass, linting clean.
