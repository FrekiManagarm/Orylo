# Story 3.3: Observability Stack - Logging, Monitoring, Alerting

**Epic**: Epic 3 - Integration & Production Readiness  
**Story Points**: 5  
**Status**: Draft

---

## Story

**As a** development team,  
**I want** comprehensive observability (logging, monitoring, alerting),  
**so that** we can debug issues and monitor system health in production.

---

## Acceptance Criteria

1. **AC1**: tslog structured logging finalized
2. **AC2**: Log levels configuration (INFO production, DEBUG dev)
3. **AC3**: Vercel Analytics integration (API routes latency)
4. **AC4**: PostHog events tracking (user_login, stripe_connected, customer_blocked, etc.)
5. **AC5**: Error tracking avec Sentry (optional si budget)
6. **AC6**: Alerting rules (email via Resend if budget)
7. **AC7**: Health check endpoint enhancement (`/api/health`)
8. **AC8**: Monitoring dashboard bookmarks

---

## Tasks / Subtasks

- [x] Finalize tslog configuration (structured JSON logs) (AC1)
- [x] Environment-based log levels (INFO prod, DEBUG dev) (AC2)
- [x] Vercel Analytics: Track API route performance (AC3)
- [x] PostHog: Track key events (user_login, stripe_connected, customer_blocked, detection_created) (AC4)
- [x] Sentry setup (optional, if budget allows) (AC5)
- [x] Health check endpoint: GET /api/health (DB + Redis status) (AC7)
- [x] Email alerts via Resend (optional) (AC6)
- [x] Document monitoring dashboards (Vercel, PostHog, Sentry) (AC8)

---

## Dev Notes

### Context & Integration Points
This story establishes production-grade observability across all layers: structured logging (tslog), performance monitoring (Vercel Analytics), user analytics (PostHog), and optional error tracking (Sentry). Integrates with all previous stories for comprehensive visibility.

### File Structure
```
apps/web/
├── lib/
│   ├── logger.ts (NEW - tslog configuration)
│   ├── posthog.ts (NEW - PostHog client)
│   └── monitoring.ts (NEW - health check helpers)
├── app/api/
│   └── health/route.ts (NEW - health endpoint)
└── middleware.ts (MODIFY - add performance logging)
```

### Implementation Details

**1. Structured Logging with tslog** (AC1, AC2):

**Installation**: `bun add tslog`

```typescript
// lib/logger.ts (NEW FILE)
import { Logger } from 'tslog';

// AC2: Environment-based log levels
const LOG_LEVEL = process.env.LOG_LEVEL || (process.env.NODE_ENV === 'production' ? 'info' : 'debug');

export const logger = new Logger({
  name: 'orylo',
  type: process.env.NODE_ENV === 'production' ? 'json' : 'pretty',
  minLevel: LOG_LEVEL as any,
  prettyLogTimeZone: 'local',
  prettyLogTemplate: '{{yyyy}}-{{mm}}-{{dd}} {{hh}}:{{MM}}:{{ss}} {{logLevelName}} ',
});

// Structured log helpers
export const logWebhookReceived = (eventId: string, type: string) => {
  logger.info(`Webhook received`, { eventId, type, component: 'webhook' });
};

export const logDetectionCreated = (detectionId: string, decision: string, score: number) => {
  logger.info(`Detection created`, { detectionId, decision, score, component: 'detector' });
};

export const logError = (error: Error, context: Record<string, any>) => {
  logger.error(`Error occurred`, { message: error.message, stack: error.stack, ...context });
};
```

**Usage in Existing Code**:
```typescript
// app/api/webhooks/stripe/route.ts (MODIFY)
import { logger, logWebhookReceived } from '@/lib/logger';

export async function POST(request: Request) {
  const event = stripe.webhooks.constructEvent(...);
  logWebhookReceived(event.id, event.type); // Structured logging
  // ... existing logic ...
}
```

**2. Vercel Analytics Integration** (AC3):

Vercel Analytics is automatically enabled for Vercel projects. No code changes needed, but add environment variable:

```bash
# .env (Vercel Dashboard)
NEXT_PUBLIC_VERCEL_ANALYTICS_ID=<auto-set-by-vercel>
```

**Track Custom API Performance**:
```typescript
// middleware.ts (MODIFY)
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export function middleware(request: NextRequest) {
  const start = Date.now();
  
  const response = NextResponse.next();
  
  // Add performance header for Vercel Analytics
  const duration = Date.now() - start;
  response.headers.set('X-Response-Time', `${duration}ms`);
  
  return response;
}

export const config = {
  matcher: '/api/:path*',
};
```

**3. PostHog Events Tracking** (AC4):

**Installation**: `bun add posthog-js posthog-node`

```typescript
// lib/posthog.ts (NEW FILE)
import { PostHog } from 'posthog-node';

// Server-side PostHog client
export const posthog = new PostHog(
  process.env.NEXT_PUBLIC_POSTHOG_KEY!,
  { 
    host: process.env.NEXT_PUBLIC_POSTHOG_HOST || 'https://app.posthog.com',
    flushAt: 20,
    flushInterval: 10000,
  }
);

// Event tracking helpers
export const trackUserLogin = (userId: string, organizationId: string) => {
  posthog.capture({
    distinctId: userId,
    event: 'user_login',
    properties: { organizationId },
  });
};

export const trackStripeConnected = (organizationId: string, stripeAccountId: string) => {
  posthog.capture({
    distinctId: organizationId,
    event: 'stripe_connected',
    properties: { stripeAccountId },
  });
};

export const trackCustomerBlocked = (organizationId: string, customerId: string) => {
  posthog.capture({
    distinctId: organizationId,
    event: 'customer_blocked',
    properties: { customerId },
  });
};

export const trackDetectionCreated = (organizationId: string, decision: string, riskScore: number) => {
  posthog.capture({
    distinctId: organizationId,
    event: 'detection_created',
    properties: { decision, riskScore },
  });
};
```

**Environment Variables**:
```bash
# .env.local (add to Vercel Dashboard)
NEXT_PUBLIC_POSTHOG_KEY=phc_xxxxxxxxxxxxx
NEXT_PUBLIC_POSTHOG_HOST=https://app.posthog.com
```

**4. Sentry Error Tracking** (AC5 - Optional):

**Condition**: Include Sentry if budget allows (€15/month within €300 NFR6 budget)

```typescript
// lib/sentry.ts (NEW FILE - Optional)
import * as Sentry from '@sentry/nextjs';

if (process.env.NEXT_PUBLIC_SENTRY_DSN) {
  Sentry.init({
    dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
    environment: process.env.NODE_ENV,
    tracesSampleRate: 0.1, // 10% sampling
    beforeSend(event) {
      // Remove PII
      if (event.user) {
        delete event.user.email;
        delete event.user.ip_address;
      }
      return event;
    },
  });
}

export { Sentry };
```

**Installation** (if enabled): `bun add @sentry/nextjs`

**5. Email Alerts via Resend** (AC6 - Optional):

**Condition**: Include alerts if budget allows (€15/month)

```typescript
// lib/alerts.ts (NEW FILE - Optional)
import { Resend } from 'resend';

const resend = process.env.RESEND_API_KEY 
  ? new Resend(process.env.RESEND_API_KEY)
  : null;

export async function sendAlertEmail(subject: string, message: string) {
  if (!resend) {
    console.warn('[Alerts] Resend not configured, skipping email alert');
    return;
  }

  await resend.emails.send({
    from: 'alerts@orylo.com',
    to: process.env.ADMIN_EMAIL!,
    subject,
    text: message,
  });
}

// Usage: Alert on auto-blacklist (Story 3.2 integration)
export async function alertAutoBlacklist(customerId: string, chargebacks: number) {
  await sendAlertEmail(
    'Customer Auto-Blacklisted',
    `Customer ${customerId} was auto-blacklisted after ${chargebacks} chargebacks.`
  );
}
```

**6. Health Check Endpoint** (AC7):

```typescript
// app/api/health/route.ts (NEW FILE)
import { db } from '@/lib/db';
import { redis } from '@/lib/redis';
import { sql } from 'drizzle-orm';

export async function GET() {
  const checks = {
    database: false,
    redis: false,
  };

  // Check database connection
  try {
    await db.execute(sql`SELECT 1`);
    checks.database = true;
  } catch (error) {
    console.error('[Health] Database check failed:', error);
  }

  // Check Redis connection
  try {
    await redis.ping();
    checks.redis = true;
  } catch (error) {
    console.error('[Health] Redis check failed:', error);
  }

  const allHealthy = checks.database && checks.redis;
  const status = allHealthy ? 200 : 503;

  return Response.json({
    status: allHealthy ? 'healthy' : 'unhealthy',
    checks,
    timestamp: new Date().toISOString(),
    version: process.env.npm_package_version || '1.0.0',
  }, { status });
}
```

**7. Monitoring Dashboard Bookmarks** (AC8):

Create documentation file:

```markdown
// docs/monitoring-dashboards.md (NEW FILE)
# Monitoring Dashboards

## Vercel Analytics
- URL: https://vercel.com/orylo/analytics
- Metrics: API latency, error rates, page performance
- Alerts: P95 latency >350ms

## PostHog
- URL: https://app.posthog.com/project/xxxxx
- Dashboards:
  - Beta KPIs: User signups, active users, feature usage
  - Fraud Metrics: Detections per day, block rate, trust score distribution
- Funnels: Signup → Stripe Connect → First Detection

## Sentry (Optional)
- URL: https://sentry.io/orylo
- Monitors: Error rate, crash-free sessions
- Alerts: New error types, spike in error rate

## Neon Database
- URL: https://console.neon.tech/
- Metrics: Query performance, connection pool, storage

## Upstash Redis
- URL: https://console.upstash.com/
- Metrics: Cache hit rate, memory usage, latency
```

### Error Handling
- **tslog initialization fails**: Fall back to console.log
- **PostHog unavailable**: Log warning, continue (non-blocking)
- **Health check timeout**: Return 503 after 5s timeout
- **Sentry disabled**: No-op (optional feature)

### Security Considerations
- PII removal in Sentry beforeSend hook
- Health endpoint public (no sensitive data exposed)
- Admin email alerts only to verified addresses

### Testing Standards

**Test File Locations**:
- Unit tests: `lib/__tests__/logger.test.ts`
- Unit tests: `lib/__tests__/posthog.test.ts`
- Integration tests: `app/api/health/__tests__/route.integration.test.ts`

**Testing Framework**: Vitest

**Coverage Target**: 
- Unit: ≥70% (observability utilities)
- Integration: Health endpoint 100%

**Test Cases**:
1. **Unit**: Logger formats structured JSON in production
2. **Unit**: PostHog events captured with correct properties
3. **Integration**: Health endpoint returns 200 when services healthy
4. **Integration**: Health endpoint returns 503 when database down
5. **Manual**: Verify logs in Vercel dashboard (production)

---

## Testing

### Integration Tests
- Health check endpoint: Returns 200 when healthy
- Health check endpoint: Returns 503 when database/Redis down
- Health check: Response includes all service statuses

### Manual Testing
- Vercel dashboard: Verify logs appear (structured JSON)
- PostHog: Verify events tracked (user_login, detection_created)
- Sentry (if enabled): Verify errors captured

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-13 | 1.0 | Story created | Sarah (PO) |
| 2026-01-24 | 1.1 | Enhanced implementation details, added Testing Standards, clarified optional features | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (via Cursor)

### Implementation Summary
Implemented comprehensive observability stack: structured logging with tslog (JSON in prod, pretty in dev), PostHog event tracking for key user actions, health check endpoint for service monitoring, middleware for API performance tracking, optional Sentry error tracking, optional Resend email alerts, and monitoring dashboard documentation. Integrated logging and PostHog tracking into existing webhook processor, trust-score-updater, and block customer route.

### Completion Notes List
- Created logger.ts with tslog configuration and structured log helpers
- Created posthog.ts with event tracking functions (graceful degradation if package not installed)
- Created health check endpoint (/api/health) with DB and Redis connectivity checks
- Created middleware.ts for API performance tracking (X-Response-Time header)
- Created optional sentry.ts and alerts.ts modules (conditional initialization)
- Created monitoring-dashboards.md documentation
- Integrated logger into webhook route, webhook-processor, and trust-score-updater
- Integrated PostHog tracking into webhook-processor, trust-score-updater, and block customer route
- All 8 unit/integration tests passing

### File List
**Created:**
- `apps/web/lib/logger.ts` - Structured logging with tslog
- `apps/web/lib/posthog.ts` - PostHog event tracking
- `apps/web/lib/sentry.ts` - Optional Sentry error tracking
- `apps/web/lib/alerts.ts` - Optional Resend email alerts
- `apps/web/middleware.ts` - API performance tracking
- `apps/web/app/api/health/route.ts` - Health check endpoint
- `apps/web/lib/__tests__/logger.test.ts` - Logger unit tests (4 tests)
- `apps/web/app/api/health/__tests__/route.integration.test.ts` - Health endpoint tests (4 tests)
- `docs/monitoring-dashboards.md` - Monitoring dashboard documentation

**Modified:**
- `apps/web/app/api/webhooks/stripe/route.ts` - Integrated logger
- `apps/web/lib/webhook-processor.ts` - Integrated logger and PostHog tracking
- `apps/web/lib/trust-score-updater.ts` - Integrated logger and PostHog tracking
- `apps/web/app/api/customers/[id]/block/route.ts` - Added PostHog tracking

### Debug Log References
- Structured logs: `logger.info/warn/error()` with context objects
- Webhook logs: `[Webhook] Successfully processed: {eventId}`
- Chargeback logs: `[Chargeback] Penalty applied: {customerId}`
- Health check logs: `[Health] Database check failed: {error}`
- PostHog events: `user_login`, `stripe_connected`, `customer_blocked`, `detection_created`, `webhook_processed`

---

## QA Results

(To be filled by QA Agent after implementation review)
