# Story 3.3: Observability Stack - Logging, Monitoring, Alerting

**Epic**: Epic 3 - Integration & Production Readiness  
**Story Points**: 5  
**Status**: Draft

---

## Story

**As a** development team,  
**I want** comprehensive observability (logging, monitoring, alerting),  
**so that** we can debug issues and monitor system health in production.

---

## Acceptance Criteria

1. **AC1**: tslog structured logging finalized
2. **AC2**: Log levels configuration (INFO production, DEBUG dev)
3. **AC3**: Vercel Analytics integration (API routes latency)
4. **AC4**: PostHog events tracking (user_login, stripe_connected, customer_blocked, etc.)
5. **AC5**: Error tracking avec Sentry (optional si budget)
6. **AC6**: Alerting rules (email via Resend if budget)
7. **AC7**: Health check endpoint enhancement (`/api/health`)
8. **AC8**: Monitoring dashboard bookmarks

---

## Tasks / Subtasks

- [ ] Finalize tslog configuration (structured JSON logs) (AC1)
- [ ] Environment-based log levels (INFO prod, DEBUG dev) (AC2)
- [ ] Vercel Analytics: Track API route performance (AC3)
- [ ] PostHog: Track key events (user_login, stripe_connected, customer_blocked, detection_created) (AC4)
- [ ] Sentry setup (optional, if budget allows) (AC5)
- [ ] Health check endpoint: GET /api/health (DB + Redis status) (AC7)
- [ ] Email alerts via Resend (optional) (AC6)
- [ ] Document monitoring dashboards (Vercel, PostHog, Sentry) (AC8)

---

## Dev Notes

**tslog Configuration**:
```typescript
// lib/logger.ts
import { Logger } from 'tslog';

export const logger = new Logger({
  type: process.env.NODE_ENV === 'production' ? 'json' : 'pretty',
  minLevel: process.env.NODE_ENV === 'production' ? 'info' : 'debug',
});
```

**PostHog Events**:
```typescript
posthog.capture('user_login', { userId, organizationId });
posthog.capture('stripe_connected', { organizationId, stripeAccountId });
posthog.capture('customer_blocked', { customerId, organizationId });
posthog.capture('detection_created', { decision, riskScore });
```

**Health Check**:
```typescript
// app/api/health/route.ts
export async function GET() {
  const dbStatus = await checkDatabaseConnection();
  const redisStatus = await checkRedisConnection();

  return Response.json({
    status: dbStatus && redisStatus ? 'healthy' : 'unhealthy',
    database: dbStatus ? 'connected' : 'disconnected',
    redis: redisStatus ? 'connected' : 'disconnected',
    timestamp: new Date().toISOString(),
  });
}
```

---

## Testing

- Integration: Health check endpoint returns correct status
- Manual: Verify logs in Vercel dashboard

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-13 | 1.0 | Story created | Sarah (PO) |
