# Story 4.4: Feedback Loop & Apprentissage des Overrides

**Epic**: Epic 4 - Syst√®me de D√©cisions Assist√© par IA  
**Story Points**: 10  
**Status**: üîÑ InProgress

---

## Story

**As a** system,  
**I want** to track merchant overrides (accept/reject suggestions) and learn from them,  
**so that** future suggestions become more accurate and aligned with merchant preferences.

---

## Acceptance Criteria

1. **AC1**: Track all merchant actions on AI suggestions (accepted, rejected, modified) - triggered from `POST /api/suggestions/[id]/accept` and `/reject` endpoints (Story 4.1)
2. **AC2**: Store feedback in `ai_feedback` table with context: `suggestionId`, `detectionId`, `suggestionType`, `originalConfidence`, `detectionContext` (partial: amount, customerEmail, decision, riskScore)
   - **Note**: `detectionContext` stores only these fields: `{ amount: number, customerEmail: string | null, decision: 'ALLOW'|'REVIEW'|'BLOCK', riskScore: number }` (no PII like customerId, IP, card details)
3. **AC3**: Optional merchant reason field when rejecting suggestion - input via `feedback-reason-dialog.tsx` component, stored in `ai_feedback.merchantReason`
4. **AC4**: Feedback data used to improve suggestion confidence scores - Trigger.dev scheduled job `analyze-feedback` (daily) analyzes feedback, updates confidence thresholds stored in Redis
5. **AC5**: A/B testing framework: Compare suggestion acceptance rates by time period (weekly), before/after model updates, generate reports showing improvement
6. **AC6**: Dashboard metric: "AI Suggestion Accuracy" (acceptance rate = accepted / (accepted + rejected)) displayed in `ai-metrics-card.tsx` component in Settings page
7. **AC7**: Privacy: Feedback data anonymized for model improvement (opt-in checkbox in Settings) - remove PII (emails, customer IDs) via `feedback-anonymizer.ts`
   - **Note**: Opt-in setting stored in `organizations.shareFeedbackForModelImprovement` (boolean field, default: false). Add migration to add this field to organizations table.
8. **AC8**: Integration test: Verify feedback tracking (accept/reject actions create `ai_feedback` records), model update triggers (scheduled job updates thresholds), anonymization logic

---

## Tasks / Subtasks

- [x] **Task 1**: Database schema for AI feedback (AC1, AC2, AC3)
  - [x] Create `ai_feedback` table migration (Drizzle)
  - [x] Fields: `id`, `suggestionId`, `merchantAction` (accepted/rejected/modified), `merchantReason`, `context` (JSON), `createdAt`
  - [x] Add foreign key to `ai_suggestions` table
  - [x] Add index on `suggestionId`, `merchantAction`, `createdAt`
  - [x] Add `shareFeedbackForModelImprovement` field to `organizations` table (boolean, default: false) for opt-in privacy setting (AC7)

- [x] **Task 2**: Feedback tracking API (AC1, AC2, AC3)
  - [x] Update `POST /api/suggestions/[id]/accept` (Story 4.1) to track feedback
    - [x] Validate `suggestionId` with Zod schema (UUID format, ADR-010)
    - [x] Verify Better Auth session and organization ownership (RLS check)
    - [x] After applying whitelist/blacklist, create `ai_feedback` record with `merchantAction='accepted'`
    - [x] Store `detectionContext` with only: `{ amount, customerEmail, decision, riskScore }` (no PII)
  - [x] Update `POST /api/suggestions/[id]/reject` (Story 4.1) to track feedback with reason
    - [x] Validate `suggestionId` with Zod schema
    - [x] Verify Better Auth session and organization ownership
    - [x] Accept optional `merchantReason` in request body (validate with Zod: string, max 500 chars)
    - [x] Create `ai_feedback` record with `merchantAction='rejected'`, `merchantReason`
    - [x] Store `detectionContext` with only: `{ amount, customerEmail, decision, riskScore }`
  - [x] Create `POST /api/suggestions/[id]/feedback` endpoint (explicit feedback for modified suggestions)
    - [x] Validate `suggestionId` with Zod schema
    - [x] Verify Better Auth session and organization ownership
    - [x] Apply rate limiting: 30 req/min per organization (ADR-010)
  - [x] Store feedback with full context:
    - [x] `suggestionId` (from `ai_suggestions` table)
    - [x] `detectionId` (from suggestion context)
    - [x] `suggestionType` (whitelist/blacklist/rule)
    - [x] `originalConfidence` (from suggestion)
    - [x] `detectionContext` (partial: `{ amount: number, customerEmail: string | null, decision: string, riskScore: number }` - no PII)

- [x] **Task 3**: Feedback analysis engine (AC4)
  - [x] Create `lib/ai/feedback-analyzer.ts`
  - [x] Analyze feedback patterns: which suggestions accepted/rejected
  - [x] Calculate suggestion accuracy: accepted / (accepted + rejected)
  - [x] Identify patterns: low-confidence suggestions more rejected, etc.
  - [x] Update suggestion confidence scores based on feedback

- [x] **Task 4**: A/B testing framework (AC5)
  - [x] Create `lib/ai/ab-testing.ts`
  - [x] Track suggestion acceptance rates by time period (weekly)
  - [x] Compare acceptance rates: before/after model updates
  - [x] Generate A/B test reports: "Acceptance rate improved from 55% to 68%"

- [x] **Task 5**: Dashboard metrics (AC6)
  - [x] Create `GET /api/organizations/[id]/ai-metrics` endpoint
    - [x] Validate `organizationId` with Zod schema (UUID format, ADR-010)
    - [x] Verify Better Auth session and organization ownership (RLS check)
    - [x] Apply rate limiting: 100 req/min per organization (ADR-010)
  - [x] Calculate: AI Suggestion Accuracy (acceptance rate = accepted / (accepted + rejected))
  - [x] Calculate: Total suggestions, accepted, rejected, modified
  - [x] Create `components/ai-metrics-card.tsx` component
    - [x] **Design**: Card layout with border (Shadcn Card component)
    - [x] **Styling**: Background `bg-muted/50`, border `border-border`, padding `p-4`
    - [x] Display metrics: Acceptance rate (Progress bar), Total/Accepted/Rejected counts (Badges)
    - [x] **Responsive**: Mobile-friendly layout (stack vertically on <768px)
    - [x] **Accessibility**: ARIA labels, keyboard navigation support
  - [x] Display metrics in Settings page (`/settings/custom-rules`)

- [x] **Task 6**: Privacy & anonymization (AC7)
  - [x] Add `shareFeedbackForModelImprovement` field to `organizations` table (boolean, default: false)
  - [x] Create opt-in checkbox in Settings page (`/settings/custom-rules`):
    - [x] Shadcn Switch component
    - [x] Label: "Share feedback for model improvement"
    - [x] Description: "Help improve AI suggestions by sharing anonymized feedback data (GDPR compliant)"
    - [x] Create `POST /api/organizations/[id]/privacy-settings` endpoint to update opt-in setting
  - [x] Anonymize feedback data: Remove PII (emails, customer IDs) via `lib/ai/feedback-anonymizer.ts`
    - [x] Remove `customerEmail` from `detectionContext` (replace with `[REDACTED]`)
    - [x] Remove any customer IDs from context
    - [x] Keep only: `amount`, `decision`, `riskScore` (no PII)
  - [x] Store anonymized feedback separately (optional export for model training)
    - [x] Set `ai_feedback.anonymized=true` when opt-in is enabled and data is anonymized

- [x] **Task 7**: Model update triggers (AC4, AC8)
  - [x] Create Trigger.dev scheduled job: `analyze-feedback` (daily, ADR-006)
    - [x] Use `schedules.task()` with cron: `"0 2 * * *"` (2am UTC daily)
    - [x] Job analyzes feedback from last 7 days, updates suggestion confidence thresholds
    - [x] Job generates A/B test report
    - [x] Store model version and update history in Redis (key: `model_version:${organizationId}`)
  - [x] Job logic:
    - [x] Query `ai_feedback` table for all organizations (last 7 days)
    - [x] Calculate acceptance rates per organization
    - [x] Update confidence thresholds in Redis (key: `suggestion_threshold:${organizationId}`)
    - [x] Generate A/B test report comparing current week vs previous week

- [ ] **Task 8**: Integration tests (AC8)
  - [ ] Test feedback tracking on accept/reject actions
  - [ ] Test feedback analysis logic
  - [ ] Test A/B testing framework
  - [ ] Test anonymization logic

---

## Dependencies

**Depends on**:
- Story 4.1: `ai_suggestions` table, suggestion accept/reject endpoints
- Epic 3: Trigger.dev configured (ADR-006) for scheduled job, Redis for caching metrics

**Blocks**:
- None (final story in Epic 4)

**Can be developed after**:
- Story 4.1 must be completed first (needs suggestion endpoints)
- Stories 4.2 and 4.3 can be developed in parallel

---

## Dev Notes

### Relevant Architecture

**Feedback Data Structure**:
```typescript
interface AIFeedback {
  suggestionId: string;
  merchantAction: 'accepted' | 'rejected' | 'modified';
  merchantReason?: string; // Optional when rejecting (max 500 chars)
  context: {
    detectionId: string;
    suggestionType: 'whitelist' | 'blacklist' | 'rule';
    originalConfidence: number; // 0-1
    detectionContext: {
      // Partial context - only non-PII fields
      amount: number; // Transaction amount in cents
      customerEmail: string | null; // Will be anonymized if opt-in enabled
      decision: 'ALLOW' | 'REVIEW' | 'BLOCK';
      riskScore: number; // 0-100
      // NOTE: No customerId, IP, card details (PII removed)
    };
  };
  timestamp: Date;
}
```

**Feedback Analysis**:
```typescript
interface FeedbackAnalysis {
  suggestionId: string;
  totalFeedback: number;
  accepted: number;
  rejected: number;
  modified: number;
  acceptanceRate: number; // accepted / total
  averageConfidence: number;
  patterns: {
    lowConfidenceRejected: number; // <0.6 confidence rejected
    highConfidenceAccepted: number; // >0.8 confidence accepted
  };
}
```

**Database Schema**:
```typescript
// packages/database/src/schema/ai-feedback.ts
import { pgTable, text, timestamp, boolean, jsonb, index } from "drizzle-orm/pg-core";
import { aiSuggestions } from "./ai-suggestions";
import { organizations } from "./organizations";

export const aiFeedback = pgTable('ai_feedback', {
  id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),
  suggestionId: text('suggestion_id')
    .notNull()
    .references(() => aiSuggestions.id, { onDelete: 'cascade' }),
  organizationId: text('organization_id')
    .notNull()
    .references(() => organizations.id, { onDelete: 'cascade' }),
  merchantAction: text('merchant_action', { enum: ['accepted', 'rejected', 'modified'] }).notNull(),
  merchantReason: text('merchant_reason'), // Optional
  context: jsonb('context').notNull(), // AIFeedback context (detectionId, suggestionType, originalConfidence, detectionContext)
  anonymized: boolean('anonymized').default(false).notNull(), // If shared for model improvement
  createdAt: timestamp('created_at').defaultNow().notNull(),
});

// Indexes for performance
export const aiFeedbackIndexes = {
  suggestionId: index('ai_feedback_suggestion_id_idx').on(aiFeedback.suggestionId),
  merchantAction: index('ai_feedback_merchant_action_idx').on(aiFeedback.merchantAction),
  createdAt: index('ai_feedback_created_at_idx').on(aiFeedback.createdAt),
  organizationId: index('ai_feedback_organization_id_idx').on(aiFeedback.organizationId),
};
```

**Model Update Logic**:
```typescript
// lib/ai/feedback-analyzer.ts
async function updateSuggestionConfidence(
  organizationId: string,
  feedbackAnalysis: FeedbackAnalysis
): Promise<void> {
  // Analyze feedback patterns
  // If acceptance rate <50% for confidence >0.8 ‚Üí lower threshold (suggestions too aggressive)
  // If acceptance rate >80% for confidence <0.6 ‚Üí raise threshold (suggestions too conservative)
  
  // Update suggestion engine parameters (store in Redis or DB config table)
  // Example: Adjust confidence thresholds based on merchant's acceptance patterns
  const adjustedThreshold = calculateAdjustedThreshold(feedbackAnalysis);
  await redis.set(`suggestion_threshold:${organizationId}`, adjustedThreshold, 'EX', 86400);
}
```

**A/B Testing**:
```typescript
interface ABTestResult {
  period: 'before' | 'after';
  acceptanceRate: number;
  totalSuggestions: number;
  improvement: number; // percentage
}
```

**Integration Points**:
- Uses existing `ai_suggestions` table (Story 4.1)
- Integrates with suggestion accept/reject endpoints (Story 4.1)
  - **Note**: Update endpoints from Story 4.1 to call feedback tracking after action is applied
- Uses Trigger.dev for scheduled analysis (ADR-006)
  - **Pattern**: `schedules.task()` with cron `"0 2 * * *"` (daily at 2am UTC)
- Uses Redis for caching metrics (Epic 3, ADR-003)
  - Cache keys: `suggestion_threshold:${organizationId}`, `model_version:${organizationId}`
- **Privacy Setting**: Add `shareFeedbackForModelImprovement` field to `organizations` table
- **ADR References**: ADR-003 (Cache Architecture), ADR-006 (Background Jobs), ADR-010 (Security Architecture)

**Privacy Considerations** (ADR-010, GDPR):
- Opt-in for sharing feedback (GDPR compliant)
  - Stored in `organizations.shareFeedbackForModelImprovement` (boolean, default: false)
  - User must explicitly enable in Settings
- Anonymize PII before storage/export
  - Remove `customerEmail` (replace with `[REDACTED]`)
  - Remove customer IDs
  - Keep only: `amount`, `decision`, `riskScore` (no PII)
- Clear data retention policy (90 days, same as detections)
- **Anonymization Logic**:
  ```typescript
  // lib/ai/feedback-anonymizer.ts
  function anonymizeFeedbackContext(context: DetectionContext): AnonymizedContext {
    return {
      amount: context.amount, // Keep (not PII)
      customerEmail: '[REDACTED]', // Remove PII
      decision: context.decision, // Keep
      riskScore: context.riskScore, // Keep
      // Remove: customerId, customerIp, cardCountry, cardLast4, etc.
    };
  }
  ```

**Security & Multi-Tenancy** (ADR-010):
- All API endpoints verify Better Auth session (pattern: `auth.api.getSession()`)
- Extract `organizationId` from session for multi-tenancy
- Verify feedback belongs to user's organization (RLS check)
- Return 401 if no session, 403 if wrong organization
- **Input Validation (Zod schemas)**:
  ```typescript
  // lib/validation/ai-feedback.ts
  import { z } from "zod";
  
  export const SuggestionIdSchema = z.string().uuid("Invalid suggestion ID format");
  export const OrganizationIdSchema = z.string().uuid("Invalid organization ID format");
  export const MerchantReasonSchema = z.string().max(500, "Reason too long").optional();
  
  // Usage in API routes
  const validated = SuggestionIdSchema.parse(suggestionId);
  ```
- **Rate Limiting** (ADR-010 Layer 6):
  - `POST /api/suggestions/[id]/feedback`: 30 req/min per organization
  - `GET /api/organizations/[id]/ai-metrics`: 100 req/min per organization
  - `POST /api/organizations/[id]/privacy-settings`: 10 req/min per organization
  - Use `@upstash/ratelimit` with Redis (pattern from ADR-010)
- Validate `suggestionId` and `organizationId` format (UUID) and existence in DB

### Source Tree Context

```
apps/web/
‚îú‚îÄ‚îÄ trigger/
‚îÇ   ‚îî‚îÄ‚îÄ jobs/
‚îÇ       ‚îî‚îÄ‚îÄ analyze-feedback.job.ts          # Scheduled daily analysis
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îî‚îÄ‚îÄ ai/
‚îÇ       ‚îú‚îÄ‚îÄ feedback-analyzer.ts              # Feedback analysis & model updates
‚îÇ       ‚îú‚îÄ‚îÄ feedback-anonymizer.ts            # PII removal
‚îÇ       ‚îî‚îÄ‚îÄ ab-testing.ts                     # A/B testing framework
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îî‚îÄ‚îÄ api/
‚îÇ       ‚îú‚îÄ‚îÄ suggestions/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ [id]/
‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ feedback/
‚îÇ       ‚îÇ           ‚îî‚îÄ‚îÄ route.ts             # POST explicit feedback
‚îÇ       ‚îî‚îÄ‚îÄ organizations/
‚îÇ           ‚îî‚îÄ‚îÄ [id]/
‚îÇ               ‚îî‚îÄ‚îÄ ai-metrics/
‚îÇ                   ‚îî‚îÄ‚îÄ route.ts             # GET AI metrics
‚îî‚îÄ‚îÄ components/
    ‚îú‚îÄ‚îÄ ai-metrics-card.tsx                   # Metrics display
    ‚îî‚îÄ‚îÄ feedback-reason-dialog.tsx            # Optional reason input
```

---

## Testing

### Unit Tests
- **File**: `apps/web/lib/ai/feedback-analyzer.test.ts`
- **Tests**:
  - Feedback analysis logic
  - Acceptance rate calculation
  - Model update triggers
  - A/B testing framework

### Integration Tests
- **File**: `apps/web/lib/ai/__tests__/feedback-analyzer.integration.test.ts`
- **Tests**:
  - Full feedback tracking flow
  - Database storage and retrieval
  - Model update job execution
  - Anonymization logic

### E2E Tests
- **File**: `e2e/ai-feedback-loop.spec.ts` (Playwright)
- **Tests**:
  - Accept suggestion ‚Üí feedback tracked
  - Reject suggestion with reason ‚Üí feedback tracked
  - Metrics displayed in dashboard
  - Opt-in privacy setting

### Testing Standards
- Framework: Vitest (unit), Playwright (E2E)
- Coverage target: ‚â•80% for feedback logic
- Test with mock feedback data
- Test edge cases (no feedback, conflicting patterns)

**Mock Data Structure - ai_feedback**:
```typescript
const mockAIFeedback = {
  id: 'feedback_001',
  suggestionId: 'suggestion_001', // From ai_suggestions table (Story 4.1)
  organizationId: 'org_001',
  merchantAction: 'accepted' as const,
  merchantReason: null, // Optional, only for rejected
  context: {
    detectionId: 'det_001',
    suggestionType: 'whitelist' as const,
    originalConfidence: 0.85,
    detectionContext: {
      amount: 5000, // ‚Ç¨50.00
      customerEmail: 'customer@example.com', // Will be anonymized if opt-in
      decision: 'ALLOW' as const,
      riskScore: 25,
    },
  },
  anonymized: false, // Set to true if opt-in enabled and anonymized
  createdAt: new Date(),
};

// Mock for rejected suggestion
const mockRejectedFeedback = {
  ...mockAIFeedback,
  id: 'feedback_002',
  merchantAction: 'rejected' as const,
  merchantReason: 'Customer is actually legitimate, false positive',
  context: {
    ...mockAIFeedback.context,
    originalConfidence: 0.65,
    detectionContext: {
      amount: 10000,
      customerEmail: 'good.customer@example.com',
      decision: 'BLOCK' as const,
      riskScore: 85,
    },
  },
};
```

**Mock Data Structure - organizations** (with privacy setting):
```typescript
const mockOrganization = {
  id: 'org_001',
  name: 'ACME Corp',
  slug: 'acme-corp',
  shareFeedbackForModelImprovement: true, // Opt-in enabled
  // ... other fields
};
```

**Mock Data Structure - Trigger.dev scheduled job**:
```typescript
// Mock for analyze-feedback job
const mockFeedbackAnalysis = {
  organizationId: 'org_001',
  period: {
    start: subDays(new Date(), 7),
    end: new Date(),
  },
  totalFeedback: 50,
  accepted: 35,
  rejected: 15,
  acceptanceRate: 0.70, // 70%
  averageConfidence: 0.75,
  patterns: {
    lowConfidenceRejected: 8, // <0.6 confidence rejected
    highConfidenceAccepted: 25, // >0.8 confidence accepted
  },
  adjustedThreshold: 0.72, // Updated based on feedback
};
```

---

## Validation Report

**Validated by**: Sarah (Product Owner)  
**Validation Date**: 2026-01-26  
**Validation Status**: ‚úÖ **APPROVED - Ready for Implementation**

### Validation Summary

**Template Compliance**: ‚úÖ All required sections present, no placeholders  
**File Structure**: ‚úÖ Clear file paths and source tree context  
**UI Completeness**: ‚úÖ Design specifications added (colors, responsive, accessibility)  
**AC Coverage**: ‚úÖ All 8 acceptance criteria covered by tasks  
**Security**: ‚úÖ Zod validation, rate limiting, Better Auth session, RLS checks, privacy/GDPR (ADR-010 compliant)  
**Task Sequence**: ‚úÖ Logical order with clear dependencies  
**Anti-Hallucination**: ‚úÖ All technical claims verified against codebase, integration points clarified  
**Implementation Readiness**: ‚úÖ Self-contained context, clear instructions, ADR references added

### Issues Resolved

**Should-Fix Issues (All Corrected)**:
1. ‚úÖ Privacy opt-in storage clarified (add `shareFeedbackForModelImprovement` field to `organizations` table)
2. ‚úÖ DetectionContext format clarified (only non-PII fields: amount, customerEmail, decision, riskScore)
3. ‚úÖ Zod validation schemas added for all API inputs (ADR-010)
4. ‚úÖ Rate limiting specified for all endpoints (ADR-010)
5. ‚úÖ Better Auth session verification and RLS checks added
6. ‚úÖ UI design specifications added (colors, responsive, accessibility)
7. ‚úÖ Detailed mock data structure provided for tests (ai_feedback, organizations, Trigger.dev job)
8. ‚úÖ ADR references added (ADR-003, ADR-006, ADR-010)
9. ‚úÖ Trigger.dev scheduled job pattern clarified (cron format, daily execution)

**Critical Issues**: None identified

### Final Assessment

- **Implementation Readiness Score**: 9.5/10
- **Confidence Level**: High
- **Recommendation**: Story is ready for development. All technical details are clear, security requirements are met, privacy/GDPR considerations are addressed, and test data structures are defined.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-26 | 1.0 | Story created | Sarah (PO) |
| 2026-01-26 | 1.1 | Should-fix corrections: Clarified detectionContext format, privacy opt-in storage, added Zod validation, rate limiting, UI design specs, detailed mock data structure, ADR references, Trigger.dev job pattern | Sarah (PO) |
| 2026-01-26 | 1.2 | Validation completed: Story approved and marked as Ready for implementation | Sarah (PO) |
| 2026-01-26 | 2.0 | Implementation: Tasks 1-7 completed, Task 8 (tests) pending | James (Dev) |

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (via Cursor)

### Debug Log References
N/A

### Completion Notes List
- ‚úÖ Created database schema `ai_feedback` in `packages/database/src/schema/ai-feedback.ts`
- ‚úÖ Added `shareFeedbackForModelImprovement` field to `organizations` table
- ‚úÖ Generated migration file: `packages/database/drizzle/0004_adorable_luke_cage.sql`
- ‚úÖ Updated suggestion accept/reject endpoints to track feedback (AC1, AC2, AC3)
- ‚úÖ Created feedback tracking helper with anonymization support (AC7)
- ‚úÖ Created feedback analyzer and A/B testing framework (AC4, AC5)
- ‚úÖ Created AI metrics API endpoint and UI component (AC6)
- ‚úÖ Created privacy settings API and UI component (AC7)
- ‚úÖ Created Trigger.dev scheduled job for daily feedback analysis (AC4, AC7)
- ‚ö†Ô∏è Note: Migration needs to be applied to database (run `drizzle-kit push` or apply migration)
- ‚ö†Ô∏è Note: Trigger.dev environment variables required (TRIGGER_SECRET_KEY, TRIGGER_PROJECT_ID)

### File List
**Created:**
- `packages/database/src/schema/ai-feedback.ts` - Database schema for AI feedback
- `apps/web/lib/ai/feedback-tracker.ts` - Feedback tracking helper
- `apps/web/lib/ai/feedback-anonymizer.ts` - PII anonymization for GDPR compliance
- `apps/web/lib/ai/feedback-analyzer.ts` - Feedback analysis and confidence threshold updates
- `apps/web/lib/ai/ab-testing.ts` - A/B testing framework
- `apps/web/lib/validation/ai-feedback.ts` - Zod validation schemas
- `apps/web/app/api/suggestions/[id]/feedback/route.ts` - POST explicit feedback endpoint
- `apps/web/app/api/organizations/[id]/ai-metrics/route.ts` - GET AI metrics endpoint
- `apps/web/app/api/organizations/[id]/privacy-settings/route.ts` - POST privacy settings endpoint
- `apps/web/components/ai-metrics-card.tsx` - UI component for AI metrics display
- `apps/web/components/privacy-settings-card.tsx` - UI component for privacy opt-in
- `apps/web/trigger/jobs/analyze-feedback.job.ts` - Trigger.dev scheduled job for daily analysis

**Modified:**
- `packages/database/src/schema/organizations.ts` - Added `shareFeedbackForModelImprovement` field
- `packages/database/src/schema/index.ts` - Added export for ai-feedback
- `apps/web/app/api/suggestions/[id]/accept/route.ts` - Added feedback tracking after accept
- `apps/web/app/api/suggestions/[id]/reject/route.ts` - Added feedback tracking after reject
- `apps/web/app/(authenticated)/settings/custom-rules/page.tsx` - Added AI metrics and privacy settings cards
- `apps/web/trigger/index.ts` - Added export for analyze-feedback job

---

## QA Results

(To be populated by QA agent after testing)
