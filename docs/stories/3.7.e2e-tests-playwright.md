# Story 3.7: E2E Tests Critical User Journeys (Playwright)

**Epic**: Epic 3 - Integration & Production Readiness  
**Story Points**: 5  
**Status**: Draft

---

## Story

**As a** development team,  
**I want** E2E tests covering critical user journeys,  
**so that** we catch UI/UX bugs before production.

---

## Acceptance Criteria

1. **AC1**: Playwright setup (@playwright/test, chromium + webkit)
2. **AC2**: E2E Test 1: Login → Dashboard happy path
3. **AC3**: E2E Test 2: Block customer flow
4. **AC4**: E2E Test 3: SSE real-time update
5. **AC5**: E2E Test 4: Mobile responsive (375px viewport)
6. **AC6**: E2E Test 5: Filters functionality
7. **AC7**: Screenshots on failure
8. **AC8**: CI/CD integration (run on Vercel preview)

---

## Tasks / Subtasks

- [ ] Install Playwright: `bun add -D @playwright/test`
- [ ] E2E Test: Login flow (Better Auth email/password)
- [ ] E2E Test: Dashboard loads, detection cards visible
- [ ] E2E Test: Click Block button → Confirm → Toast appears
- [ ] E2E Test: Trigger webhook → SSE updates feed
- [ ] E2E Test: Mobile viewport (375px), Sheet navigation works
- [ ] E2E Test: Apply filters → Feed updates
- [ ] Screenshots on failure (Playwright built-in)
- [ ] GitHub Actions: Run Playwright on Vercel preview deploy

---

## Dev Notes

**Playwright Config**:
```typescript
// playwright.config.ts
import { defineConfig } from '@playwright/test';

export default defineConfig({
  testDir: './e2e',
  use: {
    baseURL: process.env.BASE_URL || 'http://localhost:3000',
    screenshot: 'only-on-failure',
  },
  projects: [
    { name: 'chromium', use: { ...devices['Desktop Chrome'] } },
    { name: 'webkit', use: { ...devices['Desktop Safari'] } },
    { name: 'mobile', use: { ...devices['iPhone SE'] } },
  ],
});
```

**E2E Test Example**:
```typescript
// e2e/dashboard.spec.ts
import { test, expect } from '@playwright/test';

test('Login → Dashboard happy path', async ({ page }) => {
  // Login
  await page.goto('/login');
  await page.fill('input[name="email"]', 'test@example.com');
  await page.fill('input[name="password"]', 'password123');
  await page.click('button[type="submit"]');

  // Verify dashboard loads
  await expect(page).toHaveURL('/dashboard');
  await expect(page.locator('h1')).toContainText('Dashboard');

  // Verify detection cards visible
  const cards = page.locator('[data-testid="detection-card"]');
  await expect(cards).toHaveCount(5, { timeout: 10000 });
});

test('Block customer flow', async ({ page }) => {
  await page.goto('/dashboard');

  // Click Block button
  await page.click('[data-testid="block-button"]');

  // Confirm in AlertDialog
  await page.click('button:has-text("Confirm")');

  // Verify toast appears
  await expect(page.locator('.sonner-toast')).toContainText('Customer blocked');
});
```

**GitHub Actions**:
```yaml
# .github/workflows/e2e.yml
name: E2E Tests
on: [deployment_status]
jobs:
  e2e:
    if: github.event.deployment_status.state == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: oven-sh/setup-bun@v1
      - run: bun install
      - run: bunx playwright install --with-deps
      - run: BASE_URL=${{ github.event.deployment_status.target_url }} bun run test:e2e
```

---

## Testing

- All 5 E2E tests pass
- Tests run on Vercel preview deploys

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-13 | 1.0 | Story created | Sarah (PO) |
