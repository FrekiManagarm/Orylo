# Story 2.7: Block Customer Action

**Epic**: Epic 2 - Dashboard Action-First Experience  
**Story Points**: 5  
**Status**: Draft

---

## Story

**As a** merchant,  
**I want** to block a customer with one click,  
**so that** future transactions are auto-declined.

---

## Acceptance Criteria

1. **AC1**: Button: "Block" (Shadcn `Button`, variant destructive)
2. **AC2**: Confirmation: Shadcn `AlertDialog` - "Block this customer? Future transactions will be auto-declined."
3. **AC3**: API: `POST /api/customers/[id]/block` → Update `customer_trust_scores.isBlacklisted = true`
4. **AC4**: Optimistic UI: Button shows spinner, card grayed out immediately
5. **AC5**: Success feedback: Toast (Shadcn `Sonner`) "Customer blocked successfully"
6. **AC6**: Error handling: If API fails → Revert UI, show error toast
7. **AC7**: Badge update: Detection badge changes to "Blacklisted"
8. **AC8**: Cache invalidation: Clear Redis trust score cache
9. **AC9**: E2E test: Click block → Verify DB updated, toast displayed

---

## Tasks / Subtasks

- [ ] Create BlockCustomerButton component
- [ ] AlertDialog confirmation modal
- [ ] API endpoint: `POST /api/customers/[id]/block`
- [ ] Update DB: Set `isBlacklisted=true` in customer_trust_scores
- [ ] Optimistic UI update (immediate visual feedback)
- [ ] Success toast notification
- [ ] Error handling with UI rollback
- [ ] Invalidate Redis cache for trust score

---

## Dev Notes

**Shadcn Components**: Button (destructive), AlertDialog, Sonner (Toast)

**API Logic**:
```typescript
// POST /api/customers/[id]/block
await db.update(customerTrustScores)
  .set({ isBlacklisted: true, score: 0 })
  .where(eq(customerTrustScores.customerId, customerId));

// Invalidate Redis cache
await redis.del(`trust:${organizationId}:${customerId}`);
```

**Optimistic UI**:
```typescript
// Update UI immediately (before API response)
setIsBlocked(true);

try {
  await blockCustomer(customerId);
  toast.success('Customer blocked');
} catch (error) {
  setIsBlocked(false); // Rollback
  toast.error('Failed to block customer');
}
```

---

## Testing

- E2E: Block customer flow (Playwright)
- Integration: API updates DB + cache

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-13 | 1.0 | Story created | Sarah (PO) |
