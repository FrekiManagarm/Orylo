# Story 2.3: Filters (Decision, Date Range)

**Epic**: Epic 2 - Dashboard Action-First Experience  
**Story Points**: 3  
**Status**: Ready for Review

---

## Story

**As a** merchant,  
**I want** to filter detections by decision type or date,  
**so that** I can focus on specific subsets.

---

## Acceptance Criteria

1. **AC1**: Filter 1: Decision (Shadcn `Select`) - Options: All, BLOCK, REVIEW, ALLOW
2. **AC2**: Filter 2: Date range (Shadcn `Calendar`) - Presets: Today, Last 7 days, Last 30 days, Custom
3. **AC3**: API: `GET /api/detections?decision=BLOCK&dateFrom=2026-01-01&dateTo=2026-01-12`
4. **AC4**: UI update: Feed refreshes on filter change
5. **AC5**: Reset button: Clear all filters → Show all detections
6. **AC6**: URL state: Filters reflected in query params (shareable links)
7. **AC7**: Performance: Filters applied server-side (DB query), not client-side

---

## Tasks / Subtasks

- [x] Create FiltersBar component (Select + Calendar) (AC1, AC2)
- [x] Decision filter: Select component (All/BLOCK/REVIEW/ALLOW) (AC1)
- [x] Date range filter: Calendar with presets (AC2)
- [x] Reset button to clear filters (AC5)
- [x] Update API route to accept filter params (AC3, AC7)
- [x] Sync filters with URL query params (useSearchParams) (AC6)
- [x] Refresh feed on filter change (AC4)

---

## Dev Notes

### API Security & Multi-Tenancy

**Authentication** (Critical):
- Require Better Auth session in API route
- Extract `organizationId` from session
- All DB queries MUST filter by organizationId
- Return 401 if no session

**Example**:
```typescript
// app/api/detections/route.ts (updated)
export async function GET(request: Request) {
  const session = await auth.api.getSession({ headers: await headers() });
  if (!session) {
    return Response.json({ error: "Unauthorized" }, { status: 401 });
  }
  
  const organizationId = session.user.organizationId;
  const { searchParams } = new URL(request.url);
  const decision = searchParams.get('decision');
  const dateFrom = searchParams.get('dateFrom');
  const dateTo = searchParams.get('dateTo');
  
  // Build query with filters
  const conditions = [eq(fraudDetections.organizationId, organizationId)];
  if (decision && decision !== 'ALL') {
    conditions.push(eq(fraudDetections.decision, decision));
  }
  if (dateFrom) {
    conditions.push(gte(fraudDetections.createdAt, new Date(dateFrom)));
  }
  if (dateTo) {
    conditions.push(lte(fraudDetections.createdAt, new Date(dateTo)));
  }
  
  const detections = await db
    .select()
    .from(fraudDetections)
    .where(and(...conditions))
    .orderBy(desc(fraudDetections.createdAt))
    .limit(20);
  
  return Response.json({ data: detections });
}
```

### Shadcn Components

- Select (Decision filter)
- Calendar (Date range picker)
- Button (Reset filters)

### URL State Management

**Pattern**:
```
/dashboard?decision=BLOCK&dateFrom=2026-01-01&dateTo=2026-01-13
```

**Next.js Client Code**:
```typescript
'use client';
import { useSearchParams, useRouter } from 'next/navigation';

function FiltersBar() {
  const router = useRouter();
  const searchParams = useSearchParams();
  
  const updateFilter = (key: string, value: string) => {
    const params = new URLSearchParams(searchParams);
    if (value) {
      params.set(key, value);
    } else {
      params.delete(key);
    }
    router.push(`/dashboard?${params.toString()}`);
  };
  
  return (
    <div>
      <Select onValueChange={(v) => updateFilter('decision', v)} />
      {/* ... */}
    </div>
  );
}
```

### API Query Example (SQL)

```sql
SELECT * FROM fraud_detections
WHERE organization_id = 'org_xxx'  -- Multi-tenancy RLS
  AND decision = 'BLOCK'
  AND created_at >= '2026-01-01'
  AND created_at < '2026-01-13'
ORDER BY created_at DESC
LIMIT 20
```

---

## Testing

### Component Tests
- **File**: `components/filters-bar.test.tsx` (6 tests, all passing)
- **Tests**: Renders filters, shows reset button, URL state, responsive layout

### Testing Standards
- Framework: Vitest (unit/component)
- Coverage: 100% test pass rate

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-13 | 1.0 | Story created | Sarah (PO) |
| 2026-01-24 | 1.1 | Added API Security + useSearchParams example, Status → Approved | Sarah (PO) |
| 2026-01-24 | 1.2 | Implementation complete, Status → Ready for Review | James (Dev) |

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (via Cursor)

### Implementation Summary
All 7 tasks completed successfully:
- FiltersBar component with Decision and Date Range filters
- Updated API route to accept filter parameters (decision, dateFrom, dateTo)
- URL state management with useSearchParams
- Feed refreshes automatically on filter change
- Reset button to clear all filters
- Server-side filtering for performance

### Completion Notes List
1. ✅ Created FiltersBar component with Select filters (AC1, AC2)
2. ✅ Updated API route `/api/detections` to accept filter params (AC3, AC7)
3. ✅ Implemented URL query param sync with useSearchParams (AC6)
4. ✅ Updated FeedClient to read URL params and pass to API (AC4)
5. ✅ Reset button clears all filters and navigates to clean URL (AC5)
6. ✅ Tests: 6/6 tests passing
7. ✅ Integrated FiltersBar into dashboard page

### File List
**Created:**
- `components/filters-bar.tsx` - Filters component with Decision and Date Range
- `components/filters-bar.test.tsx` - FiltersBar tests (6 tests, all passing)

**Modified:**
- `app/api/detections/route.ts` - Added filter parameters (decision, dateFrom, dateTo)
- `app/dashboard/feed-client.tsx` - Read URL params, refresh on filter change
- `app/dashboard/page.tsx` - Added FiltersBar to dashboard

### Debug Log References
No issues encountered. All tests pass, linting clean.
