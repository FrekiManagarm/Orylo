# Story 3.4: Performance Optimization (NFR1 <350ms P95)

**Epic**: Epic 3 - Integration & Production Readiness  
**Story Points**: 5  
**Status**: Draft

---

## Story

**As a** system,  
**I want** optimized performance across all layers,  
**so that** detection latency meets <350ms P95 target.

---

## Acceptance Criteria

1. **AC1**: Database query optimization (indexes, select specific columns)
2. **AC2**: Redis caching strategy (trust scores TTL 1h, velocity TTL 5min)
3. **AC3**: Detector parallelization validation (each <100ms)
4. **AC4**: External API optimizations (self-hosted MaxMind GeoIP)
5. **AC5**: Bundle size optimization frontend (<500KB)
6. **AC6**: Image optimization (Next.js Image, WebP)
7. **AC7**: Performance testing (Lighthouse CI: Performance ≥80, TTI <2s)
8. **AC8**: Load testing webhooks (k6 or artillery: 10 req/s, P95 <350ms)
9. **AC9**: Monitoring performance in production (Vercel Analytics)

---

## Tasks / Subtasks

- [ ] Add DB indexes: organizationId, paymentIntentId, createdAt, decision
- [ ] Optimize queries: SELECT specific columns, avoid SELECT *
- [ ] Redis caching: trust scores (1h TTL), velocity (5min TTL)
- [ ] Validate detector parallelization (all run concurrently)
- [ ] MaxMind GeoIP self-hosted (no external API calls)
- [ ] Frontend bundle analysis: code splitting, lazy loading
- [ ] Next.js Image optimization (WebP format, lazy loading)
- [ ] Lighthouse CI setup (GitHub Actions)
- [ ] Load testing with k6: 10 req/s sustained, P95 <350ms
- [ ] Monitor P95 latency in Vercel Analytics

---

## Dev Notes

**Database Indexes**:
```sql
CREATE INDEX idx_fraud_detections_org_created 
  ON fraud_detections(organization_id, created_at DESC);
CREATE INDEX idx_fraud_detections_decision 
  ON fraud_detections(decision);
CREATE INDEX idx_customer_trust_scores_org_customer 
  ON customer_trust_scores(organization_id, customer_id);
```

**Query Optimization**:
```typescript
// ❌ Bad: SELECT *
const detections = await db.select().from(fraudDetections);

// ✅ Good: SELECT specific columns
const detections = await db.select({
  id: fraudDetections.id,
  decision: fraudDetections.decision,
  riskScore: fraudDetections.riskScore,
  createdAt: fraudDetections.createdAt,
}).from(fraudDetections);
```

**Load Testing (k6)**:
```javascript
// load-test.js
import http from 'k6/http';
import { check } from 'k6';

export let options = {
  stages: [
    { duration: '2m', target: 10 }, // Ramp up to 10 req/s
    { duration: '5m', target: 10 }, // Sustained 10 req/s
    { duration: '1m', target: 0 },  // Ramp down
  ],
  thresholds: {
    http_req_duration: ['p(95)<350'], // P95 <350ms
  },
};

export default function () {
  const res = http.post('https://orylo.com/api/webhooks/stripe', payload);
  check(res, { 'status is 200': (r) => r.status === 200 });
}
```

---

## Testing

- Lighthouse CI: Performance ≥80%, TTI <2s
- Load testing: k6 run load-test.js (P95 <350ms)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-13 | 1.0 | Story created | Sarah (PO) |
